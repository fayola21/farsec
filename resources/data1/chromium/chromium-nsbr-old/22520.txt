<title>Issue 22520 -   chromium -    Incorrect synchronization via boolean - Project Hosting on Google Code</title> <pre> Chrome Version       : r26XXX    In file chrome/browser/cancelable_request.h (   <a href="http://src.chromium.org/viewvc/chrome/trunk/src/chrome/browser/cancelable_r">http://src.chromium.org/viewvc/chrome/trunk/src/chrome/browser/cancelable_r</a>  equest.h?revision=26500 )   CancelableRequestBase::canceled_ is used to &quot;synchronize&quot;   CancelableRequestProvider::CancelRequestLocked() and CancelableRequest&lt;&gt;::   ForwardResult() without holding any lock in the latter.  Please see <a href="http://code.google.com/p/data-race-test/wiki/PopularDataRaces">http://code.google.com/p/data-race-test/wiki/PopularDataRaces</a>  for the details why this is incorrect.    This data race was detected by ThreadSanitizer (see  <a href="http://code.google.com/p/data-race-test/wiki/ThreadSanitizer">http://code.google.com/p/data-race-test/wiki/ThreadSanitizer</a>)  here is the   report:  INFO: T110 has been created by T0 at this point: {{{      #0  clone /lib/tls/i686/cmov/libc-2.7.so      #1  pthread_create@@GLIBC_2.1 /lib/tls/i686/cmov/libpthread-2.7.so      #2  pthread_create@* /home/chrome-bot/setup_tsan/valgrind-  10771/tsan/ts_valgrind_intercepts.c:556      #3  (anonymous namespace)::CreateThread(unsigned int  bool    PlatformThread::Delegate*  unsigned long*) base/platform_thread_posix.cc:93      #4  PlatformThread::Create(unsigned int  PlatformThread::Delegate*    unsigned long*) base/platform_thread_posix.cc:105      #5  base::Thread::StartWithOptions(base::Thread::Options const&amp;)   base/thread.cc:85      #6  base::Thread::Start() base/thread.cc:74      #7  HistoryService::Init(FilePath const&amp;  BookmarkService*)   chrome/browser/history/history.cc:152      #8  history::HistoryTest_Thumbnails_Test::TestBody()   chrome/browser/history/history_unittest.cc:662      #9  testing::Test::Run() testing/gtest/src/gtest.cc:2056  }}}  WARNING: Possible data race during write of size 1 at 0x7E033D8: {{{     T0 (locks held: {L2096}):      #0  CancelableRequestBase::set_canceled()   chrome/browser/cancelable_request.h:386      #1  CancelableRequestProvider::CancelRequestLocked(int)   chrome/browser/cancelable_request.cc:52      #2  CancelableRequestProvider::CancelRequest(int)   chrome/browser/cancelable_request.cc:41      #3  history::HistoryTest_Thumbnails_Test::TestBody()   chrome/browser/history/history_unittest.cc:705      #4  testing::Test::Run() testing/gtest/src/gtest.cc:2056    Concurrent read(s) happened at (OR AFTER) these points:     T110 (locks held: {}):      #0  CancelableRequestBase::canceled()   chrome/browser/cancelable_request.h:388      #1  CancelableRequest&lt;CallbackRunner&lt;Tuple2&lt;int    scoped_refptr&lt;RefCountedVector&lt;unsigned char&gt; &gt; &gt; &gt;   &gt;::ForwardResult(Tuple2&lt;int  scoped_refptr&lt;RefCountedVector&lt;unsigned char&gt;   &gt; &gt; const&amp;) chrome/browser/cancelable_request.h:486      #2    history::HistoryBackend::GetPageThumbnail(scoped_refptr&lt;CancelableRequest&lt;C  allbackRunner&lt;Tuple2&lt;int  scoped_refptr&lt;RefCountedVector&lt;unsigned char&gt; &gt; &gt;   &gt; &gt; &gt;  GURL const&amp;) chrome/browser/history/history_backend.cc:1323      #3  void DispatchToMethod&lt;history::HistoryBackend  void   (history::HistoryBackend::*)(scoped_refptr&lt;CancelableRequest&lt;CallbackRunner  &lt;Tuple2&lt;int  scoped_refptr&lt;RefCountedVector&lt;unsigned char&gt; &gt; &gt; &gt; &gt; &gt;  GURL   const&amp;)  scoped_refptr&lt;CancelableRequest&lt;CallbackRunner&lt;Tuple2&lt;int    scoped_refptr&lt;RefCountedVector&lt;unsigned char&gt; &gt; &gt; &gt; &gt; &gt;    GURL&gt;(history::HistoryBackend*  void   (history::HistoryBackend::*)(scoped_refptr&lt;CancelableRequest&lt;CallbackRunner  &lt;Tuple2&lt;int  scoped_refptr&lt;RefCountedVector&lt;unsigned char&gt; &gt; &gt; &gt; &gt; &gt;  GURL   const&amp;)  Tuple2&lt;scoped_refptr&lt;CancelableRequest&lt;CallbackRunner&lt;Tuple2&lt;int    scoped_refptr&lt;RefCountedVector&lt;unsigned char&gt; &gt; &gt; &gt; &gt; &gt;  GURL&gt; const&amp;)   base/tuple.h:429      #4  RunnableMethod&lt;history::HistoryBackend  void   (history::HistoryBackend::*)(scoped_refptr&lt;CancelableRequest&lt;CallbackRunner  &lt;Tuple2&lt;int  scoped_refptr&lt;RefCountedVector&lt;unsigned char&gt; &gt; &gt; &gt; &gt; &gt;  GURL   const&amp;)  Tuple2&lt;scoped_refptr&lt;CancelableRequest&lt;CallbackRunner&lt;Tuple2&lt;int    scoped_refptr&lt;RefCountedVector&lt;unsigned char&gt; &gt; &gt; &gt; &gt; &gt;  GURL&gt; &gt;::Run()   base/task.h:307      #5  MessageLoop::RunTask(Task*) base/message_loop.cc:314      #6  MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;)   base/message_loop.cc:322      #7  MessageLoop::DoWork() base/message_loop.cc:429      #8  base::MessagePumpDefault::Run(base::MessagePump::Delegate*)   base/message_pump_default.cc:23      #9  MessageLoop::RunInternal() base/message_loop.cc:199    Location 0x7E033D8 is 24 bytes inside a block starting at 0x7E033C0 of   size 32 allocated by T0 from heap:      #0  malloc /home/chrome-bot/setup_tsan/valgrind-  10771/tsan/ts_valgrind_intercepts.c:318      #1  operator new(unsigned int) /usr/lib/libstdc++.so.6.0.9      #2  HistoryService::GetPageThumbnail(GURL const&amp;    CancelableRequestConsumerBase*  CallbackRunner&lt;Tuple2&lt;int    scoped_refptr&lt;RefCountedVector&lt;unsigned char&gt; &gt; &gt; &gt;*)   chrome/browser/history/history.cc:404      #3  history::HistoryTest_Thumbnails_Test::TestBody()   chrome/browser/history/history_unittest.cc:702      #4  testing::Test::Run() testing/gtest/src/gtest.cc:2056    Locks involved in this report (reporting last lock sites): {L2096}     L2096      #0  pthread_mutex_lock /home/chrome-bot/setup_tsan/valgrind-  10771/tsan/ts_valgrind_intercepts.c:751      #1  LockImpl::Lock() base/lock_impl_posix.cc:41      #2  Lock::Acquire() base/lock.h:16      #3  AutoLock::AutoLock(Lock&amp;) base/lock.h:43      #4  CancelableRequestProvider::CancelRequest(int)   chrome/browser/cancelable_request.cc:40      #5  history::HistoryTest_Thumbnails_Test::TestBody()   chrome/browser/history/history_unittest.cc:705      #6  testing::Test::Run() testing/gtest/src/gtest.cc:2056  }}} </pre>