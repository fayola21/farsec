<title>Issue 11180 -   chromium -    DCHECK during browser shutdown - Project Hosting on Google Code</title> <pre> During browser shutdown I hit a DCHECK acquiring a lock recursively.  Stack is at bottom of this comment.    Looks like the code added in <a href="http://src.chromium.org/viewvc/chrome?view=rev&amp;revision=9161">http://src.chromium.org/viewvc/chrome?view=rev&amp;revision=9161</a> can call Singleton::get() during   exit  which is bad because it can try to create a singleton and register it for being called AtExit (since we're already in   exit  this DCHECKs).    CCing cpu  Mr. AtExitManager  since he is more likely to know what a good solution is for this pattern than am I.    Stack trace:     	chrome.dll!DebugUtil::BreakDebugger()  Line 251	C++   	chrome.dll!logging::LogMessage::~LogMessage()  Line 545	C++   	chrome.dll!LockImpl::Lock()  Line 56	C++   	chrome.dll!Lock::Acquire()  Line 16 + 0x16 bytes	C++   	chrome.dll!AutoLock::AutoLock(Lock &amp; lock={...})  Line 44	C++   	chrome.dll!base::AtExitManager::RegisterCallback(void (void *)* func=0x02f3e280  void * param=0x00000000)  Line 47	  C++   	chrome.dll!Singleton&lt;std::map&lt;HWND__ * tracked_objects::Location std::less&lt;HWND__ *&gt; std::allocator&lt;std::pair&lt;HWND__ *   const tracked_objects::Location&gt; &gt; &gt; win_util::HWNDDeathMapTrait std::map&lt;HWND__ * tracked_objects::Location std::less&lt;HWND__   *&gt; std::allocator&lt;std::pair&lt;HWND__ * const tracked_objects::Location&gt; &gt; &gt; &gt;::get()  Line 134 + 0xc bytes	C++  &gt;	chrome.dll!win_util::NotifyHWNDDestruction(const tracked_objects::Location &amp; from_here={...}  HWND__ * hwnd=0x00010b5c)    Line 410 + 0x5 bytes	C++   	chrome.dll!views::NativeControlWin::NativeControlWndProc(HWND__ * window=0x00010b5c  unsigned int message=2  unsigned   int w_param=0  long l_param=0)  Line 194 + 0x24 bytes	C++   	user32.dll!_InternalCallWinProc@20()  + 0x28 bytes	   	user32.dll!_UserCallWinProcCheckWow@32()  + 0xb7 bytes	   	user32.dll!_DispatchClientMessage@20()  + 0x4d bytes	   	user32.dll!___fnDWORD@4()  + 0x24 bytes	   	ntdll.dll!_KiUserCallbackDispatcher@12()  + 0x13 bytes	   	user32.dll!_NtUserDestroyWindow@4()  + 0xc bytes	   	chrome.dll!views::NativeButtonWin::~NativeButtonWin()  Line 28 + 0x8 bytes	C++   	chrome.dll!views::NativeButtonWin::`scalar deleting destructor'()  + 0x16 bytes	C++   	chrome.dll!views::View::~View()  Line 100 + 0x31 bytes	C++   	chrome.dll!views::Button::~Button()  Line 13 + 0x32 bytes	C++   	chrome.dll!views::NativeButton::~NativeButton()  Line 46 + 0x32 bytes	C++   	chrome.dll!views::NativeButton::`scalar deleting destructor'()  + 0x16 bytes	C++   	chrome.dll!scoped_ptr&lt;views::NativeButton&gt;::~scoped_ptr&lt;views::NativeButton&gt;()  Line 72 + 0x25 bytes	C++   	chrome.dll!TaskManagerContents::~TaskManagerContents()  Line 743 + 0x2a bytes	C++   	chrome.dll!TaskManagerContents::`scalar deleting destructor'()  + 0x16 bytes	C++   	chrome.dll!scoped_ptr&lt;TaskManagerContents&gt;::~scoped_ptr&lt;TaskManagerContents&gt;()  Line 72 + 0x25 bytes	C++   	chrome.dll!TaskManager::~TaskManager()  Line 975 + 0xb bytes	C++   	chrome.dll!TaskManager::`scalar deleting destructor'()  + 0x16 bytes	C++   	chrome.dll!DefaultSingletonTraits&lt;TaskManager&gt;::Delete(TaskManager * x=0x0641f240)  Line 26 + 0x22 bytes	C++   	chrome.dll!Singleton&lt;TaskManager DefaultSingletonTraits&lt;TaskManager&gt; TaskManager&gt;::OnExit(void * unused=0x00000000)    Line 172 + 0x15 bytes	C++   	chrome.dll!base::AtExitManager::ProcessCallbacksNow()  Line 63 + 0x9 bytes	C++   	chrome.dll!base::AtExitManager::~AtExitManager()  Line 34	C++   	chrome.dll!ChromeMain(HINSTANCE__ * instance=0x00400000  sandbox::SandboxInterfaceInfo * sandbox_info=0x0012fe80    wchar_t * command_line=0x00020a50)  Line 472 + 0x35 bytes	C++   	chrome.exe!wWinMain(HINSTANCE__ * instance=0x00400000  HINSTANCE__ * prev_instance=0x00000000  wchar_t *   command_line=0x00020a50  int __formal=10)  Line 102 + 0x12 bytes	C++   	chrome.exe!__tmainCRTStartup()  Line 324 + 0x35 bytes	C   	chrome.exe!wWinMainCRTStartup()  Line 196	C   	kernel32.dll!_BaseProcessStart@4()  + 0x23 bytes	   </pre>