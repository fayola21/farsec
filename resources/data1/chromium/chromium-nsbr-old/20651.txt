<title>Issue 20651 -   chromium -    Use-after-free in NPAPI::PluginInstance::NPP_DestroyStream() (free was in NPAPI::PluginInstance::RemoveStream()) - Project Hosting on Google Code</title> <pre> Seen on the linux valgrind layout bot today:    <a href="http://build.chromium.org/buildbot/waterfall/builders/Webkit%20Linux%20(valgrind%20layout)/builds/1496/steps/valgrind%20test:%20layout/logs/stdio">http://build.chromium.org/buildbot/waterfall/builders/Webkit%20Linux%20(valgrind%20layout)/builds/1496/steps/valgrind%20test:%20layout/logs/stdio</a>    This run included LayoutTests/plugins/destroy-stream-twice.html  which sounds pretty suggestive    Invalid read of size 4    NPAPI::PluginInstance::NPP_DestroyStream(_NPStream*  short)  (webkit/glue/plugins/plugin_instance.cc:239)    NPN_DestroyStream (webkit/glue/plugins/plugin_host.cc:557)    pluginInvoke(NPObject*  void*  _NPVariant const*  unsigned int   _NPVariant*) (webkit/tools/npapi_layout_test_plugin/PluginObject.cpp:410)    npObjectInvokeImpl(v8::Arguments const&amp;  InvokeFunctionType)  (third_party/WebKit/WebCore/bindings/v8/V8NPObject.cpp:101)    npObjectMethodHandler(v8::Arguments const&amp;)  (third_party/WebKit/WebCore/bindings/v8/V8NPObject.cpp:129)    v8::internal::Builtin_HandleApiCall(int  v8::internal::Object**)  (v8/src/builtins.cc:395)  Suppression:    fun:_ZN5NPAPI14PluginInstance17NPP_DestroyStreamEP9_NPStreams    fun:NPN_DestroyStream    fun:_Z12pluginInvokeP8NPObjectPvPK10_NPVariantjPS2_    fun:_Z18npObjectInvokeImplRKN2v89ArgumentsE18InvokeFunctionType    fun:_Z21npObjectMethodHandlerRKN2v89ArgumentsE    fun:_ZN2v88internal21Builtin_HandleApiCallEiPPNS0_6ObjectE  Address 0x5137acc is 12 bytes inside a block of size 172 free'd    operator delete(void*)  (ome/chrome-bot/valgrind-20090715/coregrind/m_replacemalloc/vg_replace_malloc.c:345)    NPAPI::PluginStreamUrl::~PluginStreamUrl()  (webkit/glue/plugins/plugin_stream_url.cc:29)    std::vector&lt;scoped_refptr&lt;NPAPI::PluginStream&gt;   std::allocator&lt;scoped_refptr&lt;NPAPI::PluginStream&gt; &gt;  &gt;::erase(__gnu_cxx::__normal_iterator&lt;scoped_refptr&lt;NPAPI::PluginStream&gt;*   std::vector&lt;scoped_refptr&lt;NPAPI::PluginStream&gt;   std::allocator&lt;scoped_refptr&lt;NPAPI::PluginStream&gt; &gt; &gt; &gt;)  (base/ref_counted.h:80)    NPAPI::PluginInstance::RemoveStream(NPAPI::PluginStream*)  (webkit/glue/plugins/plugin_instance.cc:92)    NPAPI::PluginStreamUrl::Close(short)  (webkit/glue/plugins/plugin_stream_url.cc:34)    NPAPI::PluginStreamUrl::DidFinishLoading()  (webkit/glue/plugins/plugin_stream_url.cc:76)    WebPluginImpl::didFinishLoading(WebKit::WebURLLoader*)  (webkit/glue/webplugin_impl.cc:779) </pre>