<title>Issue 9528 -   chromium -    Invalid write in WebCore::HTMLCanvasElement::setObserver in LayoutTests/fast/canvas/canvas-as-image.html - Project Hosting on Google Code</title> <pre> Valgrinding LayoutTests/fast/canvas/canvas-as-image.html  on release or debug found an invalid write eror.  The command I used was   echo LayoutTests/fast/canvas/canvas-as-image.html &gt; bad.txt   sh tools/valgrind/chrome_tests.sh -t layout -n 1 bad.txt  (This requires a cl I hope to commit today.)    Backtrace:    10:56:50 valgrind_analyze.py [ERROR] InvalidWrite  Invalid write of size 4    WebCore::HTMLCanvasElement::setObserver(WebCore::CanvasObserver*)  (WebKit/WebCore/html/HTMLCanvasElement.h:107)    WebCore::CSSCanvasValue::~CSSCanvasValue()  (WebKit/WebCore/css/CSSCanvasValue.cpp:37)    WTF::RefCounted&lt;WebCore::CSSValue&gt;::deref()  (WebKit/JavaScriptCore/wtf/RefCounted.h:94)    WTF::RefPtr&lt;WebCore::CSSValue&gt;::~RefPtr() (WebKit/JavaScriptCore/wtf/RefPtr.h:50)    WTF::VectorDestructor&lt;true  WTF::RefPtr&lt;WebCore::CSSValue&gt;  &gt;::destruct(WTF::RefPtr&lt;WebCore::CSSValue&gt;*  WTF::RefPtr&lt;WebCore::CSSValue&gt;*)  (WebKit/JavaScriptCore/wtf/Vector.h:80)    WTF::VectorTypeOperations&lt;WTF::RefPtr&lt;WebCore::CSSValue&gt;  &gt;::destruct(WTF::RefPtr&lt;WebCore::CSSValue&gt;*  WTF::RefPtr&lt;WebCore::CSSValue&gt;*)  (WebKit/JavaScriptCore/wtf/Vector.h:235)    WTF::Vector&lt;WTF::RefPtr&lt;WebCore::CSSValue&gt;  0u&gt;::shrink(unsigned int)  (WebKit/JavaScriptCore/wtf/Vector.h:713)    WTF::Vector&lt;WTF::RefPtr&lt;WebCore::CSSValue&gt;  0u&gt;::~Vector()  (WebKit/JavaScriptCore/wtf/Vector.h:462)    WebCore::CSSValueList::~CSSValueList() (WebKit/WebCore/css/CSSValueList.cpp:49)    WTF::RefCounted&lt;WebCore::CSSValue&gt;::deref()  (WebKit/JavaScriptCore/wtf/RefCounted.h:94)    WTF::RefPtr&lt;WebCore::CSSValue&gt;::~RefPtr() (WebKit/JavaScriptCore/wtf/RefPtr.h:50)    WebCore::CSSProperty::~CSSProperty() (WebKit/WebCore/css/CSSProperty.h:32)    WTF::VectorDestructor&lt;true  WebCore::CSSProperty&gt;::destruct(WebCore::CSSProperty*   WebCore::CSSProperty*) (WebKit/JavaScriptCore/wtf/Vector.h:80)    WTF::VectorTypeOperations&lt;WebCore::CSSProperty&gt;::destruct(WebCore::CSSProperty*   WebCore::CSSProperty*) (WebKit/JavaScriptCore/wtf/Vector.h:235)    WTF::Vector&lt;WebCore::CSSProperty  4u&gt;::shrink(unsigned int)  (WebKit/JavaScriptCore/wtf/Vector.h:713)    WTF::Vector&lt;WebCore::CSSProperty  4u&gt;::~Vector()  (WebKit/JavaScriptCore/wtf/Vector.h:462)    WebCore::CSSMutableStyleDeclaration::~CSSMutableStyleDeclaration()  (WebKit/WebCore/css/CSSMutableStyleDeclaration.h:58)    WTF::RefCounted&lt;WebCore::StyleBase&gt;::deref()  (WebKit/JavaScriptCore/wtf/RefCounted.h:94)    WTF::RefPtr&lt;WebCore::CSSMutableStyleDeclaration&gt;::~RefPtr()  (WebKit/JavaScriptCore/wtf/RefPtr.h:50)    WebCore::CSSStyleRule::~CSSStyleRule() (WebKit/WebCore/css/CSSStyleRule.cpp:39)    WTF::RefCounted&lt;WebCore::StyleBase&gt;::deref()  (WebKit/JavaScriptCore/wtf/RefCounted.h:94)    WTF::RefPtr&lt;WebCore::StyleBase&gt;::~RefPtr() (WebKit/JavaScriptCore/wtf/RefPtr.h:50)    WTF::VectorDestructor&lt;true  WTF::RefPtr&lt;WebCore::StyleBase&gt;  &gt;::destruct(WTF::RefPtr&lt;WebCore::StyleBase&gt;*  WTF::RefPtr&lt;WebCore::StyleBase&gt;*)  (WebKit/JavaScriptCore/wtf/Vector.h:80)    WTF::VectorTypeOperations&lt;WTF::RefPtr&lt;WebCore::StyleBase&gt;  &gt;::destruct(WTF::RefPtr&lt;WebCore::StyleBase&gt;*  WTF::RefPtr&lt;WebCore::StyleBase&gt;*)  (WebKit/JavaScriptCore/wtf/Vector.h:235)    WTF::Vector&lt;WTF::RefPtr&lt;WebCore::StyleBase&gt;  0u&gt;::shrink(unsigned int)  (WebKit/JavaScriptCore/wtf/Vector.h:713)    WTF::Vector&lt;WTF::RefPtr&lt;WebCore::StyleBase&gt;  0u&gt;::~Vector()  (WebKit/JavaScriptCore/wtf/Vector.h:462)    WebCore::StyleList::~StyleList() (WebKit/WebCore/css/StyleList.h:33)    WebCore::StyleSheet::~StyleSheet() (WebKit/WebCore/css/StyleSheet.cpp:58)    WebCore::CSSStyleSheet::~CSSStyleSheet() (WebKit/WebCore/css/CSSStyleSheet.cpp:70)    WTF::RefCounted&lt;WebCore::StyleBase&gt;::deref()  (WebKit/JavaScriptCore/wtf/RefCounted.h:94)  Address 0x121d98a4 is 76 bytes inside a block of size 108 free'd    operator delete(void*) (valgrind/trunk/coregrind/m_replacemalloc/vg_replace_malloc.c:362)    WebCore::HTMLCanvasElement::~HTMLCanvasElement()  (WebKit/WebCore/html/HTMLCanvasElement.cpp:74)    WebCore::TreeShared&lt;WebCore::Node&gt;::removedLastRef()  (WebKit/WebCore/platform/TreeShared.h:99)    WebCore::TreeShared&lt;WebCore::Node&gt;::deref()  (WebKit/WebCore/platform/TreeShared.h:69)    WTF::RefPtr&lt;WebCore::HTMLCanvasElement&gt;::~RefPtr()  (WebKit/JavaScriptCore/wtf/RefPtr.h:50)    std::pair&lt;WebCore::String  WTF::RefPtr&lt;WebCore::HTMLCanvasElement&gt; &gt;::~pair()  (nclude/c++/4.2/bits/stl_pair.h:69)    WTF::HashTable&lt;WebCore::String  std::pair&lt;WebCore::String   WTF::RefPtr&lt;WebCore::HTMLCanvasElement&gt; &gt;   WTF::PairFirstExtractor&lt;std::pair&lt;WebCore::String   WTF::RefPtr&lt;WebCore::HTMLCanvasElement&gt; &gt; &gt;  WebCore::StringHash   WTF::PairHashTraits&lt;WTF::HashTraits&lt;WebCore::String&gt;   WTF::HashTraits&lt;WTF::RefPtr&lt;WebCore::HTMLCanvasElement&gt; &gt; &gt;   WTF::HashTraits&lt;WebCore::String&gt; &gt;::deallocateTable(std::pair&lt;WebCore::String   WTF::RefPtr&lt;WebCore::HTMLCanvasElement&gt; &gt;*  int)  (WebKit/JavaScriptCore/wtf/HashTable.h:872)    WTF::HashTable&lt;WebCore::String  std::pair&lt;WebCore::String   WTF::RefPtr&lt;WebCore::HTMLCanvasElement&gt; &gt;   WTF::PairFirstExtractor&lt;std::pair&lt;WebCore::String   WTF::RefPtr&lt;WebCore::HTMLCanvasElement&gt; &gt; &gt;  WebCore::StringHash   WTF::PairHashTraits&lt;WTF::HashTraits&lt;WebCore::String&gt;   WTF::HashTraits&lt;WTF::RefPtr&lt;WebCore::HTMLCanvasElement&gt; &gt; &gt;   WTF::HashTraits&lt;WebCore::String&gt; &gt;::clear() (WebKit/JavaScriptCore/wtf/HashTable.h:924)    WTF::HashMap&lt;WebCore::String  WTF::RefPtr&lt;WebCore::HTMLCanvasElement&gt;   WebCore::StringHash  WTF::HashTraits&lt;WebCore::String&gt;   WTF::HashTraits&lt;WTF::RefPtr&lt;WebCore::HTMLCanvasElement&gt; &gt; &gt;::clear()  (WebKit/JavaScriptCore/wtf/HashMap.h:231)    WebCore::Document::removedLastRef() (WebKit/WebCore/dom/Document.cpp:424)    WebCore::TreeShared&lt;WebCore::Node&gt;::deref()  (WebKit/WebCore/platform/TreeShared.h:69)    WebCore::WeakNodeCallback(v8::Persistent&lt;v8::Value&gt;  void*)  (webkit/port/bindings/v8/v8_proxy.cpp:710)    v8::internal::GlobalHandles::Node::PostGarbageCollectionProcessing() (v8/src/global-    v8::internal::GlobalHandles::PostGarbageCollectionProcessing() (v8/src/global-    v8::internal::Heap::PostGarbageCollectionProcessing() (v8/src/heap.cc:429)    v8::internal::Heap::PerformGarbageCollection(v8::internal::AllocationSpace   v8::internal::GarbageCollector  v8::internal::GCTracer*) (v8/src/heap.cc:412)    v8::internal::Heap::CollectGarbage(int  v8::internal::AllocationSpace) (v8/src/heap.cc:342)    v8::internal::GCExtension::GC(v8::Arguments const&amp;) (v8/src/execution.cc:629)    v8::internal::Builtin_HandleApiCall(int  v8::internal::Object**) (v8/src/builtins.cc:380)    0x12CCC14A ()    0x12CDF074 ()    0x12CCCBF8 ()    0x12CCC673 ()    v8::internal::Invoke(bool  v8::internal::Handle&lt;v8::internal::JSFunction&gt;   v8::internal::Handle&lt;v8::internal::Object&gt;  int  v8::internal::Object***  bool*)  (v8/src/execution.cc:89)    v8::internal::Execution::Call(v8::internal::Handle&lt;v8::internal::JSFunction&gt;   v8::internal::Handle&lt;v8::internal::Object&gt;  int  v8::internal::Object***  bool*)  (v8/src/execution.cc:116)    v8::Script::Run() (v8/src/api.cc:1048)    WebCore::V8Proxy::RunScript(v8::Handle&lt;v8::Script&gt;  bool)  (webkit/port/bindings/v8/v8_proxy.cpp:1539)    WebCore::V8Proxy::evaluate(WebCore::ScriptSourceCode const&amp;  WebCore::Node*)  (webkit/port/bindings/v8/v8_proxy.cpp:1493)    WebCore::ScriptController::collectGarbage()  (webkit/port/bindings/v8/ScriptController.cpp:289)    WebFrameImpl::CallJSGC() (webkit/glue/webframe_impl.cc:854)   </pre>