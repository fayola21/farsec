<title>Issue 5933 -   chromium -    test_shell_tests aborts due to double free on linux with hammer SHARED=1 - Project Hosting on Google Code</title> <pre>   glibc is picking up a double free when running test_shell_tests on linux  for rev 7526 of trunk. This is only happening when compiled with SHARED=1.    Here's the tail end of the output ...     7 FAILED TESTS  Leak 1 JS wrappers.  *** glibc detected *** Hammer/test_shell_tests: double free or corruption  (!prev): 0x09129678 ***  ======= Backtrace: =========  /lib/libc.so.6[0xc41874]  /lib/libc.so.6(cfree+0x96)[0xc438d6]  Hammer/test_shell_tests(_ZN2v88internal8Malloced6DeleteEPv+0x11)[0x8147b95]  Hammer/test_shell_tests(_ZN2v88internal4ListIiNS0_25FreeStoreAllocationPolicyEED1Ev+0x25)[0x816f44d]  /lib/libc.so.6(__cxa_finalize+0xc1)[0xc01e91]  /home/craig/chromium/src/webkit/Hammer/dbg/lib/libtest_shell.so[0x2966b44]  /home/craig/chromium/src/webkit/Hammer/dbg/lib/libtest_shell.so[0x2b20fc0]  /lib/ld-linux.so.2[0xdb1f7b]  /lib/libc.so.6(exit+0x89)[0xc01b39]  /lib/libc.so.6(__libc_start_main+0xee)[0xbea5de]  Hammer/test_shell_tests(_ZNSsD1Ev+0x65)[0x8104341]  ======= Memory map: ========  [snip]    What seems to be happening is that when libtest_shell.so is unloaded  __cxa_finalize and exit both seem to be trying to free some v8 data.    The actual problem appears to be that libtest_shell.so is linked against v8  which is unnecessary. Only test_shell_tests should be linked to v8.    I'm attaching an ugly patch that does this but there is probably a nice way  of doing this and I'm unsure of the implications for other platforms.    Perhaps this can be assigned to evmar or sgk to fix properly please? </pre>