<title>Issue 21102 -   chromium -    Abnormal shutdown just after enabling Bookmark Sync results in weird account state - Project Hosting on Google Code</title> <pre> I've been seeing this as a side effect of the shutdown hang  <a title="&quot;Stop Syncing&quot; hangs with latest pre-release binary" class=closed_ref href="/p/chromium/issues/detail?id=21094"> bug 21094 </a>.    Basically  the problem is that we get into a state where the &quot;sync&quot; prefs   are unset  but the &quot;Sync Data&quot; directory contains cached credentials and   possibly a valid syncable object database.  When you select &quot;Sync My   Bookmarks&quot;  rather than offering a login prompt for a new user  the sync   engine proceeds with login of the last known user.  The result is a DCHECK   in the model associator  and general badness.    Here's the real repro case  and a synthetic one.    Synthetic Approach:  1. Enable sync for an account.  2. Terminate the browser normally.  3. Edit the Preferences file in the user data directory  and remove the   contents of the &quot;sync&quot; section.  4. Restart the browser.  Due to the prefs change  the ProfileSyncService   will not try to start the sync backend.  5. Select &quot;Sync my bookmarks&quot; from the wrench menu.    Expected behavior: A login dialog appears.  Actual behavior: Sync logs in using the stored credentials.    Actual repro approach (might be hard to replicate):  1. Same as above  but instead of terminating normally and editing the   preferences file  terminate abnormally so that preferences aren't saved    maybe by killing the browser via a debugger.  In my case  abnormal   termination happened because of a crash bug.      *** Suggested Fix ***  I'm pretty sure this bug is because we used to blow away the &quot;Sync Data&quot;   dir with each startup  but this has apparently disappeared.  We need to do   this  in the SyncBackendHost.  So when the   ProfileSyncService::EnableForUser() happens  before we SBH::Initialize() is   scheduled  we should schedule the SBH to blow away the sync data folder.    We should probably do something similar in DisableForUser(). </pre>