<title>Issue 21050 -   chromium -    Infinite auth restart loop if HttpAuthHandler::GenerateCredentials fails (returns an empty string). - Project Hosting on Google Code</title> <pre> In HttpNetworkTransaction::BuildAuthorizationHeader  we  call auth_handler_[target]-&gt;GenerateCredentials() to generate  the credentials for the authorization header:      // Add a Authorization/Proxy-Authorization header line.    std::string credentials = auth_handler_[target]-&gt;GenerateCredentials(        auth_identity_[target].username         auth_identity_[target].password         request_         &amp;proxy_info_);      return HttpAuth::GetAuthorizationHeaderName(target) +        &quot;: &quot;  + credentials + &quot;rn&quot;;    If auth_handler_[target]-&gt;GenerateCredentials() fails and returns  an empty string for some reason  we get into an infinite auth  restart loop because we will sent a &quot;Authorization: &quot; header  to the server  and the server will respond with a 401  and the  process repeats.    A band-aid fix is to impose a limit on the maximum number  of auth restarts an HttpNetworkTransaction object can do.  I think we should do this anyway to limit the damage of any  problems that may cause an infinite auth restart loop.    A fix for this particular problem is to make BuildAuthorizationHeader  return a bool to indicate success/failure  and if it fails   HttpNetworkTransaction::DoWriteHeaders should fail and not go  on to STATE_WRITE_HEADERS_COMPLETE.  This quick-and-dirty patch  for http_network_transaction.cc illustrates this solution:    Index: http_network_transaction.cc  ===================================================================  --- http_network_transaction.cc (<a href="/p/chromium/source/detail?r=24904">revision 24904</a>)  +++ http_network_transaction.cc (working copy)  @@ -744 9 +747 12 @@       if (have_proxy_auth)         authorization_headers.append(             BuildAuthorizationHeader(HttpAuth::AUTH_PROXY));  -    if (have_server_auth)  +    if (have_server_auth) {         authorization_headers.append(             BuildAuthorizationHeader(HttpAuth::AUTH_SERVER));  +      if (authorization_headers == &quot;Authorization: rn&quot;)  +        return ERR_UNEXPECTED;  // TODO(wtc): use a better error code.  +    }         if (establishing_tunnel_) {         BuildTunnelRequest(request_  authorization_headers  </pre>