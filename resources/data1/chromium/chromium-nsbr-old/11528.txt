<title>Issue 11528 -   chromium -    Data race between WorkQueue::WorkIsCompleted and WorkQueue::GetNumberOfCompletedTasks in ConditionVariableTest.LargeFastTaskTest - Project Hosting on Google Code</title> <pre> Chrome Version       :  2.0.178.0 (Developer Build 15292)    Reproduce:   1. Install ThreadSanitizer:  <a href="http://code.google.com/p/data-race-test/wiki/ThreadSanitizer">http://code.google.com/p/data-race-test/wiki/ThreadSanitizer</a>    2. Run base unittests under ThreadSanitizer:  tsan --announce-threads --pure-happens-before=yes --error-exitcode=1  ./base_unittests --gtest_filter=ConditionVariableTest.LargeFastTaskTest     ==10664== WARNING: Possible data race during read of size 4 at 0x8D8F464: {{{  ==10664==    T0 (locks held: {L251}):  ==10664==     #0  (anonymous  namespace)::WorkQueue::GetNumberOfCompletedTasks() const  /usr/local/google/glider-chromium/src/base/condition_variable_unittest.cc:647  ==10664==     #1  (anonymous  namespace)::ConditionVariableTest_LargeFastTaskTest_Test::TestBody()  /usr/local/google/glider-chromium/src/base/condition_variable_unittest.cc:463  ==10664==     #2  testing::Test::Run()  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest.cc:2055  ==10664==     #3  testing::internal::TestInfoImpl::Run()  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest.cc:2286  ==10664==     #4   testing::internal::TestInfoImpl::RunTest(testing::TestInfo*)  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest-internal-inl.h:655  ==10664==     #5  void  testing::internal::List&lt;testing::TestInfo*&gt;::ForEach&lt;void  (*)(testing::TestInfo*)&gt;(void (*)(testing::TestInfo*)) const  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest-internal-inl.h:397  ==10664==     #6  testing::TestCase::Run()  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest.cc:2382  ==10664==     #7  testing::TestCase::RunTestCase(testing::TestCase*)  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest-internal-inl.h:776  ==10664==     #8  void  testing::internal::List&lt;testing::TestCase*&gt;::ForEach&lt;void  (*)(testing::TestCase*)&gt;(void (*)(testing::TestCase*)) const  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest-internal-inl.h:397  ==10664==     #9  testing::internal::UnitTestImpl::RunAllTests()  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest.cc:3653  ==10664==     #10 testing::UnitTest::Run()  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest.cc:3387  ==10664==     #11 TestSuite::Run()  /usr/local/google/glider-chromium/src/base/test_suite.h:62  ==10664==   Concurrent write(s) happened at (OR AFTER) these points:  ==10664==    T2 (locks held: {L50}):  ==10664==     #0  (anonymous namespace)::WorkQueue::WorkIsCompleted(int)  /usr/local/google/glider-chromium/src/base/condition_variable_unittest.cc:552  ==10664==     #1  (anonymous namespace)::WorkQueue::ThreadMain()  /usr/local/google/glider-chromium/src/base/condition_variable_unittest.cc:733  ==10664==     #2  ThreadFunc(void*)  /usr/local/google/glider-chromium/src/base/platform_thread_posix.cc:26  ==10664==     #3  ThreadSanitizerStartThread ts_valgrind_intercepts.c:424  ==10664==   Location 0x8D8F464 is 4 bytes inside a block starting at  0x8D8F460 of size 800 allocated by T0 from heap:  ==10664==     #0  malloc ts_valgrind_intercepts.c:290  ==10664==     #1  operator new(unsigned int) /usr/lib32/libstdc++.so.6.0.9  ==10664==     #2  __gnu_cxx::new_allocator&lt;int&gt;::allocate(unsigned int   void const*) /usr/include/c++/4.2/ext/new_allocator.h:91  ==10664==     #3  std::_Vector_base&lt;int  std::allocator&lt;int&gt;  &gt;::_M_allocate(unsigned int) /usr/include/c++/4.2/bits/stl_vector.h:128  ==10664==     #4  std::_Vector_base&lt;int  std::allocator&lt;int&gt;  &gt;::_Vector_base(unsigned int  std::allocator&lt;int&gt; const&amp;)  /usr/include/c++/4.2/bits/stl_vector.h:114  ==10664==     #5  std::vector&lt;int  std::allocator&lt;int&gt; &gt;::vector(unsigned  int  int const&amp;  std::allocator&lt;int&gt; const&amp;)  /usr/include/c++/4.2/bits/stl_vector.h:212  ==10664==     #6  (anonymous namespace)::WorkQueue::WorkQueue(int)  /usr/local/google/glider-chromium/src/base/condition_variable_unittest.cc:504  ==10664==     #7  (anonymous  namespace)::ConditionVariableTest_LargeFastTaskTest_Test::TestBody()  /usr/local/google/glider-chromium/src/base/condition_variable_unittest.cc:389  ==10664==     #8  testing::Test::Run()  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest.cc:2055  ==10664==     #9  testing::internal::TestInfoImpl::Run()  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest.cc:2286  ==10664==     #10  testing::internal::TestInfoImpl::RunTest(testing::TestInfo*)  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest-internal-inl.h:655  ==10664==     #11 void  testing::internal::List&lt;testing::TestInfo*&gt;::ForEach&lt;void  (*)(testing::TestInfo*)&gt;(void (*)(testing::TestInfo*)) const  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest-internal-inl.h:397  ==10664==   Locks involved in this report (reporting last lock sites):  {L50  L251}  ==10664==    L50 (0xFEAC8368)  ==10664==     #0  pthread_mutex_lock ts_valgrind_intercepts.c:641  ==10664==     #1  LockImpl::Lock()  /usr/local/google/glider-chromium/src/base/lock_impl_posix.cc:41  ==10664==     #2  Lock::Acquire()  /usr/local/google/glider-chromium/src/base/lock.h:16  ==10664==     #3  AutoLock::AutoLock(Lock&amp;)  /usr/local/google/glider-chromium/src/base/lock.h:43  ==10664==     #4  (anonymous namespace)::WorkQueue::ThreadMain()  /usr/local/google/glider-chromium/src/base/condition_variable_unittest.cc:704  ==10664==     #5  ThreadFunc(void*)  /usr/local/google/glider-chromium/src/base/platform_thread_posix.cc:26  ==10664==     #6  ThreadSanitizerStartThread ts_valgrind_intercepts.c:424  ==10664==    L251 (0xFEAC8494)  ==10664==     #0  pthread_cond_timedwait@* ts_valgrind_intercepts.c:839  ==10664==     #1  (anonymous  namespace)::ConditionVariableTest_LargeFastTaskTest_Test::TestBody()  /usr/local/google/glider-chromium/src/base/condition_variable_unittest.cc:402  ==10664==     #2  testing::Test::Run()  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest.cc:2055  ==10664==     #3  testing::internal::TestInfoImpl::Run()  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest.cc:2286  ==10664==     #4   testing::internal::TestInfoImpl::RunTest(testing::TestInfo*)  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest-internal-inl.h:655  ==10664==     #5  void  testing::internal::List&lt;testing::TestInfo*&gt;::ForEach&lt;void  (*)(testing::TestInfo*)&gt;(void (*)(testing::TestInfo*)) const  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest-internal-inl.h:397  ==10664==     #6  testing::TestCase::Run()  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest.cc:2382  ==10664==     #7  testing::TestCase::RunTestCase(testing::TestCase*)  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest-internal-inl.h:776  ==10664==     #8  void  testing::internal::List&lt;testing::TestCase*&gt;::ForEach&lt;void  (*)(testing::TestCase*)&gt;(void (*)(testing::TestCase*)) const  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest-internal-inl.h:397  ==10664==     #9  testing::internal::UnitTestImpl::RunAllTests()  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest.cc:3653  ==10664==     #10 testing::UnitTest::Run()  /usr/local/google/glider-chromium/src/testing/gtest/src/gtest.cc:3387  ==10664==     #11 TestSuite::Run()  /usr/local/google/glider-chromium/src/base/test_suite.h:62  ==10664== }}}   </pre>