<title>Issue 5041 -   chromium -    Valgrind error in disk cache backend - Project Hosting on Google Code</title> <pre> The follow error is a bit iffy (the code will operate fine)  however  the   error has a point and I think we should fix it.  I have annotated the code   a bit below to explain what's happening:    template&lt;typename T&gt; void StorageBlock&lt;T&gt;::AllocateData() {    ...       void* buffer = new char[address_.num_blocks() * sizeof(*data_)];      // We use placement new to call the constructor for T with      // |this| as the buffer we just allocated with new[].      data_ = new(buffer) T;    }    own_data_ = true;  }    template&lt;typename T&gt; StorageBlock&lt;T&gt;::~StorageBlock() {    if (modified_)      Store();    if (own_data_)      delete data_;  }    We call delete data_  which will cause the destructor for T to be called    but then also to free the memory.  This is a mismatch in new[] and delete.    It is ok in this case since we allocated a char and there are no   destructors that need to be run.  However  I think it would still be   cleaner to:    Explicitly call T::~T  since this matches our placement new   initialization    Call delete[] on reinterpret_cast&lt;char*&gt;(data_)  or some other approach   to make sure the allocation of |buffer| matches how it's freed.      ==25173== Thread 2:  ==25173== Mismatched free() / delete / delete []  ==25173==    at 0x75E76C9: operator delete(void*) (vg_replace_malloc.c:342)  ==25173==    by 0x81C939A:   disk_cache::StorageBlock&lt;disk_cache::EntryStore&gt;::~StorageBlock()   (storage_block-inl.h:27)  ==25173==    by 0x81C789A: disk_cache::EntryImpl::~EntryImpl()   (entry_impl.cc:138)  ==25173==    by 0x81C00DC:   base::RefCounted&lt;disk_cache::EntryImpl&gt;::Release() (ref_counted.h:78)  ==25173==    by 0x81C43F9: disk_cache::EntryImpl::Close()   (entry_impl.cc:149)  ==25173==    by 0x817690A: net::HttpCache::ActiveEntry::~ActiveEntry()   (http_cache.cc:157)  ==25173==    by 0x8177298:   net::HttpCache::DeactivateEntry(net::HttpCache::ActiveEntry*)   (http_cache.cc:1206)  ==25173==    by 0x81779D6:   net::HttpCache::DestroyEntry(net::HttpCache::ActiveEntry*)   (http_cache.cc:1172)  ==25173==    by 0x81798AE:   net::HttpCache::OnProcessPendingQueue(net::HttpCache::ActiveEntry*)   (http_cache.cc:1358)  ==25173==    by 0x817DB3A: void DispatchToMethod&lt;net::HttpCache  void   (net::HttpCache::*)(net::HttpCache::ActiveEntry*)    net::HttpCache::ActiveEntry*&gt;(net::HttpCache*  void   (net::HttpCache::*)(net::HttpCache::ActiveEntry*)    Tuple1&lt;net::HttpCache::ActiveEntry*&gt; const&amp;) (tuple.h:393)  ==25173==    by 0x817DB6C:   ScopedRunnableMethodFactory&lt;net::HttpCache&gt;::RunnableMethod&lt;void   (net::HttpCache::*)(net::HttpCache::ActiveEntry*)    Tuple1&lt;net::HttpCache::ActiveEntry*&gt; &gt;::Run() (task.h:202)     </pre>