<title>Issue 32266 -   chromium -    browser deadlock in SelectFileDialogImpl::FileNotSelected - Project Hosting on Google Code</title> <pre> I was playing with an unreleased extension that embedded a flash control in a browser popup (see me for the extension).  When I closed the popup  the browser hung.  I attached with the debugger and found the following threads of   interest:    main thread:  &gt;	ntdll.dll!_ZwWaitForSingleObject@12()  + 0x15 bytes	   	kernel32.dll!_WaitForSingleObjectEx@12()  + 0x8f bytes	   	kernel32.dll!_WaitForSingleObject@8()  + 0x12 bytes	   	chrome.dll!PlatformThread::Join(void * thread_handle=0x000017d4)  Line 104	C++   	chrome.dll!base::Thread::Stop()  Line 116	C++   	chrome.dll!base::Thread::~Thread()  Line 49	C++   	chrome.dll!ShellDialogThread::`scalar deleting destructor'()  + 0x8 bytes	C++   	chrome.dll!BaseShellDialogImpl::EndRun(BaseShellDialogImpl::RunState run_state={...})  Line 161	C++   	chrome.dll!SelectFileDialogImpl::FileNotSelected(void * params=0x0c052c40  BaseShellDialogImpl::RunState run_state={...})  Line 418	C++   	chrome.dll!RunnableMethod&lt;SelectFileDialogImpl void (__thiscall SelectFileDialogImpl::*)(void * BaseShellDialogImpl::RunState) Tuple2&lt;void * BaseShellDialogImpl::RunState&gt; &gt;::Run()  Line 289 + 0x15 bytes	C++   	chrome.dll!MessageLoop::RunTask(Task * task=0x09e24380)  Line 321	C++   	chrome.dll!MessageLoop::DeferOrRunPendingTask(const MessageLoop::PendingTask &amp; pending_task={...})  Line 331	C++   	chrome.dll!MessageLoop::DoWork()  Line 435 + 0x7 bytes	C++   	chrome.dll!base::MessagePumpForUI::DoRunLoop()  Line 209 + 0x7 bytes	C++   	chrome.dll!base::MessagePumpWin::RunWithDispatcher(base::MessagePump::Delegate * delegate=0x00000000  base::MessagePumpWin::Dispatcher * dispatcher=0x0058f0f0)  Line 54	C++   	chrome.dll!MessageLoop::RunInternal()  Line 206	C++   	chrome.dll!MessageLoop::RunHandler()  Line 177 + 0x5 bytes	C++   	chrome.dll!MessageLoopForUI::Run(base::MessagePumpWin::Dispatcher * dispatcher=0x0058f0f0)  Line 604	C++   	chrome.dll!`anonymous namespace'::RunUIMessageLoop(BrowserProcess * browser_process=0x0058f4e4)  Line 165	C++   	chrome.dll!BrowserMain(const MainFunctionParams &amp; parameters={...})  Line 920	C++   	chrome.dll!ChromeMain(HINSTANCE__ * instance=0x003d0000  sandbox::SandboxInterfaceInfo * sandbox_info=0x0058f72c  wchar_t * command_line=0x00212cf8)  Line 744 + 0xa bytes	C++   	chrome.exe!MainDllLoader::Launch(HINSTANCE__ * instance=0x003d0000  sandbox::SandboxInterfaceInfo * sbox_info=0x0058f72c)  Line 177	C++   	chrome.exe!wWinMain(HINSTANCE__ * instance=0x003d0000  HINSTANCE__ * __formal=0x00000000  HINSTANCE__ * __formal=0x00000000  HINSTANCE__ * __formal=0x00000000)  Line 49	C++   	chrome.exe!__tmainCRTStartup()  Line 324 + 0x1c bytes	C   	kernel32.dll!@BaseThreadInitThunk@12()  + 0xe bytes	   	ntdll.dll!___RtlUserThreadStart@8()  + 0x23 bytes	   	ntdll.dll!__RtlUserThreadStart@8()  + 0x1b bytes	    (I have no clue what triggered the FileNotSelected call.  As far as I can remember  I didn't have a file dialog open.)    an OLE32 thread:  &gt;	ntdll.dll!_NtWaitForMultipleObjects@20()  + 0x15 bytes	   	kernel32.dll!_WaitForMultipleObjectsEx@20()  - 0x69 bytes	   	user32.dll!_RealMsgWaitForMultipleObjectsEx@20()  - 0x6a bytes	   	ole32.dll!CCliModalLoop::BlockFn()  + 0x8c bytes	   	ole32.dll!ModalLoop()  + 0x52 bytes	   	ole32.dll!SwitchSTA()  + 0x21 bytes	   	ole32.dll!CRpcChannelBuffer::SwitchAptAndDispatchCall()  - 0xe99 bytes	   	ole32.dll!CRpcChannelBuffer::SendReceive2()  + 0xa6 bytes	   	ole32.dll!CCliModalLoop::SendReceive()  + 0x1e bytes	   	ole32.dll!CAptRpcChnl::SendReceive()  - 0x239cd bytes	   	ole32.dll!CCtxComChnl::SendReceive()  + 0x47 bytes	   	rpcrt4.dll!77601074() 	   	rpcrt4.dll!7760102b() 	   	rpcrt4.dll!_NdrClientCall2()  + 0x977c0 bytes	   	rpcrt4.dll!_ObjectStublessClient@8()  + 0x95b66 bytes	   	rpcrt4.dll!_ObjectStubless@0()  + 0xf bytes	   	ole32.dll!RemoteReleaseRifRefHelper()  + 0x37 bytes	   	ole32.dll!RemoteReleaseRifRef()  + 0x67 bytes	   	ole32.dll!CStdMarshal::DisconnectCliIPIDs()  - 0x7b bytes	   	ole32.dll!CStdMarshal::Disconnect()  + 0x12e bytes	   	ole32.dll!DisconnectSwitch()  + 0x16 bytes	   	ole32.dll!CStdMarshal::DisconnectAndRelease()  + 0x2e bytes	   	ole32.dll!COIDTable::ThreadCleanup()  - 0x27b8b bytes	   	ole32.dll!FinishShutdown()  + 0x40 bytes	   	ole32.dll!ApartmentUninitialize()  + 0x58 bytes	   	ole32.dll!wCoUninitialize()  + 0x48 bytes	   	ole32.dll!_CoUninitialize@0()  + 0x1b2 bytes	   	ole32.dll!DoThreadSpecificCleanup()  + 0x2edda bytes	   	ole32.dll!FlsThreadCleanupCallback()  + 0x19 bytes	   	ntdll.dll!_RtlProcessFlsData@4()  + 0x57 bytes	   	ntdll.dll!_LdrShutdownThread@0()  + 0x14fe3 bytes	   	ntdll.dll!_RtlExitUserThread@4()  + 0x2e bytes	   	kernel32.dll!@BaseThreadInitThunk@12()  + 0x15 bytes	   	ntdll.dll!___RtlUserThreadStart@8()  + 0x23 bytes	   	ntdll.dll!__RtlUserThreadStart@8()  + 0x1b bytes	    These two seem the most likely to be the deadlock.  For completeness  here are three other threads:     	ntdll.dll!_ZwWaitForSingleObject@12()  + 0x15 bytes	   	kernel32.dll!_WaitForSingleObjectEx@12()  + 0x8f bytes	   	kernel32.dll!_WaitForSingleObject@8()  + 0x12 bytes	   	chrome.dll!WTF::PlatformCondition::timedWait(WTF::PlatformMutex &amp; mutex={...}  unsigned long durationMilliseconds=4294967295)  Line 346	C++   	chrome.dll!WTF::ThreadCondition::timedWait(WTF::Mutex &amp; mutex={...}  double absoluteTime=1.7976931348623157e+308)  Line 476	C++   	chrome.dll!WTF::MessageQueue&lt;WebCore::DatabaseTask&gt;::waitForMessageFilteredWithTimeout&lt;bool __cdecl(WebCore::DatabaseTask *)&gt;(WTF::MessageQueueWaitResult &amp; result=MessageQueueMessageReceived  bool (WebCore::DatabaseTask   *)* predicate=0x06d7f77c  double absoluteTime=1.7976931348623157e+308)  Line 136 + 0x11 bytes	C++   	chrome.dll!WebCore::LocalStorageThread::threadEntryPoint()  Line 69 + 0x26 bytes	C++   	chrome.dll!WTF::threadEntryPoint(void * contextData=0x05e17750)  Line 64 + 0x3 bytes	C++   	chrome.dll!WTF::wtfThreadEntryPoint(void * param=0x02400e68)  Line 210	C++  &gt;	chrome.dll!_callthreadstartex()  Line 348 + 0x6 bytes	C   	chrome.dll!_threadstartex(void * ptd=0x055d7d80)  Line 326 + 0x5 bytes	C   	kernel32.dll!@BaseThreadInitThunk@12()  + 0xe bytes	   	ntdll.dll!___RtlUserThreadStart@8()  + 0x23 bytes	   	ntdll.dll!__RtlUserThreadStart@8()  + 0x1b bytes	      &gt;	ntdll.dll!_ZwRemoveIoCompletion@20()  + 0x15 bytes	   	kernel32.dll!_GetQueuedCompletionStatus@20()  + 0x29 bytes	   	chrome.dll!base::MessagePumpForIO::GetIOItem(unsigned long timeout=100  base::MessagePumpForIO::IOItem * item=0x00000000)  Line 520 + 0x2c bytes	C++   	chrome.dll!base::MessagePumpForIO::WaitForIOCompletion(unsigned long timeout=100  base::MessagePumpForIO::IOHandler * filter=0x00000000)  Line 491 + 0xd bytes	C++   	chrome.dll!base::MessagePumpForIO::DoRunLoop()  Line 469 + 0x16 bytes	C++   	chrome.dll!base::MessagePumpWin::RunWithDispatcher(base::MessagePump::Delegate * delegate=0x00000000  base::MessagePumpWin::Dispatcher * dispatcher=0x00000000)  Line 54	C++   	chrome.dll!base::MessagePumpWin::Run(base::MessagePump::Delegate * delegate=0x03c4f918)  Line 78 + 0xe bytes	C++   	chrome.dll!MessageLoop::RunInternal()  Line 206	C++   	chrome.dll!MessageLoop::RunHandler()  Line 177 + 0x5 bytes	C++   	chrome.dll!MessageLoop::Run()  Line 156	C++   	chrome.dll!base::Thread::Run(MessageLoop * message_loop=0x03c4f918)  Line 134	C++   	chrome.dll!base::Thread::ThreadMain()  Line 158	C++   	chrome.dll!`anonymous namespace'::ThreadFunc(void * closure=0x0242f580)  Line 27	C++   	kernel32.dll!@BaseThreadInitThunk@12()  + 0xe bytes	   	ntdll.dll!___RtlUserThreadStart@8()  + 0x23 bytes	   	ntdll.dll!__RtlUserThreadStart@8()  + 0x1b bytes	      &gt;	ntdll.dll!_NtWaitForMultipleObjects@20()  + 0x15 bytes	   	kernel32.dll!_WaitForMultipleObjectsEx@20()  - 0x69 bytes	   	user32.dll!_RealMsgWaitForMultipleObjectsEx@20()  - 0x6a bytes	   	chrome.dll!base::MessagePumpForUI::WaitForWork()  Line 264	C++   	chrome.dll!base::MessagePumpForUI::DoRunLoop()  Line 234 + 0x7 bytes	C++   	chrome.dll!base::MessagePumpWin::RunWithDispatcher(base::MessagePump::Delegate * delegate=0x00000000  base::MessagePumpWin::Dispatcher * dispatcher=0x00000000)  Line 54	C++   	chrome.dll!base::MessagePumpWin::Run(base::MessagePump::Delegate * delegate=0x035afec0)  Line 78 + 0xe bytes	C++   	chrome.dll!MessageLoop::RunInternal()  Line 206	C++   	chrome.dll!MessageLoop::RunHandler()  Line 177 + 0x5 bytes	C++   	chrome.dll!MessageLoop::Run()  Line 156	C++   	chrome.dll!base::Thread::Run(MessageLoop * message_loop=0x035afec0)  Line 134	C++   	chrome.dll!base::Thread::ThreadMain()  Line 158	C++   	chrome.dll!`anonymous namespace'::ThreadFunc(void * closure=0x0242f600)  Line 27	C++   	kernel32.dll!@BaseThreadInitThunk@12()  + 0xe bytes	   	ntdll.dll!___RtlUserThreadStart@8()  + 0x23 bytes	   	ntdll.dll!__RtlUserThreadStart@8()  + 0x1b bytes	         </pre>