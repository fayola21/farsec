<title>Issue 45298 -   chromium -    TestShellRequestContext should be created/used/destroyed only on the IO thread. - Project Hosting on Google Code</title> <pre> I'm trying to add DCHECKs to prevent this bad behavior  but have been running into problems here.  I think   appcache folks need to fix the tests.    Here's my changelist where I am trying to assert the correct behavior:   <a href="http://codereview.chromium.org/2122015/show">http://codereview.chromium.org/2122015/show</a>    Here's the trybot run that failed:  <a href="http://build.chromium.org/buildbot/try-server/builders/win/builds/32981/steps/test_shell_tests/logs/stdio">http://build.chromium.org/buildbot/try-server/builders/win/builds/32981/steps/test_shell_tests/logs/stdio</a>   (crashes at the very end).    There was no stacktrace  so I asked pathorn to help.  He got me this stacktrace on Windows with my patch:    [ RUN      ] AppCacheUpdateJobTest.UpgradeManifestDataUnchanged  [4912:2984:109637565:FATAL:appcache_working_set.cc(35)] Check failed: caches_.find(cache_id) ==   caches_.end().  Backtrace:          StackTrace::StackTrace [0x017B0DE1+33] (d:srcchsrcbasedebug_util_win.cc:230)          logging::LogMessage::~LogMessage [0x0176AB41+81] (d:srcchsrcbaselogging.cc:465)          appcache::AppCacheWorkingSet::AddCache [0x00E42930+352]   (d:srcchsrcwebkitappcacheappcache_working_set.cc:35)          appcache::AppCache::AppCache [0x00E1EE9C+172] (d:srcchsrcwebkitappcacheappcache.cc:26)          appcache::AppCacheUpdateJob::ContinueHandleManifestFetchCompleted [0x00E5CCBB+571]   (d:srcchsrcwebkitappcacheappcache_update_job.cc:562)          appcache::AppCacheUpdateJob::OnManifestDataReadComplete [0x00E5F219+217]   (d:srcchsrcwebkitappcacheappcache_update_job.cc:906)          DispatchToMethod&lt;appcache::AppCacheUpdateJob void (__thiscall   appcache::AppCacheUpdateJob::*)(int) int&gt; [0x00E6E405+21] (d:srcchsrcbasetuple.h:422)          CallbackImpl&lt;appcache::AppCacheUpdateJob void (__thiscall   appcache::AppCacheUpdateJob::*)(int) Tuple1&lt;int&gt; &gt;::RunWithParams [0x00E63E29+41]   (d:srcchsrcbasecallback.h:118)          CallbackRunner&lt;Tuple1&lt;int&gt; &gt;::Run&lt;int&gt; [0x00CE45E4+52] (d:srcchsrcbasecallback.h:83)          appcache::AppCacheResponseIO::InvokeUserCompletionCallback [0x00E51A00+80]   (d:srcchsrcwebkitappcacheappcache_response.cc:99)          appcache::AppCacheResponseReader::OnIOComplete [0x00E52664+516]   (d:srcchsrcwebkitappcacheappcache_response.cc:224)          DispatchToMethod&lt;appcache::AppCacheResponseIO void (__thiscall   appcache::AppCacheResponseIO::*)(int) int&gt; [0x00E548B2+18] (d:srcchsrcbasetuple.h:422)          ScopedRunnableMethodFactory&lt;appcache::AppCacheResponseIO&gt;::RunnableMethod&lt;void (__thiscall   appcache::AppCacheResponseIO::*)(int) Tuple1&lt;int&gt; &gt;::Run [0x00E54A4C+60] (d:srcchsrcbasetask.h:153)          MessageLoop::RunTask [0x0175D649+185] (d:srcchsrcbasemessage_loop.cc:328)          MessageLoop::DeferOrRunPendingTask [0x0175D6F5+53] (d:srcchsrcbasemessage_loop.cc:339)          MessageLoop::DoWork [0x0175DC49+233] (d:srcchsrcbasemessage_loop.cc:443)          base::MessagePumpForIO::DoRunLoop [0x017BFF02+50] (d:srcchsrcbasemessage_pump_win.cc:443)          base::MessagePumpWin::RunWithDispatcher [0x017BEA52+130]   (d:srcchsrcbasemessage_pump_win.cc:52)          base::MessagePumpWin::Run [0x017BECAC+28] (d:srcchsrcbasemessage_pump_win.h:78)          MessageLoop::RunInternal [0x0175CE0B+267] (d:srcchsrcbasemessage_loop.cc:204)          MessageLoop::RunHandler [0x0175CBCB+43] (d:srcchsrcbasemessage_loop.cc:177)          MessageLoop::Run [0x0175CABA+58] (d:srcchsrcbasemessage_loop.cc:155)          base::Thread::Run [0x01768C46+22] (d:srcchsrcbasethread.cc:137)          base::Thread::ThreadMain [0x01768D67+263] (d:srcchsrcbasethread.cc:160)          `anonymous namespace'::ThreadFunc [0x0178FFA1+33] (d:srcchsrcbaseplatform_thread_win.cc:26)          BaseThreadInitThunk [0x75F13677+18]          RtlInitializeExceptionChain [0x77209D72+99]          RtlInitializeExceptionChain [0x77209D45+54] </pre>