<title>Issue 28364 -   chromium -    leak and race in ResourceDispatcherHostTest - Project Hosting on Google Code</title> <pre> I  disabling the two tests that were exposing the problem.  Please fix and   re-enable.    <a href="/p/chromium/source/detail?r=32608">revision 32608</a> caused a leak to show up:      operator new(unsigned int) (ome/chrome-bot/valgrind-10880-  redzone/coregrind/m_replacemalloc/vg_replace_malloc.c:214)    ResourceDispatcherHost::BeginRequest(int  ViewHostMsg_Resource_Request   const&amp;  IPC::Message*  int)   (uilder/build/src/chrome/browser/renderer_host/resource_dispatcher_host.cc:  587)    ResourceDispatcherHost::OnRequestResource(IPC::Message const&amp;  int    ViewHostMsg_Resource_Request const&amp;)   (uilder/build/src/chrome/browser/renderer_host/resource_dispatcher_host.cc:  372)    bool IPC::MessageWithTuple&lt;Tuple2&lt;int  ViewHostMsg_Resource_Request&gt;   &gt;::Dispatch&lt;ResourceDispatcherHost  int  ViewHostMsg_Resource_Request   const&amp;&gt;(IPC::Message const*  ResourceDispatcherHost*  void   (ResourceDispatcherHost::*)(IPC::Message const&amp;  int    ViewHostMsg_Resource_Request const&amp;))   (uilder/build/src/ipc/ipc_message_utils.h:1024)    ResourceDispatcherHost::OnMessageReceived(IPC::Message const&amp;    ResourceDispatcherHost::Receiver*  bool*)   (uilder/build/src/chrome/browser/renderer_host/resource_dispatcher_host.cc:  354)      ResourceDispatcherHostTest::MakeTestRequest(ResourceDispatcherHost::Receive  r*  int  int  GURL const&amp;)   (uilder/build/src/chrome/browser/renderer_host/resource_dispatcher_host_uni  ttest.cc:280)    ResourceDispatcherHostTest_TestBlockedRequestsDontLeak_Test::TestBody()   (uilder/build/src/chrome/browser/renderer_host/resource_dispatcher_host_uni  ttest.cc:624)    testing::Test::Run() (uilder/build/src/testing/gtest/src/gtest.cc:2099)    testing::internal::TestInfoImpl::Run()   (uilder/build/src/testing/gtest/src/gtest.cc:2318)    testing::TestCase::Run()   (uilder/build/src/testing/gtest/src/gtest.cc:2426)    testing::internal::UnitTestImpl::RunAllTests()   (uilder/build/src/testing/gtest/src/gtest.cc:4026)    testing::UnitTest::Run()   (uilder/build/src/testing/gtest/src/gtest.cc:3694)    TestSuite::Run() (uilder/build/src/base/test/test_suite.h:123)    main (uilder/build/src/chrome/test/unit/run_all_unittests.cc:8)    Also  a race was reported by thread sanitizer:  <a href="http://build.chromium.org/buildbot/waterfall/builders/Linux%20Tests%20(tsan">http://build.chromium.org/buildbot/waterfall/builders/Linux%20Tests%20(tsan</a>  )/builds/1024/steps/valgrind%20test:%20unit/logs/stdio    ==27480==     #0  clone /lib/tls/i686/cmov/libc-2.7.so  ==27480==     #1  pthread_create@@GLIBC_2.1 /lib/tls/i686/cmov/libpthread-  2.7.so  ==27480==     #2  pthread_create@* /home/chrome-bot/valgrind-  10880/tsan/ts_valgrind_intercepts.c:556  ==27480==     #3  (anonymous namespace)::CreateThread(unsigned int  bool    PlatformThread::Delegate*  unsigned long*) /b/slave/chromium-rel-linux-  valgrind-builder/build/src/base/platform_thread_posix.cc:93  ==27480==     #4  PlatformThread::Create(unsigned int    PlatformThread::Delegate*  unsigned long*) /b/slave/chromium-rel-linux-  valgrind-builder/build/src/base/platform_thread_posix.cc:105  ==27480==     #5  base::Thread::StartWithOptions(base::Thread::Options   const&amp;) /b/slave/chromium-rel-linux-valgrind-  builder/build/src/base/thread.cc:85  ==27480==     #6  base::Thread::Start() /b/slave/chromium-rel-linux-  valgrind-builder/build/src/base/thread.cc:74  ==27480==     #7  WebKitThread::WebKitThread() /b/slave/chromium-rel-linux-  valgrind-  builder/build/src/chrome/browser/in_process_webkit/webkit_thread.cc:21  ==27480==     #8  ResourceDispatcherHost::ResourceDispatcherHost()   /b/slave/chromium-rel-linux-valgrind-  builder/build/src/chrome/browser/renderer_host/resource_dispatcher_host.cc:  267  ==27480==     #9  ResourceDispatcherHostTest::ResourceDispatcherHostTest()   /b/slave/chromium-rel-linux-valgrind-  builder/build/src/chrome/browser/renderer_host/resource_dispatcher_host_uni  ttest.cc:152  ==27480==     #10   ResourceDispatcherHostTest_TestMany_Test::ResourceDispatcherHostTest_TestMa  ny_Test() /b/slave/chromium-rel-linux-valgrind-  builder/build/src/chrome/browser/renderer_host/resource_dispatcher_host_uni  ttest.cc:329  ==27480==     #11   testing::internal::TestFactoryImpl&lt;ResourceDispatcherHostTest_TestMany_Test  &gt;::CreateTest() /b/slave/chromium-rel-linux-valgrind-  builder/build/src/testing/gtest/include/gtest/internal/gtest-internal.h:550  ==27480==     #12 testing::internal::TestInfoImpl::Run() /b/slave/chromium-  rel-linux-valgrind-builder/build/src/testing/gtest/src/gtest.cc:2312  ==27480==     #13 testing::TestCase::Run() /b/slave/chromium-rel-linux-  valgrind-builder/build/src/testing/gtest/src/gtest.cc:2426  ==27480==     #14 testing::internal::UnitTestImpl::RunAllTests()   /b/slave/chromium-rel-linux-valgrind-  builder/build/src/testing/gtest/src/gtest.cc:4026  ==27480==     #15 testing::UnitTest::Run() /b/slave/chromium-rel-linux-  valgrind-builder/build/src/testing/gtest/src/gtest.cc:3694  ==27480==     #16 TestSuite::Run() /b/slave/chromium-rel-linux-valgrind-  builder/build/src/base/test/test_suite.h:123  ==27480==     #17 main /b/slave/chromium-rel-linux-valgrind-  builder/build/src/chrome/test/unit/run_all_unittests.cc:8   </pre>