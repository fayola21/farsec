<title>Issue 44485 -   chromium -    Data race in test_shell AppCacheStorageImplTest - Project Hosting on Google Code</title> <pre> Assigning this to michaeln since the problems go a bit deeper than the ScopedRunnableMethodFactory issues in 24715.  I poked around a bit  the problems are sort of similar (cleaning up the DB and IO thread stuff from   the main test thread)  but I wasn't sure whether this is a test-only problem or   not.  The code in question could perhaps use some more DCHECK(CurrentlyOn(FOO)) calls.      1. tools/valgrind/chrome_tests.sh --tool=tsan -t test_shell --gtest_filter='AppCacheStorage*'    What is the expected output?   no errors    What do you see instead?  11:17:19 tsan_analyze.py [ERROR] Found 3 race reports  11:17:19 tsan_analyze.py [ERROR]  ==12738== INFO: T2 has been created by T0 at this point: {{{  ==12738==     #0  ???//lib/libpthread-2.7.so /lib/libpthread-2.7.so  ==12738==     #1  pthread_create@@GLIBC_2.2.5 /lib/libpthread-2.7.so  ==12738==     #2  pthread_create@* ts_valgrind_intercepts.c:623  ==12738==     #3  (anonymous namespace)::CreateThread(unsigned long  bool  PlatformThread::Delegate*  unsigned long*) base/platform_thread_posix.cc:129  ==12738==     #4  PlatformThread::Create(unsigned long  PlatformThread::Delegate*  unsigned long*) base/platform_thread_posix.cc:141  ==12738==     #5  base::Thread::StartWithOptions(base::Thread::Options const&amp;) base/thread.cc:86  ==12738==     #6  base::Thread::Start() base/thread.cc:75  ==12738==     #7  appcache::AppCacheStorageImplTest::SetUpTestCase() webkit/appcache/appcache_storage_impl_unittest.cc:202  ==12738==     #8  testing::TestCase::Run() testing/gtest/src/gtest.cc:2416  ==12738== }}}  ==12738== INFO: T0 is program's main thread  ==12738== INFO: T1 has been created by T0 at this point: {{{  ==12738==     #0  ???//lib/libpthread-2.7.so /lib/libpthread-2.7.so  ==12738==     #1  pthread_create@@GLIBC_2.2.5 /lib/libpthread-2.7.so  ==12738==     #2  pthread_create@* ts_valgrind_intercepts.c:623  ==12738==     #3  (anonymous namespace)::CreateThread(unsigned long  bool  PlatformThread::Delegate*  unsigned long*) base/platform_thread_posix.cc:129  ==12738==     #4  PlatformThread::Create(unsigned long  PlatformThread::Delegate*  unsigned long*) base/platform_thread_posix.cc:141  ==12738==     #5  base::Thread::StartWithOptions(base::Thread::Options const&amp;) base/thread.cc:86  ==12738==     #6  appcache::AppCacheStorageImplTest::SetUpTestCase() webkit/appcache/appcache_storage_impl_unittest.cc:199  ==12738==     #7  testing::TestCase::Run() testing/gtest/src/gtest.cc:2416  ==12738== }}}  ==12738== WARNING: Possible data race during read of size 8 at 0x418D378: {{{  ==12738==    T2 (AppCacheTest::DBThread) (locks held: {}):  ==12738==     #0  appcache::AppCacheStorage::DelegateReference::~DelegateReference() webkit/appcache/appcache_storage.h:219  ==12738==     #1  base::RefCounted&lt;appcache::AppCacheStorage::DelegateReference&gt;::Release() base/ref_counted.h:93  ==12738==     #2  scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;::~scoped_refptr() base/ref_counted.h:238  ==12738==     #3  void std::_Destroy&lt;scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt; &gt;(scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*) /usr/include/c++/4.2/bits/stl_construct.h:107  ==12738==     #4  void std::__destroy_aux&lt;scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*&gt;(scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*    scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*  std::__false_type) /usr/include/c++/4.2/bits/stl_construct.h:122  ==12738==     #5  void std::_Destroy&lt;scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*&gt;(scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*    scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*) /usr/include/c++/4.2/bits/stl_construct.h:155  ==12738==     #6  void std::_Destroy&lt;scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*  scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;   &gt;(scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*  scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*    std::allocator&lt;scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt; &gt;) /usr/include/c++/4.2/bits/stl_construct.h:182  ==12738==     #7  std::vector&lt;scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;  std::allocator&lt;scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt; &gt; &gt;::~vector()   /usr/include/c++/4.2/bits/stl_vector.h:268  ==12738==     #8  appcache::AppCacheStorageImpl::DatabaseTask::~DatabaseTask() webkit/appcache/appcache_storage_impl.cc:48  ==12738==     #9  appcache::AppCacheStorageImpl::StoreOrLoadTask::~StoreOrLoadTask() webkit/appcache/appcache_storage_impl.cc:239  ==12738==     #10 appcache::AppCacheStorageImpl::GroupLoadTask::~GroupLoadTask() webkit/appcache/appcache_storage_impl.cc:342  ==12738==     #11 base::RefCountedThreadSafe&lt;appcache::AppCacheStorageImpl::DatabaseTask  base::DefaultRefCountedThreadSafeTraits&lt;appcache::AppCacheStorageImpl::DatabaseTask&gt;   &gt;::DeleteInternal(appcache::AppCacheStorageImpl::DatabaseTask*) base/ref_counted.h:146  ==12738==     #12 base::DefaultRefCountedThreadSafeTraits&lt;appcache::AppCacheStorageImpl::DatabaseTask&gt;::Destruct(appcache::AppCacheStorageImpl::DatabaseTask*) base/ref_counted.h:112  ==12738==     #13 base::RefCountedThreadSafe&lt;appcache::AppCacheStorageImpl::DatabaseTask  base::DefaultRefCountedThreadSafeTraits&lt;appcache::AppCacheStorageImpl::DatabaseTask&gt; &gt;::Release() base/ref_counted.h:140  ==12738==     #14 RunnableMethodTraits&lt;appcache::AppCacheStorageImpl::DatabaseTask&gt;::ReleaseCallee(appcache::AppCacheStorageImpl::DatabaseTask*) base/task.h:245  ==12738==     #15 RunnableMethod&lt;appcache::AppCacheStorageImpl::DatabaseTask  void (appcache::AppCacheStorageImpl::DatabaseTask::*)()  Tuple0&gt;::ReleaseCallee() base/task.h:306  ==12738==     #16 RunnableMethod&lt;appcache::AppCacheStorageImpl::DatabaseTask  void (appcache::AppCacheStorageImpl::DatabaseTask::*)()  Tuple0&gt;::~RunnableMethod() base/task.h:291  ==12738==     #17 MessageLoop::RunTask(Task*) base/message_loop.cc:329  ==12738==     #18 MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;) base/message_loop.cc:336  ==12738==     #19 MessageLoop::DoWork() base/message_loop.cc:443  ==12738==     #20 base::MessagePumpDefault::Run(base::MessagePump::Delegate*) base/message_pump_default.cc:23  ==12738==     #21 MessageLoop::RunInternal() base/message_loop.cc:204  ==12738==     #22 MessageLoop::RunHandler() base/message_loop.cc:176  ==12738==     #23 MessageLoop::Run() base/message_loop.cc:154  ==12738==     #24 base::Thread::Run(MessageLoop*) base/thread.cc:133  ==12738==     #25 base::Thread::ThreadMain() base/thread.cc:157  ==12738==     #26 ThreadFunc(void*) base/platform_thread_posix.cc:28  ==12738==     #27 ThreadSanitizerStartThread ts_valgrind_intercepts.c:571  ==12738==   Concurrent write(s) happened at (OR AFTER) these points:  ==12738==    T1 (AppCacheTest.IOThread) (locks held: {}):  ==12738==     #0  appcache::AppCacheStorage::DelegateReference::CancelReference() webkit/appcache/appcache_storage.h:211  ==12738==     #1  appcache::AppCacheStorage::CancelDelegateCallbacks(appcache::AppCacheStorage::Delegate*) webkit/appcache/appcache_storage.h:144  ==12738==     #2  appcache::AppCacheStorageImplTest::TearDownTest() webkit/appcache/appcache_storage_impl_unittest.cc:239  ==12738==     #3  appcache::AppCacheStorageImplTest::TestFinishedUnwound() webkit/appcache/appcache_storage_impl_unittest.cc:257  ==12738==     #4  void DispatchToMethod&lt;appcache::AppCacheStorageImplTest  void (appcache::AppCacheStorageImplTest::*)()&gt;(appcache::AppCacheStorageImplTest*  void (appcache::AppCacheStorageImplTest::*)()  Tuple0   const&amp;) base/tuple.h:412  ==12738==     #5  RunnableMethod&lt;appcache::AppCacheStorageImplTest  void (appcache::AppCacheStorageImplTest::*)()  Tuple0&gt;::Run() base/task.h:296  ==12738==     #6  MessageLoop::RunTask(Task*) base/message_loop.cc:328  ==12738==     #7  MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;) base/message_loop.cc:336  ==12738==     #8  MessageLoop::DoWork() base/message_loop.cc:443  ==12738==     #9  base::MessagePumpLibevent::Run(base::MessagePump::Delegate*) base/message_pump_libevent.cc:241  ==12738==   Location 0x418D378 is 24 bytes inside a block starting at 0x418D360 of size 40 allocated by T1 from heap:  ==12738==     #0  operator new(unsigned long) ts_valgrind_intercepts.c:407  ==12738==     #1  appcache::AppCacheStorage::GetOrCreateDelegateReference(appcache::AppCacheStorage::Delegate*) webkit/appcache/appcache_storage.h:269  ==12738==     #2  appcache::AppCacheStorageImpl::LoadOrCreateGroup(GURL const&amp;  appcache::AppCacheStorage::Delegate*) webkit/appcache/appcache_storage_impl.cc:942  ==12738==     #3  appcache::AppCacheStorageImplTest::Verify_LoadCache_Far_Hit() webkit/appcache/appcache_storage_impl_unittest.cc:402  ==12738==     #4  void DispatchToMethod&lt;appcache::AppCacheStorageImplTest  void (appcache::AppCacheStorageImplTest::*)()&gt;(appcache::AppCacheStorageImplTest*  void (appcache::AppCacheStorageImplTest::*)()  Tuple0   const&amp;) base/tuple.h:412  ==12738==     #5  RunnableMethod&lt;appcache::AppCacheStorageImplTest  void (appcache::AppCacheStorageImplTest::*)()  Tuple0&gt;::Run() base/task.h:296  ==12738==     #6  MessageLoop::RunTask(Task*) base/message_loop.cc:328  ==12738==     #7  MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;) base/message_loop.cc:336  ==12738==     #8  MessageLoop::DoWork() base/message_loop.cc:443  ==12738==     #9  base::MessagePumpLibevent::Run(base::MessagePump::Delegate*) base/message_pump_libevent.cc:241  ==12738== }}}        11:17:19 tsan_analyze.py [ERROR]  ==12738== WARNING: Possible data race during read of size 8 at 0x4156558: {{{  ==12738==    T2 (AppCacheTest::DBThread) (locks held: {}):  ==12738==     #0  appcache::AppCacheStorage::DelegateReference::~DelegateReference() webkit/appcache/appcache_storage.h:219  ==12738==     #1  base::RefCounted&lt;appcache::AppCacheStorage::DelegateReference&gt;::Release() base/ref_counted.h:93  ==12738==     #2  scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;::~scoped_refptr() base/ref_counted.h:238  ==12738==     #3  void std::_Destroy&lt;scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt; &gt;(scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*) /usr/include/c++/4.2/bits/stl_construct.h:107  ==12738==     #4  void std::__destroy_aux&lt;scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*&gt;(scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*    scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*  std::__false_type) /usr/include/c++/4.2/bits/stl_construct.h:122  ==12738==     #5  void std::_Destroy&lt;scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*&gt;(scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*    scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*) /usr/include/c++/4.2/bits/stl_construct.h:155  ==12738==     #6  void std::_Destroy&lt;scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*  scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;   &gt;(scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*  scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;*    std::allocator&lt;scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt; &gt;) /usr/include/c++/4.2/bits/stl_construct.h:182  ==12738==     #7  std::vector&lt;scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt;  std::allocator&lt;scoped_refptr&lt;appcache::AppCacheStorage::DelegateReference&gt; &gt; &gt;::~vector()   /usr/include/c++/4.2/bits/stl_vector.h:268  ==12738==     #8  appcache::AppCacheStorageImpl::DatabaseTask::~DatabaseTask() webkit/appcache/appcache_storage_impl.cc:48  ==12738==     #9  appcache::AppCacheStorageImpl::StoreOrLoadTask::~StoreOrLoadTask() webkit/appcache/appcache_storage_impl.cc:239  ==12738==     #10 appcache::AppCacheStorageImpl::StoreGroupAndCacheTask::~StoreGroupAndCacheTask() webkit/appcache/appcache_storage_impl.cc:387  ==12738==     #11 base::RefCountedThreadSafe&lt;appcache::AppCacheStorageImpl::DatabaseTask  base::DefaultRefCountedThreadSafeTraits&lt;appcache::AppCacheStorageImpl::DatabaseTask&gt;   &gt;::DeleteInternal(appcache::AppCacheStorageImpl::DatabaseTask*) base/ref_counted.h:146  ==12738==     #12 base::DefaultRefCountedThreadSafeTraits&lt;appcache::AppCacheStorageImpl::DatabaseTask&gt;::Destruct(appcache::AppCacheStorageImpl::DatabaseTask*) base/ref_counted.h:112  ==12738==     #13 base::RefCountedThreadSafe&lt;appcache::AppCacheStorageImpl::DatabaseTask  base::DefaultRefCountedThreadSafeTraits&lt;appcache::AppCacheStorageImpl::DatabaseTask&gt; &gt;::Release() base/ref_counted.h:140  ==12738==     #14 RunnableMethodTraits&lt;appcache::AppCacheStorageImpl::DatabaseTask&gt;::ReleaseCallee(appcache::AppCacheStorageImpl::DatabaseTask*) base/task.h:245  ==12738==     #15 RunnableMethod&lt;appcache::AppCacheStorageImpl::DatabaseTask  void (appcache::AppCacheStorageImpl::DatabaseTask::*)()  Tuple0&gt;::ReleaseCallee() base/task.h:306  ==12738==     #16 RunnableMethod&lt;appcache::AppCacheStorageImpl::DatabaseTask  void (appcache::AppCacheStorageImpl::DatabaseTask::*)()  Tuple0&gt;::~RunnableMethod() base/task.h:291  ==12738==     #17 MessageLoop::RunTask(Task*) base/message_loop.cc:329    ==12738==     #18 MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;) base/message_loop.cc:336  ==12738==     #19 MessageLoop::DoWork() base/message_loop.cc:443  ==12738==     #20 base::MessagePumpDefault::Run(base::MessagePump::Delegate*) base/message_pump_default.cc:23  ==12738==     #21 MessageLoop::RunInternal() base/message_loop.cc:204     ==12738==     #22 MessageLoop::RunHandler() base/message_loop.cc:176  ==12738==     #23 MessageLoop::Run() base/message_loop.cc:154  ==12738==     #24 base::Thread::Run(MessageLoop*) base/thread.cc:133  ==12738==     #25 base::Thread::ThreadMain() base/thread.cc:157  ==12738==     #26 ThreadFunc(void*) base/platform_thread_posix.cc:28  ==12738==     #27 ThreadSanitizerStartThread ts_valgrind_intercepts.c:571  ==12738==   Concurrent write(s) happened at (OR AFTER) these points:  ==12738==    T1 (AppCacheTest.IOThread) (locks held: {}):  ==12738==     #0  appcache::AppCacheStorage::DelegateReference::CancelReference() webkit/appcache/appcache_storage.h:211  ==12738==     #1  appcache::AppCacheStorage::CancelDelegateCallbacks(appcache::AppCacheStorage::Delegate*) webkit/appcache/appcache_storage.h:144  ==12738==     #2  appcache::AppCacheStorageImplTest::TearDownTest() webkit/appcache/appcache_storage_impl_unittest.cc:239  ==12738==     #3  appcache::AppCacheStorageImplTest::TestFinishedUnwound() webkit/appcache/appcache_storage_impl_unittest.cc:257  ==12738==     #4  void DispatchToMethod&lt;appcache::AppCacheStorageImplTest  void (appcache::AppCacheStorageImplTest::*)()&gt;(appcache::AppCacheStorageImplTest*  void (appcache::AppCacheStorageImplTest::*)()  Tuple0   const&amp;) base/tuple.h:412  ==12738==     #5  RunnableMethod&lt;appcache::AppCacheStorageImplTest  void (appcache::AppCacheStorageImplTest::*)()  Tuple0&gt;::Run() base/task.h:296  ==12738==     #6  MessageLoop::RunTask(Task*) base/message_loop.cc:328    ==12738==     #7  MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;) base/message_loop.cc:336  ==12738==     #8  MessageLoop::DoWork() base/message_loop.cc:443  ==12738==     #9  base::MessagePumpLibevent::Run(base::MessagePump::Delegate*) base/message_pump_libevent.cc:241  ==12738==   Location 0x4156558 is 24 bytes inside a block starting at 0x4156540 of size 40 allocated by T1 from heap:  ==12738==     #0  operator new(unsigned long) ts_valgrind_intercepts.c:407  ==12738==     #1  appcache::AppCacheStorage::GetOrCreateDelegateReference(appcache::AppCacheStorage::Delegate*) webkit/appcache/appcache_storage.h:269  ==12738==     #2  appcache::AppCacheStorageImpl::StoreGroupAndNewestCache(appcache::AppCacheGroup*  appcache::AppCache*  appcache::AppCacheStorage::Delegate*) webkit/appcache/appcache_storage_impl.cc:957  ==12738==     #3  appcache::AppCacheStorageImplTest::StoreNewGroup() webkit/appcache/appcache_storage_impl_unittest.cc:430  ==12738==     #4  appcache::AppCacheStorageImplTest::WrapperTask&lt;void (appcache::AppCacheStorageImplTest::*)()&gt;::RunMethod(appcache::AppCacheStorageImplTest*  void (appcache::AppCacheStorageImplTest::*)())   webkit/appcache/appcache_storage_impl_unittest.cc:187  ==12738==     #5  void DispatchToFunction&lt;void (*)(appcache::AppCacheStorageImplTest*  void (appcache::AppCacheStorageImplTest::*)())  appcache::AppCacheStorageImplTest*  void   (appcache::AppCacheStorageImplTest::*)()&gt;(void (*)(appcache::AppCacheStorageImplTest*  void   (appcache::AppCacheStorageImplTest::*)())  Tuple2&lt;appcache::AppCacheStorageImplTest*  void (appcache::AppCacheStorageImplTest::*)()&gt; const&amp;) base/tuple.h:483  ==12738==     #6  RunnableFunction&lt;void (*)(appcache::AppCacheStorageImplTest*  void (appcache::AppCacheStorageImplTest::*)())  Tuple2&lt;appcache::AppCacheStorageImplTest*  void (appcache::AppCacheStorageImplTest::*)()&gt;   &gt;::Run() base/task.h:407  ==12738==     #7  MessageLoop::RunTask(Task*) base/message_loop.cc:328    ==12738==     #8  MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;) base/message_loop.cc:336  ==12738==     #9  MessageLoop::DoWork() base/message_loop.cc:443  ==12738== }}}     </pre>