<title>Issue 46138 -   chromium -    ThreadSanitizer reports a data race and incorrect locking in YUVConvertTest.YV12 (media_unittests) on Mac OS - Project Hosting on Google Code</title> <pre> E.g. see <a href="http://build.chromium.org/buildbot/memory/builders/Chromium%20Mac%20(tsan)/builds/6509/steps/valgrind%20test:%20media/logs/stdio">http://build.chromium.org/buildbot/memory/builders/Chromium%20Mac%20(tsan)/builds/6509/steps/valgrind%20test:%20media/logs/stdio</a> for the report pasted below.    The two questions are: is GetProcessBundleLocation thread-safe and why does AudioQueueStop acquire a lock every time it is called.    ==45222== WARNING: Possible data race during write of size 1 at 0x1C4FC000: {{{  ==45222==    T0 (locks held: {L180  L180  L180  L222  L244  L261  L574}):  ==45222==     #0  0x1600889D: Replace_memcpy /private/tmp/valgrind.TmOJx3/lib/valgrind/vgpreload_tsan-x86-darwin.so  ==45222==     #1  0x1600B70A: memcpy /private/tmp/valgrind.TmOJx3/lib/valgrind/vgpreload_tsan-x86-darwin.so  ==45222==     #2  0x1899C078: ???//System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/LaunchServices /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/LaunchServices  ==45222==     #3  0x18906009: FlattenedCFItem::Append(void const*  unsigned long) /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/LaunchServices  ==45222==     #4  0x18905985: FlattenedCFItem::Encode(void const*) /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/LaunchServices  ==45222==     #5  0x18905717: FlattenedCFItem::Encode() /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/LaunchServices  ==45222==     #6  0x189047B6: _LSApplicationCheckIn /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/LaunchServices  ==45222==     #7  0x19C2A60F: GetOurExecutableCheckinInformation /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/HIServices  ==45222==     #8  0x19BF7744: _RegisterApplication /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/HIServices  ==45222==     #9  0x19C0B9C4: GetProcessBundleLocation /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/HIServices  ==45222==     #10 0x298615: mac_util::AmIBundled() mac_util.mm:74  ==45222==     #11 0x27DFB7: base::PathProviderMac(int  FilePath*) base_paths_mac.mm:41  ==45222==     #12 0x2A0090: PathService::Get(int  FilePath*) path_service.cc:176  ==45222==     #13 0x118342: YUVConvertTest_YV12_Test::TestBody() yuv_convert_unittest.cc:35  ==45222==     #14 0x2E5177: testing::Test::Run() gtest.cc:2095  ==45222==   Concurrent read(s) happened at (OR AFTER) these points:  ==45222==    T12 (locks held: {}):  ==45222==     #0  0x1706D1F0: __CFRunLoopModeDeallocate /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation  ==45222==     #1  0x17074536: _CFRelease /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation  ==45222==     #2  0x170769D7: __CFSetDeallocate /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation  ==45222==     #3  0x17074536: _CFRelease /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation  ==45222==     #4  0x1706DE31: __CFRunLoopDeallocate /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation  ==45222==     #5  0x17074536: _CFRelease /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation  ==45222==     #6  0x1723AA56: -[NSRunLoop(NSRunLoop) dealloc] /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation  ==45222==     #7  0x17239FB0: __NSFinalizeThreadData /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation  ==45222==     #8  0x17ABE011: _pthread_tsd_cleanup /usr/lib/libSystem.B.dylib  ==45222==     #9  0x17ABDBB0: _pthread_exit /usr/lib/libSystem.B.dylib  ==45222==   Locks involved in this report (reporting last lock sites): {L180  L222  L244  L261  L574}  ==45222==    L180  ==45222==     #0  0x16009236: pthread_mutex_lock /private/tmp/valgrind.TmOJx3/lib/valgrind/vgpreload_tsan-x86-darwin.so  ==45222==     #1  0x161EB40E: CAMutex::Lock() /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==45222==     #2  0x16212E36: IOA_Device::StartCommandExecution(void**) /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==45222==     #3  0x16212CF9: HP_Device::ExecuteCommand(HP_Command*) /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==45222==     #4  0x1621B05C: HP_HardwarePlugIn_DeviceDestroyIOProcID(AudioHardwarePlugInInterface**  unsigned long  long (*)(unsigned long  AudioTimeStamp const*  AudioBufferList const*  AudioTimeStamp const*  AudioBufferList*  AudioTimeStamp const*  void*)) /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==45222==     #5  0x1621AEA9: HALPlugIn::DeviceDestroyIOProcID(HALObject const&amp;  long (*)(unsigned long  AudioTimeStamp const*  AudioBufferList const*  AudioTimeStamp const*  AudioBufferList*  AudioTimeStamp const*  void*)) /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==45222==     #6  0x1621AE6B: HALDevice::DestroyIOProcID(long (*)(unsigned long  AudioTimeStamp const*  AudioBufferList const*  AudioTimeStamp const*  AudioBufferList*  AudioTimeStamp const*  void*)) /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==45222==     #7  0x1621AE00: AudioDeviceDestroyIOProcID /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==45222==     #8  0x70013AA4: AUGenericOutputEntry /System/Library/Components/CoreAudio.component/Contents/MacOS/CoreAudio  ==45222==     #9  0x70014476: AUGenericOutputEntry /System/Library/Components/CoreAudio.component/Contents/MacOS/CoreAudio  ==45222==     #10 0x70040328: SystemOutputAUEntry /System/Library/Components/CoreAudio.component/Contents/MacOS/CoreAudio  ==45222==     #11 0x7003FB1C: SystemOutputAUEntry /System/Library/Components/CoreAudio.component/Contents/MacOS/CoreAudio  ==45222==     #12 0x70014AF9: AUHALEntry /System/Library/Components/CoreAudio.component/Contents/MacOS/CoreAudio  ==45222==     #13 0x17FFE930: CallComponentDispatch /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/CarbonCore.framework/Versions/A/CarbonCore  ==45222==     #14 0x17FFF670: CallComponentClose /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/CarbonCore.framework/Versions/A/CarbonCore  ==45222==     #15 0x17FFF594: CloseComponentInternal(ComponentInstanceRecord*) /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/CarbonCore.framework/Versions/A/CarbonCore  ==45222==     #16 0x17FFF515: CloseComponent /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/CarbonCore.framework/Versions/A/CarbonCore  ==45222==     #17 0x161442FC: AudioComponentInstanceDispose /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #18 0x1611F8DB: AQMEIO_AU::~AQMEIO_AU() /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #19 0x161175EB: AQMEDevice::~AQMEDevice() /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #20 0x16114D11: AQIONodeManager::_ReleaseAQIONode(AQIONode*) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #21 0x161300AA: AudioQueueObject::IONodeConnection::~IONodeConnection() /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #22 0x16131613: AudioQueueObject::DoIONodeConnect(AudioQueueStreamSpecifier const&amp;  AudioStreamBasicDescription const*  AudioChannelLayout const*) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #23 0x1613B870: AudioQueueObject::~AudioQueueObject() /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #24 0x16123F44: AQServer_DisposeQueue /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #25 0x1610E964: AudioQueueDispose /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #26 0x246CDC: PCMQueueOutAudioOutputStream::Close() audio_output_mac.cc:140  ==45222==     #27 0x1837A: MacAudioTest_PCMWaveStreamPendingBytes_Test::TestBody() audio_output_mac_unittest.cc:171  ==45222==     #28 0x2E5177: testing::Test::Run() gtest.cc:2095  ==45222==    L222  ==45222==     #0  0x16009236: pthread_mutex_lock /private/tmp/valgrind.TmOJx3/lib/valgrind/vgpreload_tsan-x86-darwin.so  ==45222==     #1  0x17ABC44E: _pthread_cond_wait /usr/lib/libSystem.B.dylib  ==45222==     #2  0x17ABDB2E: pthread_cond_timedwait_relative_np /usr/lib/libSystem.B.dylib  ==45222==     #3  0x160BC8E9: CAGuard::WaitFor(unsigned long long) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #4  0x1611AB94: AQMEDevice::_RemoveRunningClient(AQIONodeClient*  bool) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #5  0x16120EDB: AQMEDevice::RemoveRunningClient(AQIONodeClient*) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #6  0x1613B445: AudioQueueObject::Stop(bool) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #7  0x16126C5C: AQServer_Stop /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #8  0x1610FC2C: AudioQueueStop /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #9  0x246C5F: PCMQueueOutAudioOutputStream::Stop() audio_output_mac.cc:159  ==45222==     #10 0x18CC7: MacAudioTest_PCMWaveStreamPlay200HzTone44KssMono_Test::TestBody() audio_output_mac_unittest.cc:104  ==45222==     #11 0x2E5177: testing::Test::Run() gtest.cc:2095  ==45222==    L244  ==45222==     #0  0x16009236: pthread_mutex_lock /private/tmp/valgrind.TmOJx3/lib/valgrind/vgpreload_tsan-x86-darwin.so  ==45222==     #1  0x17ABC44E: _pthread_cond_wait /usr/lib/libSystem.B.dylib  ==45222==     #2  0x17ABDB2E: pthread_cond_timedwait_relative_np /usr/lib/libSystem.B.dylib  ==45222==     #3  0x160BC8E9: CAGuard::WaitFor(unsigned long long) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #4  0x1611AB94: AQMEDevice::_RemoveRunningClient(AQIONodeClient*  bool) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #5  0x16120EDB: AQMEDevice::RemoveRunningClient(AQIONodeClient*) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #6  0x1613B445: AudioQueueObject::Stop(bool) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #7  0x16126C5C: AQServer_Stop /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #8  0x1610FC2C: AudioQueueStop /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #9  0x246C5F: PCMQueueOutAudioOutputStream::Stop() audio_output_mac.cc:159  ==45222==     #10 0x18760: MacAudioTest_PCMWaveStreamPlay200HzTone22KssMono_Test::TestBody() audio_output_mac_unittest.cc:129  ==45222==     #11 0x2E5177: testing::Test::Run() gtest.cc:2095  ==45222==    L261  ==45222==     #0  0x16009236: pthread_mutex_lock /private/tmp/valgrind.TmOJx3/lib/valgrind/vgpreload_tsan-x86-darwin.so  ==45222==     #1  0x17ABC44E: _pthread_cond_wait /usr/lib/libSystem.B.dylib  ==45222==     #2  0x17ABDB2E: pthread_cond_timedwait_relative_np /usr/lib/libSystem.B.dylib  ==45222==     #3  0x160BC8E9: CAGuard::WaitFor(unsigned long long) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #4  0x1611AB94: AQMEDevice::_RemoveRunningClient(AQIONodeClient*  bool) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #5  0x16120EDB: AQMEDevice::RemoveRunningClient(AQIONodeClient*) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #6  0x1613B445: AudioQueueObject::Stop(bool) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #7  0x16126C5C: AQServer_Stop /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #8  0x1610FC2C: AudioQueueStop /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==45222==     #9  0x246C5F: PCMQueueOutAudioOutputStream::Stop() audio_output_mac.cc:159  ==45222==     #10 0x1836C: MacAudioTest_PCMWaveStreamPendingBytes_Test::TestBody() audio_output_mac_unittest.cc:170  ==45222==     #11 0x2E5177: testing::Test::Run() gtest.cc:2095  ==45222==    L574  ==45222==     #0  0x16009236: pthread_mutex_lock /private/tmp/valgrind.TmOJx3/lib/valgrind/vgpreload_tsan-x86-darwin.so  ==45222==     #1  0x19C4D0D3: ???//System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/HIServices /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/HIServices  ==45222==     #2  0x19BF7737: _RegisterApplication /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/HIServices  ==45222==     #3  0x19C0B9C4: GetProcessBundleLocation /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/HIServices  ==45222==     #4  0x298615: mac_util::AmIBundled() mac_util.mm:74  ==45222==     #5  0x27DFB7: base::PathProviderMac(int  FilePath*) base_paths_mac.mm:41  ==45222==     #6  0x2A0090: PathService::Get(int  FilePath*) path_service.cc:176  ==45222==     #7  0x118342: YUVConvertTest_YV12_Test::TestBody() yuv_convert_unittest.cc:35  ==45222==     #8  0x2E5177: testing::Test::Run() gtest.cc:2095  ==45222==    Race verifier data: 0x1600889D 0x1706D1F0  ==45222== }}} </pre>