<title>Issue 44667 -   chromium -    Memory leak in VideoCoderImpl::DoInitialize - Project Hosting on Google Code</title> <pre> A NewCallback is called but the callback is never destroyed. This was   introduced in <a href="/p/chromium/source/detail?r=47802">r47802</a>.     relevant valgrind output from   <a href="http://build.chromium.org/buildbot/memory/builders/Linux%20Tests%20(valgrin">http://build.chromium.org/buildbot/memory/builders/Linux%20Tests%20(valgrin</a>  d)(4)/builds/5699/steps/valgrind%20test:%20media/logs/stdio      0:26:42 memcheck_analyze.py [ERROR] Leak_DefinitelyLost  Command: src/sconsbuild/Release/media_unittests --gtest_print_time  16 bytes in 1 blocks are definitely lost in loss record 390 of 747    operator new(unsigned int) (mp/scripts/valgrind-  memcheck/coregrind/m_replacemalloc/vg_replace_malloc.c:269)    Callback1&lt;scoped_refptr&lt;media::VideoFrame&gt; &gt;::Type*   NewCallback&lt;media::VideoDecoderImpl  scoped_refptr&lt;media::VideoFrame&gt;   &gt;(media::VideoDecoderImpl*  void   (media::VideoDecoderImpl::*)(scoped_refptr&lt;media::VideoFrame&gt;))   (uilder/build/src/./base/callback.h:141)    media::VideoDecoderImpl::DoInitialize(media::DemuxerStream*  bool*    Task*) (uilder/build/src/media/filters/video_decoder_impl.cc:69)    media::DecoderBase&lt;media::VideoDecoder    media::VideoFrame&gt;::InitializeTask(media::DemuxerStream*    CallbackRunner&lt;Tuple0&gt;*)   (uilder/build/src/./media/filters/decoder_base.h:195)    void DispatchToMethod&lt;media::DecoderBase&lt;media::VideoDecoder    media::VideoFrame&gt;  void (media::DecoderBase&lt;media::VideoDecoder    media::VideoFrame&gt;::*)(media::DemuxerStream*  CallbackRunner&lt;Tuple0&gt;*)    media::DemuxerStream*    CallbackRunner&lt;Tuple0&gt;*&gt;(media::DecoderBase&lt;media::VideoDecoder    media::VideoFrame&gt;*  void (media::DecoderBase&lt;media::VideoDecoder    media::VideoFrame&gt;::*)(media::DemuxerStream*  CallbackRunner&lt;Tuple0&gt;*)    Tuple2&lt;media::DemuxerStream*  CallbackRunner&lt;Tuple0&gt;*&gt; const&amp;)   (uilder/build/src/./base/tuple.h:429)    RunnableMethod&lt;media::DecoderBase&lt;media::VideoDecoder    media::VideoFrame&gt;  void (media::DecoderBase&lt;media::VideoDecoder    media::VideoFrame&gt;::*)(media::DemuxerStream*  CallbackRunner&lt;Tuple0&gt;*)    Tuple2&lt;media::DemuxerStream*  CallbackRunner&lt;Tuple0&gt;*&gt; &gt;::Run()   (uilder/build/src/./base/task.h:296)    MessageLoop::RunTask(Task*) (uilder/build/src/base/message_loop.cc:328)    MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;)   (uilder/build/src/base/message_loop.cc:336)    MessageLoop::DoWork() (uilder/build/src/base/message_loop.cc:443)    base::MessagePumpDefault::Run(base::MessagePump::Delegate*)   (uilder/build/src/base/message_pump_default.cc:23)    MessageLoop::RunInternal() (uilder/build/src/base/message_loop.cc:204)    MessageLoop::RunHandler() (uilder/build/src/base/message_loop.cc:176)    MessageLoop::RunAllPending() (uilder/build/src/base/message_loop.cc:160)    media::VideoDecoderImplTest_Initialize_Successful_Test::TestBody()   (uilder/build/src/media/filters/video_decoder_impl_unittest.cc:248)    testing::Test::Run() (uilder/build/src/testing/gtest/src/gtest.cc:2095)    testing::internal::TestInfoImpl::Run()   (uilder/build/src/testing/gtest/src/gtest.cc:2314)    testing::TestCase::Run()   (uilder/build/src/testing/gtest/src/gtest.cc:2420)    testing::internal::UnitTestImpl::RunAllTests()   (uilder/build/src/testing/gtest/src/gtest.cc:4024)    testing::UnitTest::Run()   (uilder/build/src/testing/gtest/src/gtest.cc:3687)    TestSuite::Run() (uilder/build/src/./base/test/test_suite.h:131)    main (uilder/build/src/media/base/run_all_unittests.cc:8)  Suppression:  {     &lt;insert_a_suppression_name_here&gt;     Memcheck:Leak     fun:_Znw*       fun:_Z11NewCallbackIN5media16VideoDecoderImplE13scoped_refptrINS0_10VideoFr  ameEEEPN9Callback1IT0_E4TypeEPT_MSA_FvS6_E       fun:_ZN5media16VideoDecoderImpl12DoInitializeEPNS_13DemuxerStreamEPbP4Task       fun:_ZN5media11DecoderBaseINS_12VideoDecoderENS_10VideoFrameEE14InitializeT  askEPNS_13DemuxerStreamEP14CallbackRunnerI6Tuple0E       fun:_Z16DispatchToMethodIN5media11DecoderBaseINS0_12VideoDecoderENS0_10Vide  oFrameEEEMS4_FvPNS0_13DemuxerStreamEP14CallbackRunnerI6Tuple0EES6_SA_EvPT_T  0_RK6Tuple2IT1_T2_E       fun:_ZN14RunnableMethodIN5media11DecoderBaseINS0_12VideoDecoderENS0_10Video  FrameEEEMS4_FvPNS0_13DemuxerStreamEP14CallbackRunnerI6Tuple0EE6Tuple2IS6_SA  _EE3RunEv     fun:_ZN11MessageLoop7RunTaskEP4Task     fun:_ZN11MessageLoop21DeferOrRunPendingTaskERKNS_11PendingTaskE     fun:_ZN11MessageLoop6DoWorkEv     fun:_ZN4base18MessagePumpDefault3RunEPNS_11MessagePump8DelegateE     fun:_ZN11MessageLoop11RunInternalEv     fun:_ZN11MessageLoop10RunHandlerEv     fun:_ZN11MessageLoop13RunAllPendingEv       fun:_ZN5media47VideoDecoderImplTest_Initialize_Successful_Test8TestBodyEv     fun:_ZN7testing4Test3RunEv     fun:_ZN7testing8internal12TestInfoImpl3RunEv     fun:_ZN7testing8TestCase3RunEv     fun:_ZN7testing8internal12UnitTestImpl11RunAllTestsEv     fun:_ZN7testing8UnitTest3RunEv     fun:_ZN9TestSuite3RunEv     fun:main  }  }    10:26:42 memcheck_analyze.py [ERROR] Leak_DefinitelyLost  Command: src/sconsbuild/Release/media_unittests --gtest_print_time  16 bytes in 1 blocks are definitely lost in loss record 389 of 747    operator new(unsigned int) (mp/scripts/valgrind-  memcheck/coregrind/m_replacemalloc/vg_replace_malloc.c:269)    Callback1&lt;scoped_refptr&lt;media::VideoFrame&gt; &gt;::Type*   NewCallback&lt;media::VideoDecoderImpl  scoped_refptr&lt;media::VideoFrame&gt;   &gt;(media::VideoDecoderImpl*  void   (media::VideoDecoderImpl::*)(scoped_refptr&lt;media::VideoFrame&gt;))   (uilder/build/src/./base/callback.h:141)    media::VideoDecoderImpl::DoInitialize(media::DemuxerStream*  bool*    Task*) (uilder/build/src/media/filters/video_decoder_impl.cc:69)    media::DecoderBase&lt;media::VideoDecoder    media::VideoFrame&gt;::InitializeTask(media::DemuxerStream*    CallbackRunner&lt;Tuple0&gt;*)   (uilder/build/src/./media/filters/decoder_base.h:195)    void DispatchToMethod&lt;media::DecoderBase&lt;media::VideoDecoder    media::VideoFrame&gt;  void (media::DecoderBase&lt;media::VideoDecoder    media::VideoFrame&gt;::*)(media::DemuxerStream*  CallbackRunner&lt;Tuple0&gt;*)    media::DemuxerStream*    CallbackRunner&lt;Tuple0&gt;*&gt;(media::DecoderBase&lt;media::VideoDecoder    media::VideoFrame&gt;*  void (media::DecoderBase&lt;media::VideoDecoder    media::VideoFrame&gt;::*)(media::DemuxerStream*  CallbackRunner&lt;Tuple0&gt;*)    Tuple2&lt;media::DemuxerStream*  CallbackRunner&lt;Tuple0&gt;*&gt; const&amp;)   (uilder/build/src/./base/tuple.h:429)    RunnableMethod&lt;media::DecoderBase&lt;media::VideoDecoder    media::VideoFrame&gt;  void (media::DecoderBase&lt;media::VideoDecoder    media::VideoFrame&gt;::*)(media::DemuxerStream*  CallbackRunner&lt;Tuple0&gt;*)    Tuple2&lt;media::DemuxerStream*  CallbackRunner&lt;Tuple0&gt;*&gt; &gt;::Run()   (uilder/build/src/./base/task.h:296)    MessageLoop::RunTask(Task*) (uilder/build/src/base/message_loop.cc:328)    MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;)   (uilder/build/src/base/message_loop.cc:336)    MessageLoop::DoWork() (uilder/build/src/base/message_loop.cc:443)    base::MessagePumpDefault::Run(base::MessagePump::Delegate*)   (uilder/build/src/base/message_pump_default.cc:23)    MessageLoop::RunInternal() (uilder/build/src/base/message_loop.cc:204)    MessageLoop::RunHandler() (uilder/build/src/base/message_loop.cc:176)    MessageLoop::RunAllPending() (uilder/build/src/base/message_loop.cc:160)    media::VideoDecoderImplTest_Initialize_EngineFails_Test::TestBody()   (uilder/build/src/media/filters/video_decoder_impl_unittest.cc:228)    testing::Test::Run() (uilder/build/src/testing/gtest/src/gtest.cc:2095)    testing::internal::TestInfoImpl::Run()   (uilder/build/src/testing/gtest/src/gtest.cc:2314)    testing::TestCase::Run()   (uilder/build/src/testing/gtest/src/gtest.cc:2420)    testing::internal::UnitTestImpl::RunAllTests()   (uilder/build/src/testing/gtest/src/gtest.cc:4024)    testing::UnitTest::Run()   (uilder/build/src/testing/gtest/src/gtest.cc:3687)    TestSuite::Run() (uilder/build/src/./base/test/test_suite.h:131)    main (uilder/build/src/media/base/run_all_unittests.cc:8)  Suppression:  {     &lt;insert_a_suppression_name_here&gt;     Memcheck:Leak     fun:_Znw*       fun:_Z11NewCallbackIN5media16VideoDecoderImplE13scoped_refptrINS0_10VideoFr  ameEEEPN9Callback1IT0_E4TypeEPT_MSA_FvS6_E       fun:_ZN5media16VideoDecoderImpl12DoInitializeEPNS_13DemuxerStreamEPbP4Task       fun:_ZN5media11DecoderBaseINS_12VideoDecoderENS_10VideoFrameEE14InitializeT  askEPNS_13DemuxerStreamEP14CallbackRunnerI6Tuple0E       fun:_Z16DispatchToMethodIN5media11DecoderBaseINS0_12VideoDecoderENS0_10Vide  oFrameEEEMS4_FvPNS0_13DemuxerStreamEP14CallbackRunnerI6Tuple0EES6_SA_EvPT_T  0_RK6Tuple2IT1_T2_E       fun:_ZN14RunnableMethodIN5media11DecoderBaseINS0_12VideoDecoderENS0_10Video  FrameEEEMS4_FvPNS0_13DemuxerStreamEP14CallbackRunnerI6Tuple0EE6Tuple2IS6_SA  _EE3RunEv     fun:_ZN11MessageLoop7RunTaskEP4Task     fun:_ZN11MessageLoop21DeferOrRunPendingTaskERKNS_11PendingTaskE     fun:_ZN11MessageLoop6DoWorkEv     fun:_ZN4base18MessagePumpDefault3RunEPNS_11MessagePump8DelegateE     fun:_ZN11MessageLoop11RunInternalEv     fun:_ZN11MessageLoop10RunHandlerEv     fun:_ZN11MessageLoop13RunAllPendingEv       fun:_ZN5media48VideoDecoderImplTest_Initialize_EngineFails_Test8TestBodyEv     fun:_ZN7testing4Test3RunEv     fun:_ZN7testing8internal12TestInfoImpl3RunEv     fun:_ZN7testing8TestCase3RunEv     fun:_ZN7testing8internal12UnitTestImpl11RunAllTestsEv     fun:_ZN7testing8UnitTest3RunEv     fun:_ZN9TestSuite3RunEv     fun:main  } </pre>