<title>Issue 46086 -   chromium -    possible data race in YUVConvertTest - Project Hosting on Google Code</title> <pre> Chromium Mac (tsan) ever few runs trips up on the media test with:      ==42382== INFO: T12 has been created by T0 at this point: {{{  ==42382==     #0  0x17A8AAD4: _sysenter_trap /usr/lib/libSystem.B.dylib  ==42382==     #1  0x17ABAFD9: __bsdthread_create /usr/lib/libSystem.B.dylib  ==42382==     #2  0x17ABAED2: pthread_create /usr/lib/libSystem.B.dylib  ==42382==     #3  0x1600CC06: pthread_create /private/tmp/valgrind.6np4Hj/lib/valgrind/vgpreload_tsan-x86-darwin.so  ==42382==     #4  0x174EFDEC: ???//System/Library/Frameworks/Foundation.framework/Versions/C/Foundation /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation  ==42382==     #5  0x17234354: -[NSThread start] /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation  ==42382==     #6  0x2A5305: base::InitThreading() platform_thread_mac.mm:41  ==42382==     #7  0x2A53D5: (anonymous namespace)::CreateThread(unsigned long  bool  PlatformThread::Delegate*  _opaque_pthread_t**) platform_thread_posix.cc:82  ==42382==     #8  0x2A5505: PlatformThread::Create(unsigned long  PlatformThread::Delegate*  _opaque_pthread_t**) platform_thread_posix.cc:141  ==42382==     #9  0x2BD06F: base::Thread::StartWithOptions(base::Thread::Options const&amp;) thread.cc:86  ==42382==     #10 0x2BD170: base::Thread::Start() thread.cc:75  ==42382==     #11 0x2540DF: void media::PipelineImpl::CreateFilter&lt;media::Demuxer  media::DataSource*&gt;(media::FilterFactory*  media::DataSource*  media::MediaFormat const&amp;) pipeline_impl.cc:914  ==42382==     #12 0x254459: void media::PipelineImpl::CreateFilter&lt;media::Demuxer  media::DataSource&gt;(media::FilterFactory*  media::DataSource*) pipeline_impl.h:266  ==42382==     #13 0x24A82D: media::PipelineImpl::CreateDemuxer() pipeline_impl.cc:954  ==42382==     #14 0x24CE76: media::PipelineImpl::InitializeTask() pipeline_impl.cc:568  ==42382==     #15 0x24F4A0: void DispatchToMethod&lt;media::PipelineImpl  void (media::PipelineImpl::*)()&gt;(media::PipelineImpl*  void (media::PipelineImpl::*)()  Tuple0 const&amp;) tuple.h:412  ==42382==     #16 0x24F4D0: RunnableMethod&lt;media::PipelineImpl  void (media::PipelineImpl::*)()  Tuple0&gt;::Run() task.h:296  ==42382==     #17 0x299975: MessageLoop::RunTask(Task*) message_loop.cc:328  ==42382==     #18 0x299EEE: MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;) message_loop.cc:336  ==42382==     #19 0x29A11F: MessageLoop::DoWork() message_loop.cc:443  ==42382==     #20 0x29F455: base::MessagePumpDefault::Run(base::MessagePump::Delegate*) message_pump_default.cc:23  ==42382==     #21 0x29A6E6: MessageLoop::RunInternal() message_loop.cc:204  ==42382==     #22 0x29A700: MessageLoop::RunHandler() message_loop.cc:176  ==42382==     #23 0x29A733: MessageLoop::RunAllPending() message_loop.cc:160  ==42382==     #24 0xEB89D: media::PipelineImplTest::InitializePipeline() pipeline_impl_unittest.cc:206  ==42382==     #25 0x9B745: media::PipelineImplTest_NoStreams_Test::TestBody() pipeline_impl_unittest.cc:360  ==42382==     #26 0x2E5177: testing::Test::Run() gtest.cc:2095  ==42382== }}}  ==42382== INFO: T0 is program's main thread  ==42382== WARNING: Possible data race during write of size 1 at 0x1C4FC000: {{{  ==42382==    T0 (locks held: {L180  L180  L180  L222  L244  L261  L590}):  ==42382==     #0  0x1600889D: Replace_memcpy /private/tmp/valgrind.6np4Hj/lib/valgrind/vgpreload_tsan-x86-darwin.so  ==42382==     #1  0x1600B70A: memcpy /private/tmp/valgrind.6np4Hj/lib/valgrind/vgpreload_tsan-x86-darwin.so  ==42382==     #2  0x1899C078: ???//System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/LaunchServices /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/LaunchServices  ==42382==     #3  0x18906009: FlattenedCFItem::Append(void const*  unsigned long) /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/LaunchServices  ==42382==     #4  0x18905985: FlattenedCFItem::Encode(void const*) /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/LaunchServices  ==42382==     #5  0x18905717: FlattenedCFItem::Encode() /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/LaunchServices  ==42382==     #6  0x189047B6: _LSApplicationCheckIn /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/LaunchServices  ==42382==     #7  0x19C2A60F: GetOurExecutableCheckinInformation /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/HIServices  ==42382==     #8  0x19BF7744: _RegisterApplication /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/HIServices  ==42382==     #9  0x19C0B9C4: GetProcessBundleLocation /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/HIServices  ==42382==     #10 0x298615: mac_util::AmIBundled() mac_util.mm:74  ==42382==     #11 0x27DFB7: base::PathProviderMac(int  FilePath*) base_paths_mac.mm:41  ==42382==     #12 0x2A0090: PathService::Get(int  FilePath*) path_service.cc:176  ==42382==     #13 0x118342: YUVConvertTest_YV12_Test::TestBody() yuv_convert_unittest.cc:35  ==42382==     #14 0x2E5177: testing::Test::Run() gtest.cc:2095  ==42382==   Concurrent read(s) happened at (OR AFTER) these points:  ==42382==    T12 (locks held: {}):  ==42382==     #0  0x1706D1F0: __CFRunLoopModeDeallocate /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation  ==42382==     #1  0x17074536: _CFRelease /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation  ==42382==     #2  0x170769D7: __CFSetDeallocate /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation  ==42382==     #3  0x17074536: _CFRelease /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation  ==42382==     #4  0x1706DE31: __CFRunLoopDeallocate /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation  ==42382==     #5  0x17074536: _CFRelease /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation  ==42382==     #6  0x1723AA56: -[NSRunLoop(NSRunLoop) dealloc] /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation  ==42382==     #7  0x17239FB0: __NSFinalizeThreadData /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation  ==42382==     #8  0x17ABE011: _pthread_tsd_cleanup /usr/lib/libSystem.B.dylib  ==42382==     #9  0x17ABDBB0: _pthread_exit /usr/lib/libSystem.B.dylib  ==42382==   Locks involved in this report (reporting last lock sites): {L180  L222  L244  L261  L590}  ==42382==    L180  ==42382==     #0  0x16009236: pthread_mutex_lock /private/tmp/valgrind.6np4Hj/lib/valgrind/vgpreload_tsan-x86-darwin.so  ==42382==     #1  0x161EB40E: CAMutex::Lock() /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==42382==     #2  0x16212E36: IOA_Device::StartCommandExecution(void**) /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==42382==     #3  0x16212CF9: HP_Device::ExecuteCommand(HP_Command*) /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==42382==     #4  0x1621B05C: HP_HardwarePlugIn_DeviceDestroyIOProcID(AudioHardwarePlugInInterface**  unsigned long  long (*)(unsigned long  AudioTimeStamp const*  AudioBufferList const*  AudioTimeStamp const*  AudioBufferList*  AudioTimeStamp const*  void*)) /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==42382==     #5  0x1621AEA9: HALPlugIn::DeviceDestroyIOProcID(HALObject const&amp;  long (*)(unsigned long  AudioTimeStamp const*  AudioBufferList const*  AudioTimeStamp const*  AudioBufferList*  AudioTimeStamp const*  void*)) /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==42382==     #6  0x1621AE6B: HALDevice::DestroyIOProcID(long (*)(unsigned long  AudioTimeStamp const*  AudioBufferList const*  AudioTimeStamp const*  AudioBufferList*  AudioTimeStamp const*  void*)) /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==42382==     #7  0x1621AE00: AudioDeviceDestroyIOProcID /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==42382==     #8  0x70013AA4: AUGenericOutputEntry /System/Library/Components/CoreAudio.component/Contents/MacOS/CoreAudio  ==42382==     #9  0x70014476: AUGenericOutputEntry /System/Library/Components/CoreAudio.component/Contents/MacOS/CoreAudio  ==42382==     #10 0x70040328: SystemOutputAUEntry /System/Library/Components/CoreAudio.component/Contents/MacOS/CoreAudio  ==42382==     #11 0x7003FB1C: SystemOutputAUEntry /System/Library/Components/CoreAudio.component/Contents/MacOS/CoreAudio  ==42382==     #12 0x70014AF9: AUHALEntry /System/Library/Components/CoreAudio.component/Contents/MacOS/CoreAudio  ==42382==     #13 0x17FFE930: CallComponentDispatch /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/CarbonCore.framework/Versions/A/CarbonCore  ==42382==     #14 0x17FFF670: CallComponentClose /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/CarbonCore.framework/Versions/A/CarbonCore  ==42382==     #15 0x17FFF594: CloseComponentInternal(ComponentInstanceRecord*) /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/CarbonCore.framework/Versions/A/CarbonCore  ==42382==     #16 0x17FFF515: CloseComponent /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/CarbonCore.framework/Versions/A/CarbonCore  ==42382==     #17 0x161442FC: AudioComponentInstanceDispose /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #18 0x1611F8DB: AQMEIO_AU::~AQMEIO_AU() /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #19 0x161175EB: AQMEDevice::~AQMEDevice() /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #20 0x16114D11: AQIONodeManager::_ReleaseAQIONode(AQIONode*) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #21 0x161300AA: AudioQueueObject::IONodeConnection::~IONodeConnection() /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #22 0x16131613: AudioQueueObject::DoIONodeConnect(AudioQueueStreamSpecifier const&amp;  AudioStreamBasicDescription const*  AudioChannelLayout const*) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #23 0x1613B870: AudioQueueObject::~AudioQueueObject() /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #24 0x16123F44: AQServer_DisposeQueue /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #25 0x1610E964: AudioQueueDispose /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #26 0x246CDC: PCMQueueOutAudioOutputStream::Close() audio_output_mac.cc:140  ==42382==     #27 0x1837A: MacAudioTest_PCMWaveStreamPendingBytes_Test::TestBody() audio_output_mac_unittest.cc:171  ==42382==     #28 0x2E5177: testing::Test::Run() gtest.cc:2095  ==42382==    L222  ==42382==     #0  0x16009236: pthread_mutex_lock /private/tmp/valgrind.6np4Hj/lib/valgrind/vgpreload_tsan-x86-darwin.so  ==42382==     #1  0x17ABC44E: _pthread_cond_wait /usr/lib/libSystem.B.dylib  ==42382==     #2  0x17ABDB2E: pthread_cond_timedwait_relative_np /usr/lib/libSystem.B.dylib  ==42382==     #3  0x160BC8E9: CAGuard::WaitFor(unsigned long long) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #4  0x1611AB94: AQMEDevice::_RemoveRunningClient(AQIONodeClient*  bool) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #5  0x16120EDB: AQMEDevice::RemoveRunningClient(AQIONodeClient*) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #6  0x1613B445: AudioQueueObject::Stop(bool) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #7  0x16126C5C: AQServer_Stop /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #8  0x1610FC2C: AudioQueueStop /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #9  0x246C5F: PCMQueueOutAudioOutputStream::Stop() audio_output_mac.cc:159  ==42382==     #10 0x18CC7: MacAudioTest_PCMWaveStreamPlay200HzTone44KssMono_Test::TestBody() audio_output_mac_unittest.cc:104  ==42382==     #11 0x2E5177: testing::Test::Run() gtest.cc:2095  ==42382==    L244  ==42382==     #0  0x16009236: pthread_mutex_lock /private/tmp/valgrind.6np4Hj/lib/valgrind/vgpreload_tsan-x86-darwin.so  ==42382==     #1  0x17ABC44E: _pthread_cond_wait /usr/lib/libSystem.B.dylib  ==42382==     #2  0x17ABDB2E: pthread_cond_timedwait_relative_np /usr/lib/libSystem.B.dylib  ==42382==     #3  0x160BC8E9: CAGuard::WaitFor(unsigned long long) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #4  0x1611AB94: AQMEDevice::_RemoveRunningClient(AQIONodeClient*  bool) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #5  0x16120EDB: AQMEDevice::RemoveRunningClient(AQIONodeClient*) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #6  0x1613B445: AudioQueueObject::Stop(bool) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #7  0x16126C5C: AQServer_Stop /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #8  0x1610FC2C: AudioQueueStop /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #9  0x246C5F: PCMQueueOutAudioOutputStream::Stop() audio_output_mac.cc:159  ==42382==     #10 0x18760: MacAudioTest_PCMWaveStreamPlay200HzTone22KssMono_Test::TestBody() audio_output_mac_unittest.cc:129  ==42382==     #11 0x2E5177: testing::Test::Run() gtest.cc:2095  ==42382==    L261  ==42382==     #0  0x16009236: pthread_mutex_lock /private/tmp/valgrind.6np4Hj/lib/valgrind/vgpreload_tsan-x86-darwin.so  ==42382==     #1  0x17ABC44E: _pthread_cond_wait /usr/lib/libSystem.B.dylib  ==42382==     #2  0x17ABDB2E: pthread_cond_timedwait_relative_np /usr/lib/libSystem.B.dylib  ==42382==     #3  0x160BC8E9: CAGuard::WaitFor(unsigned long long) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #4  0x1611AB94: AQMEDevice::_RemoveRunningClient(AQIONodeClient*  bool) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #5  0x16120EDB: AQMEDevice::RemoveRunningClient(AQIONodeClient*) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #6  0x1613B445: AudioQueueObject::Stop(bool) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #7  0x16126C5C: AQServer_Stop /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #8  0x1610FC2C: AudioQueueStop /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==42382==     #9  0x246C5F: PCMQueueOutAudioOutputStream::Stop() audio_output_mac.cc:159  ==42382==     #10 0x1836C: MacAudioTest_PCMWaveStreamPendingBytes_Test::TestBody() audio_output_mac_unittest.cc:170  ==42382==     #11 0x2E5177: testing::Test::Run() gtest.cc:2095  ==42382==    L590  ==42382==     #0  0x16009236: pthread_mutex_lock /private/tmp/valgrind.6np4Hj/lib/valgrind/vgpreload_tsan-x86-darwin.so  ==42382==     #1  0x19C4D0D3: ???//System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/HIServices /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/HIServices  ==42382==     #2  0x19BF7737: _RegisterApplication /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/HIServices  ==42382==     #3  0x19C0B9C4: GetProcessBundleLocation /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/HIServices  ==42382==     #4  0x298615: mac_util::AmIBundled() mac_util.mm:74  ==42382==     #5  0x27DFB7: base::PathProviderMac(int  FilePath*) base_paths_mac.mm:41  ==42382==     #6  0x2A0090: PathService::Get(int  FilePath*) path_service.cc:176  ==42382==     #7  0x118342: YUVConvertTest_YV12_Test::TestBody() yuv_convert_unittest.cc:35  ==42382==     #8  0x2E5177: testing::Test::Run() gtest.cc:2095  ==42382==    Race verifier data: 0x1600889D 0x1706D1F0  ==42382== }}}   </pre>