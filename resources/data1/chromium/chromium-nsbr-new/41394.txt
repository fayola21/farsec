<title>Issue 41394 -   chromium -    SpdySession deletes while reads or writes are in progress  leaving a reference to a CallbackHandler. - Project Hosting on Google Code</title> <pre> Chrome Version       : trunk    Other browsers tested: n/a                  This failure is visible in net_unittests  run SpdyNetworkTransactionTest.WriteError.  Watch for the   deletion of the Callback allocated in the SpdySession read_callback.  The OnWriteComplete errors   out  calls CloseSessionOnError  and the SpdySession is removed from the session_pool and   delete.    Not much later  the socket read completes  and net::DelayedSocketData::CompleteRead triggers a   chain of calls that eventually reference the deleted read_callback.  Not cool.    On my machine  the result was a pure virtual method called  stack looked like:    #0  0x91625e42 in __kill ()  #1  0x91625e34 in kill$UNIX2003 ()  #2  0x9169823a in raise ()  #3  0x916a4679 in abort ()  #4  0x9409f005 in __gnu_cxx::__verbose_terminate_handler ()  #5  0x9409d10c in __gxx_personality_v0 ()  #6  0x9409d14b in std::terminate ()  #7  0x9409d6da in __cxa_pure_virtual ()  #8  0x000d47a6 in CallbackRunner&lt;Tuple1&lt;int&gt; &gt;::Run&lt;int&gt; (this=0x225f0e8    a=@0xbfffe4d8) at callback.h:94  #9  0x0045dc4c in net::MockClientSocket::RunCallback (this=0x225f510  callback=0x225f0e8    result=77) at /Users/gavinp/chrome-work/home/chrome-  svn/tarball/chromium/src/net/socket/socket_test_util.cc:68  #10 0x0045fc6c in net::MockTCPClientSocket::OnReadComplete (this=0x225f510    data=@0xbfffe764) at /Users/gavinp/chrome-work/home/chrome-  svn/tarball/chromium/src/net/socket/socket_test_util.cc:170  #11 0x002dbe2e in net::DelayedSocketData::CompleteRead (this=0x225e620) at   /Users/gavinp/chrome-work/home/chrome-  svn/tarball/chromium/src/net/spdy/spdy_network_transaction_unittest.cc:649  #12 0x002dc9d6 in DispatchToMethod&lt;net::DelayedSocketData  void   (net::DelayedSocketData::*)()&gt; (obj=0x225e620  method={__pfn = 0x2dbdd6   &lt;net::DelayedSocketData::CompleteRead()&gt;  __delta = 0}  arg=@0x225f2e0) at tuple.h:412  #13 0x002dca29 in   ScopedRunnableMethodFactory&lt;net::DelayedSocketData&gt;::RunnableMethod&lt;void   (net::DelayedSocketData::*)()  Tuple0&gt;::Run (this=0x225f2c0) at task.h:153  #14 0x004a1306 in MessageLoop::RunTask (this=0x225e210  task=0x225f2c0) at   /Users/gavinp/chrome-work/home/chrome-  svn/tarball/chromium/src/base/message_loop.cc:329  #15 0x004a19eb in MessageLoop::DeferOrRunPendingTask (this=0x225e210    pending_task=@0xbfffe924) at /Users/gavinp/chrome-work/home/chrome-  svn/tarball/chromium/src/base/message_loop.cc:337  #16 0x004a1b6e in MessageLoop::DoDelayedWork (this=0x225e210    next_delayed_work_time=0x225e18c) at /Users/gavinp/chrome-work/home/chrome-  svn/tarball/chromium/src/base/message_loop.cc:471  #17 0x0046f828 in base::MessagePumpLibevent::Run (this=0x225e180  delegate=0x225e210)   at /Users/gavinp/chrome-work/home/chrome-  svn/tarball/chromium/src/base/message_pump_libevent.cc:245  #18 0x004a23f2 in MessageLoop::RunInternal (this=0x225e210) at /Users/gavinp/chrome-  work/home/chrome-svn/tarball/chromium/src/base/message_loop.cc:205  #19 0x004a240d in MessageLoop::RunHandler (this=0x225e210) at /Users/gavinp/chrome-  work/home/chrome-svn/tarball/chromium/src/base/message_loop.cc:177  #20 0x004a2471 in MessageLoop::Run (this=0x225e210) at /Users/gavinp/chrome-  work/home/chrome-svn/tarball/chromium/src/base/message_loop.cc:155  #21 0x0004c8dd in TestCompletionCallback::WaitForResult (this=0xbfffed70) at   test_completion_callback.h:36  #22 0x002cca3c in net::SpdyNetworkTransactionTest::TransactionHelperWithSession   (this=0x225e200  request=@0xbffff01c  data=0x225e620  log=@0xbffff218    session_deps=0xbfffef90  session=0x225ebb0) at /Users/gavinp/chrome-work/home/chrome-  svn/tarball/chromium/src/net/spdy/spdy_network_transaction_unittest.cc:837  #23 0x002e11a3 in net::SpdyNetworkTransactionTest::TransactionHelper (this=0x225e200    request=@0xbffff01c  data=0x225e620  log=@0xbffff218) at /Users/gavinp/chrome-  work/home/chrome-  svn/tarball/chromium/src/net/spdy/spdy_network_transaction_unittest.cc:810  #24 0x002d709a in net::SpdyNetworkTransactionTest_WriteError_Test::TestBody   (this=0x225e200) at /Users/gavinp/chrome-work/home/chrome-  svn/tarball/chromium/src/net/spdy/spdy_network_transaction_unittest.cc:1796  #25 0x004f8888 in testing::Test::Run (this=0x225e200) at /Users/gavinp/chrome-  work/home/chrome-svn/tarball/chromium/src/testing/gtest/src/gtest.cc:2095  #26 0x004fc841 in testing::internal::TestInfoImpl::Run (this=0x2254410) at   /Users/gavinp/chrome-work/home/chrome-  svn/tarball/chromium/src/testing/gtest/src/gtest.cc:2314  #27 0x004fc984 in testing::TestCase::Run (this=0x22538a0) at /Users/gavinp/chrome-  work/home/chrome-svn/tarball/chromium/src/testing/gtest/src/gtest.cc:2420  #28 0x004fd5c0 in testing::internal::UnitTestImpl::RunAllTests (this=0x2209910) at   /Users/gavinp/chrome-work/home/chrome-  svn/tarball/chromium/src/testing/gtest/src/gtest.cc:4024  #29 0x004fd752 in testing::UnitTest::Run (this=0x1583860) at /Users/gavinp/chrome-  work/home/chrome-svn/tarball/chromium/src/testing/gtest/src/gtest.cc:3687  #30 0x000aa984 in TestSuite::Run (this=0xbffff3e0) at test/test_suite.h:125  #31 0x000a996b in main (argc=2  argv=0xbffff478) at /Users/gavinp/chrome-  work/home/chrome-svn/tarball/chromium/src/net/base/run_all_unittests.cc:38       </pre>