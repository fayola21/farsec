<title>Issue 25070 -   chromium -    gentoo hardened doesnt build due to asm which needs PIC - Project Hosting on Google Code</title> <pre> To reproduce  1. add -fPIC to gcc build options in common.gypi  build 64 bit version as usual.    status - problem not reproduced  but solution verified.  Performance drops   from 306ms to 330ms on scale with code supplied below    report by zakalwe (sc.contact@gmail.com)    Hi there  I ran into trouble building chromium because the asm in  media/base/yuv_row_linux.cc is not PIC friendly.  On gentoo hardened and  some other systems most object code is built PIC  and on amd64 you can't  mix and match non pic and pic code.  Also  when you do this for i386 you  end up with TEXTRELs that are bad for some security features like PaX  mprotect.  The problem is directly referring to the kCoefficientsRgb  variables in the assembly.    I think the correct approach is to properly format the asm for gcc and  to set up the constraints on the registers and data properly.  I've done  this for the x86_64 functions below  but am not 100% sure it is correct  and gives the right output.  You should verify with objdump that the  code gcc creates is correct.    #if defined(ARCH_CPU_X86_64)    void FastConvertYUVToRGB32Row(const uint8* y_buf   // rdi                               const uint8* u_buf   // rsi                               const uint8* v_buf   // rdx                               uint8* rgb_buf       // rcx                               int width)           // <a href="/p/chromium/source/detail?r=8">r8</a>  {   asm(   &quot;jmp    convertendn&quot;  &quot;convertloop:&quot;   &quot;movzb  (%1) %%<a href="/p/chromium/source/detail?r=10">r10</a>n&quot;   &quot;add    $0x1 %1n&quot;   &quot;movzb  (%2) %%<a href="/p/chromium/source/detail?r=11">r11</a>n&quot;   &quot;add    $0x1 %2n&quot;   &quot;movq   (%5 %%<a href="/p/chromium/source/detail?r=10">r10</a> 8) %%xmm0n&quot;   &quot;movzb  (%0) %%<a href="/p/chromium/source/detail?r=10">r10</a>n&quot;   &quot;movq   (%6 %%<a href="/p/chromium/source/detail?r=11">r11</a> 8) %%xmm1n&quot;   &quot;movzb  0x1(%0) %%<a href="/p/chromium/source/detail?r=11">r11</a>n&quot;   &quot;paddsw %%xmm1 %%xmm0n&quot;   &quot;movq   (%7 %%<a href="/p/chromium/source/detail?r=10">r10</a> 8) %%xmm2n&quot;   &quot;add    $0x2 %0n&quot;   &quot;movq   (%7 %%<a href="/p/chromium/source/detail?r=11">r11</a> 8) %%xmm3n&quot;   &quot;paddsw %%xmm0 %%xmm2n&quot;   &quot;paddsw %%xmm0 %%xmm3n&quot;   &quot;shufps $0x44 %%xmm3 %%xmm2n&quot;   &quot;psraw  $0x6 %%xmm2n&quot;   &quot;packuswb %%xmm2 %%xmm2n&quot;   &quot;movq   %%xmm2 0x0(%3)n&quot;   &quot;add    $0x8 %3n&quot;  &quot;convertend:&quot;   &quot;sub    $0x2 %4n&quot;   &quot;jns    convertloopn&quot;    &quot;convertnext:&quot;   &quot;add    $0x1 %4n&quot;   &quot;js     convertdonen&quot;     &quot;movzb  (%1) %%<a href="/p/chromium/source/detail?r=10">r10</a>n&quot;   &quot;movq   (%5 %%<a href="/p/chromium/source/detail?r=10">r10</a> 8) %%xmm0n&quot;   &quot;movzb  (%2) %%<a href="/p/chromium/source/detail?r=10">r10</a>n&quot;   &quot;movq   (%6 %%<a href="/p/chromium/source/detail?r=10">r10</a> 8) %%xmm1n&quot;   &quot;paddsw %%xmm1 %%xmm0n&quot;   &quot;movzb  (%0) %%<a href="/p/chromium/source/detail?r=10">r10</a>n&quot;   &quot;movq   (%7 %%<a href="/p/chromium/source/detail?r=10">r10</a> 8) %%xmm1n&quot;   &quot;paddsw %%xmm0 %%xmm1n&quot;   &quot;psraw  $0x6 %%xmm1n&quot;   &quot;packuswb %%xmm1 %%xmm1n&quot;   &quot;movd   %%xmm1 0x0(%3)n&quot;  &quot;convertdone:&quot;   :   : &quot;r&quot;(y_buf)  &quot;r&quot;(u_buf)  &quot;r&quot;(v_buf)  &quot;r&quot;(rgb_buf)  &quot;r&quot;(width)  &quot;r&quot;  (kCoefficientsRgbU)  &quot;r&quot; (kCoefficientsRgbV)   &quot;r&quot; (kCoefficientsRgbY)   : &quot;memory&quot;  &quot;<a href="/p/chromium/source/detail?r=10">r10</a>&quot;  &quot;<a href="/p/chromium/source/detail?r=11">r11</a>&quot;  );  }    //void ScaleYUVToRGB32Row(const uint8* y_buf   // rdi                         const uint8* u_buf   // rsi                         const uint8* v_buf   // rdx                         uint8* rgb_buf       // rcx                         int width            // <a href="/p/chromium/source/detail?r=8">r8</a>                         int scaled_dx)       // <a href="/p/chromium/source/detail?r=9">r9</a>  {   asm(   &quot;xor    %%<a href="/p/chromium/source/detail?r=11">r11</a> %%<a href="/p/chromium/source/detail?r=11">r11</a>n&quot;   &quot;sub    $0x2 %4n&quot;   &quot;js     scalenextn&quot;    &quot;scaleloop:&quot;   &quot;mov    %%<a href="/p/chromium/source/detail?r=11">r11</a> %%<a href="/p/chromium/source/detail?r=10">r10</a>n&quot;   &quot;sar    $0x5 %%<a href="/p/chromium/source/detail?r=10">r10</a>n&quot;   &quot;movzb  (%1 %%<a href="/p/chromium/source/detail?r=10">r10</a> 1) %%raxn&quot;   &quot;movq   (%6 %%rax 8) %%xmm0n&quot;   &quot;movzb  (%2 %%<a href="/p/chromium/source/detail?r=10">r10</a> 1) %%raxn&quot;   &quot;movq   (%7 %%rax 8) %%xmm1n&quot;   &quot;lea    (%%<a href="/p/chromium/source/detail?r=11">r11</a> %5) %%<a href="/p/chromium/source/detail?r=10">r10</a>n&quot;   &quot;sar    $0x4 %%<a href="/p/chromium/source/detail?r=11">r11</a>n&quot;   &quot;movzb  (%0 %%<a href="/p/chromium/source/detail?r=11">r11</a> 1) %%raxn&quot;   &quot;paddsw %%xmm1 %%xmm0n&quot;   &quot;movq   (%8 %%rax 8) %%xmm1n&quot;   &quot;lea    (%%<a href="/p/chromium/source/detail?r=10">r10</a> %5) %%<a href="/p/chromium/source/detail?r=11">r11</a>n&quot;   &quot;sar    $0x4 %%<a href="/p/chromium/source/detail?r=10">r10</a>n&quot;   &quot;movzb  (%0 %%<a href="/p/chromium/source/detail?r=10">r10</a> 1) %%raxn&quot;   &quot;movq   (%8 %%rax 8) %%xmm2n&quot;   &quot;paddsw %%xmm0 %%xmm1n&quot;   &quot;paddsw %%xmm0 %%xmm2n&quot;   &quot;shufps $0x44 %%xmm2 %%xmm1n&quot;   &quot;psraw  $0x6 %%xmm1n&quot;   &quot;packuswb %%xmm1 %%xmm1n&quot;   &quot;movq   %%xmm1 0x0(%3)n&quot;   &quot;add    $0x8 %3n&quot;   &quot;sub    $0x2 %4n&quot;   &quot;jns    scaleloopn&quot;    &quot;scalenext:&quot;   &quot;add    $0x1 %4n&quot;   &quot;js     scaledonen&quot;     &quot;mov    %%<a href="/p/chromium/source/detail?r=11">r11</a> %%<a href="/p/chromium/source/detail?r=10">r10</a>n&quot;   &quot;sar    $0x5 %%<a href="/p/chromium/source/detail?r=10">r10</a>n&quot;   &quot;movzb  (%1 %%<a href="/p/chromium/source/detail?r=10">r10</a> 1) %%raxn&quot;   &quot;movq   (%6 %%rax 8) %%xmm0n&quot;   &quot;movzb  (%2 %%<a href="/p/chromium/source/detail?r=10">r10</a> 1) %%raxn&quot;   &quot;movq   (%7 %%rax 8) %%xmm1n&quot;   &quot;paddsw %%xmm1 %%xmm0n&quot;   &quot;sar    $0x4 %%<a href="/p/chromium/source/detail?r=11">r11</a>n&quot;   &quot;movzb  (%0 %%<a href="/p/chromium/source/detail?r=11">r11</a> 1) %%raxn&quot;   &quot;movq   (%8 %%rax 8) %%xmm1n&quot;   &quot;paddsw %%xmm0 %%xmm1n&quot;   &quot;psraw  $0x6 %%xmm1n&quot;   &quot;packuswb %%xmm1 %%xmm1n&quot;   &quot;movd   %%xmm1 0x0(%3)n&quot;    &quot;scaledone:&quot;   :   : &quot;r&quot;(y_buf)  &quot;r&quot;(u_buf)  &quot;r&quot;(v_buf)  &quot;r&quot;(rgb_buf)  &quot;r&quot;(width)   &quot;r&quot;((long)scaled_dx)  &quot;r&quot; (kCoefficientsRgbU)  &quot;r&quot; (kCoefficientsRgbV)   &quot;r&quot; (kCoefficientsRgbY)   : &quot;memory&quot;  &quot;<a href="/p/chromium/source/detail?r=10">r10</a>&quot;  &quot;<a href="/p/chromium/source/detail?r=11">r11</a>&quot;  &quot;rax&quot;  );  }  #else   </pre>