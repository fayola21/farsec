<title>Issue 30704 -   chromium -    valgrind reports gfx::PNGCoded using and writing uninitialized bytes with system libz - Project Hosting on Google Code</title> <pre> Somewhere in 7032-7036  Linux valgrind(1) started persistently showing these two png-related failures:    Use of uninitialised value of size 4    crc32 (ild/buildd/zlib-1.2.3.3.dfsg/crc32.c:289)    0x49CDB80 (/usr/lib/libpng12.so.0.15.0)    png_write_chunk_data (/usr/lib/libpng12.so.0.15.0)    png_write_chunk (/usr/lib/libpng12.so.0.15.0)    0x49D7E95 (/usr/lib/libpng12.so.0.15.0)    0x49D8123 (/usr/lib/libpng12.so.0.15.0)    0x49D8233 (/usr/lib/libpng12.so.0.15.0)    0x49D867E (/usr/lib/libpng12.so.0.15.0)    png_write_row (/usr/lib/libpng12.so.0.15.0)    gfx::PNGCodec::Encode(unsigned char const*  gfx::PNGCodec::ColorFormat  int  int  int  bool  std::vector&lt;unsigned char    std::allocator&lt;unsigned char&gt; &gt;*) (uilder/build/src/app/gfx/codec/png_codec.cc:609)    gfx::PNGCodec::EncodeBGRASkBitmap(SkBitmap const&amp;  bool  std::vector&lt;unsigned char  std::allocator&lt;unsigned char&gt; &gt;*)   (uilder/build/src/app/gfx/codec/png_codec.cc:661)    BrowserThemePack::RepackImages(std::map&lt;int  SkBitmap*  std::less&lt;int&gt;  std::allocator&lt;std::pair&lt;int const  SkBitmap*&gt; &gt; &gt;   const&amp;  std::map&lt;int  scoped_refptr&lt;RefCountedMemory&gt;  std::less&lt;int&gt;  std::allocator&lt;std::pair&lt;int const    scoped_refptr&lt;RefCountedMemory&gt; &gt; &gt; &gt;*) const (uilder/build/src/chrome/browser/browser_theme_pack.cc:825)    BrowserThemePack::WriteToDisk(FilePath) const (uilder/build/src/chrome/browser/browser_theme_pack.cc:310)    BrowserThemePackTest_CanBuildAndReadPack_Test::TestBody()   (uilder/build/src/chrome/browser/browser_theme_pack_unittest.cc:354)    testing::Test::Run() (uilder/build/src/testing/gtest/src/gtest.cc:2099)    testing::internal::TestInfoImpl::Run() (uilder/build/src/testing/gtest/src/gtest.cc:2318)    testing::TestCase::Run() (uilder/build/src/testing/gtest/src/gtest.cc:2426)    testing::internal::UnitTestImpl::RunAllTests() (uilder/build/src/testing/gtest/src/gtest.cc:4026)    testing::UnitTest::Run() (uilder/build/src/testing/gtest/src/gtest.cc:3694)    TestSuite::Run() (uilder/build/src/base/test/test_suite.h:124)    main (uilder/build/src/chrome/test/unit/run_all_unittests.cc:8)    Syscall param write(buf) points to uninitialised byte(s)    0x489B91B (/lib/tls/i686/cmov/libpthread-2.7.so)    file_util::WriteFile(FilePath const&amp;  char const*  int) (uilder/build/src/base/file_util_posix.cc:499)    SandboxedExtensionUnpacker::RewriteImageFiles()   (uilder/build/src/chrome/browser/extensions/sandboxed_extension_unpacker.cc:328)    SandboxedExtensionUnpacker::OnUnpackExtensionSucceeded(DictionaryValue const&amp;  DictionaryValue const&amp;)   (uilder/build/src/chrome/browser/extensions/sandboxed_extension_unpacker.cc:126)    SandboxedExtensionUnpacker::Start() (uilder/build/src/chrome/browser/extensions/sandboxed_extension_unpacker.cc:81)    void DispatchToMethod&lt;SandboxedExtensionUnpacker  void (SandboxedExtensionUnpacker::*)()&gt;(SandboxedExtensionUnpacker*    void (SandboxedExtensionUnpacker::*)()  Tuple0 const&amp;) (uilder/build/src/base/tuple.h:412)    RunnableMethod&lt;SandboxedExtensionUnpacker  void (SandboxedExtensionUnpacker::*)()  Tuple0&gt;::Run()   (uilder/build/src/base/task.h:289)    MessageLoop::RunTask(Task*) (uilder/build/src/base/message_loop.cc:320)    MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;) (uilder/build/src/base/message_loop.cc:328)    MessageLoop::DoWork() (uilder/build/src/base/message_loop.cc:435)    base::MessagePumpDefault::Run(base::MessagePump::Delegate*) (uilder/build/src/base/message_pump_default.cc:23)    MessageLoop::RunInternal() (uilder/build/src/base/message_loop.cc:205)    MessageLoop::RunHandler() (uilder/build/src/base/message_loop.cc:177)    MessageLoop::RunAllPending() (uilder/build/src/base/message_loop.cc:161)    ExtensionsServiceTest::InstallExtension(FilePath const&amp;  bool)   (uilder/build/src/chrome/browser/extensions/extensions_service_unittest.cc:339)    ExtensionsServiceTest_InstallTheme_Test::TestBody()   (uilder/build/src/chrome/browser/extensions/extensions_service_unittest.cc:905)    testing::Test::Run() (uilder/build/src/testing/gtest/src/gtest.cc:2099)    testing::internal::TestInfoImpl::Run() (uilder/build/src/testing/gtest/src/gtest.cc:2318)    testing::TestCase::Run() (uilder/build/src/testing/gtest/src/gtest.cc:2426)    testing::internal::UnitTestImpl::RunAllTests() (uilder/build/src/testing/gtest/src/gtest.cc:4026)    testing::UnitTest::Run() (uilder/build/src/testing/gtest/src/gtest.cc:3694)    TestSuite::Run() (uilder/build/src/base/test/test_suite.h:124)    main (uilder/build/src/chrome/test/unit/run_all_unittests.cc:8)  Address 0x594fb70 is 3 096 bytes inside a block of size 6 208 alloc'd    operator new(unsigned int) (ome/chrome-bot/valgrind-10880-redzone/coregrind/m_replacemalloc/vg_replace_malloc.c:220)    __gnu_cxx::new_allocator&lt;unsigned char&gt;::allocate(unsigned int  void const*) (sr/include/c++/4.2/ext/new_allocator.h:91)    std::_Vector_base&lt;unsigned char  std::allocator&lt;unsigned char&gt; &gt;::_M_allocate(unsigned int)   (sr/include/c++/4.2/bits/stl_vector.h:128)    std::vector&lt;unsigned char  std::allocator&lt;unsigned char&gt; &gt;::_M_fill_insert(__gnu_cxx::__normal_iterator&lt;unsigned char*    std::vector&lt;unsigned char  std::allocator&lt;unsigned char&gt; &gt; &gt;  unsigned int  unsigned char const&amp;)   (sr/include/c++/4.2/bits/vector.tcc:354)    std::vector&lt;unsigned char  std::allocator&lt;unsigned char&gt; &gt;::insert(__gnu_cxx::__normal_iterator&lt;unsigned char*    std::vector&lt;unsigned char  std::allocator&lt;unsigned char&gt; &gt; &gt;  unsigned int  unsigned char const&amp;)   (sr/include/c++/4.2/bits/stl_vector.h:653)    std::vector&lt;unsigned char  std::allocator&lt;unsigned char&gt; &gt;::resize(unsigned int  unsigned char)   (sr/include/c++/4.2/bits/stl_vector.h:421)    gfx::(anonymous namespace)::EncoderWriteCallback(png_struct_def*  unsigned char*  unsigned int)   (uilder/build/src/app/gfx/codec/png_codec.cc:489)    0x49DBDD1 (/usr/lib/libpng12.so.0.15.0)    png_write_chunk_end (/usr/lib/libpng12.so.0.15.0)    png_write_chunk (/usr/lib/libpng12.so.0.15.0)    0x49D7E95 (/usr/lib/libpng12.so.0.15.0)    0x49D8123 (/usr/lib/libpng12.so.0.15.0)    0x49D8233 (/usr/lib/libpng12.so.0.15.0)    0x49D867E (/usr/lib/libpng12.so.0.15.0)    png_write_row (/usr/lib/libpng12.so.0.15.0)    gfx::PNGCodec::Encode(unsigned char const*  gfx::PNGCodec::ColorFormat  int  int  int  bool  std::vector&lt;unsigned char    std::allocator&lt;unsigned char&gt; &gt;*) (uilder/build/src/app/gfx/codec/png_codec.cc:609)    gfx::PNGCodec::EncodeBGRASkBitmap(SkBitmap const&amp;  bool  std::vector&lt;unsigned char  std::allocator&lt;unsigned char&gt; &gt;*)   (uilder/build/src/app/gfx/codec/png_codec.cc:661)    SandboxedExtensionUnpacker::RewriteImageFiles()   (uilder/build/src/chrome/browser/extensions/sandboxed_extension_unpacker.cc:320)    SandboxedExtensionUnpacker::OnUnpackExtensionSucceeded(DictionaryValue const&amp;  DictionaryValue const&amp;)   (uilder/build/src/chrome/browser/extensions/sandboxed_extension_unpacker.cc:126)    SandboxedExtensionUnpacker::Start() (uilder/build/src/chrome/browser/extensions/sandboxed_extension_unpacker.cc:81)    void DispatchToMethod&lt;SandboxedExtensionUnpacker  void (SandboxedExtensionUnpacker::*)()&gt;(SandboxedExtensionUnpacker*    void (SandboxedExtensionUnpacker::*)()  Tuple0 const&amp;) (uilder/build/src/base/tuple.h:412)    RunnableMethod&lt;SandboxedExtensionUnpacker  void (SandboxedExtensionUnpacker::*)()  Tuple0&gt;::Run()   (uilder/build/src/base/task.h:289)    MessageLoop::RunTask(Task*) (uilder/build/src/base/message_loop.cc:320)    MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;) (uilder/build/src/base/message_loop.cc:328)    MessageLoop::DoWork() (uilder/build/src/base/message_loop.cc:435)    base::MessagePumpDefault::Run(base::MessagePump::Delegate*) (uilder/build/src/base/message_pump_default.cc:23)    MessageLoop::RunInternal() (uilder/build/src/base/message_loop.cc:205)    MessageLoop::RunHandler() (uilder/build/src/base/message_loop.cc:177)    MessageLoop::RunAllPending() (uilder/build/src/base/message_loop.cc:161)    ExtensionsServiceTest::InstallExtension(FilePath const&amp;  bool)   (uilder/build/src/chrome/browser/extensions/extensions_service_unittest.cc:339)      Possibly related to tcmalloc being turned off? Or maybe valgrind was updated on the bots during   that range? Note that <a title="Writing uninitialized bytes under AddEntryToZip" class=closed_ref href="/p/chromium/issues/detail?id=30703"> bug 30703 </a> showed up at the same time. </pre>