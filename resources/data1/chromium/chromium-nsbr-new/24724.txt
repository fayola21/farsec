<title>Issue 24724 -   chromium -    Data race on reference couter in workers - Project Hosting on Google Code</title> <pre> This data race was found using ThreadSanitizer ( <a href="http://dev.chromium.org/developers/how-tos/using-valgrind/threadsanitizer">http://dev.chromium.org/developers/how-tos/using-valgrind/threadsanitizer</a> ).  Please note that the previous data race found on ref. counter was the cause of a top crasher (see <a href="http://crbug.com/18488">http://crbug.com/18488</a>).    This data race can be proved using RaceChecker class (see  <a href="http://code.google.com/p/data-race-test/wiki/RaceCheckerClass">http://code.google.com/p/data-race-test/wiki/RaceCheckerClass</a> )      1. Apply the attached patch     * adds RaceChecker class files into third_party/WebKit/...      * adds dependencies for these files     * puts RaceChecker calls into JavaScriptCore/wtf/RefCounted.h       under m_racecheck condition (set to &quot;true&quot; if &quot;do_racecheck()&quot; is called)     * adds do_racecheck() call to WebKit::WorkerRunLoop::Task  2. gclient runhooks --force &amp;&amp; hammer -C build ui_tests  3. RACECHECKER=2 RACECHECKER_SLEEP_MS=50 ./sconsbuild/Debug/ui_tests --gtest_filter=&quot;*WorkerTest.SingleWorker*&quot;    The RaceChecker report looks like the following:  Race found between these points  === writer:   chrome(_ZN3WTF14RefCountedBase9derefBaseEv+0x3a)[0xa1d5236]  chrome(_ZN3WTF10RefCountedIN7WebCore13WorkerRunLoop4TaskEE5derefEv+0x11)[0xa9ef4ff]  chrome(_ZN3WTF6RefPtrIN7WebCore13WorkerRunLoop4TaskEED1Ev+0x1f)[0xa9ef541]  chrome(_ZN7WebCore13WorkerRunLoop15postTaskForModeEN3WTF10PassRefPtrINS_22ScriptExecutionContext4TaskEEERKNS_6StringE+0x78)[0xa9edd1c]  chrome(_ZN7WebCore13WorkerRunLoop8postTaskEN3WTF10PassRefPtrINS_22ScriptExecutionContext4TaskEEE+0x3f)[0xa9edd7f]  chrome(_ZN13WebWorkerImpl26postMessageToWorkerContextERKN6WebKit9WebStringERKNS0_9WebVectorIPNS0_21WebMessagePortChannelEEE+0x20e)[0xaaf466a]  chrome(_ZN20WebWorkerClientProxy13OnPostMessageERKSbItN4base20string16_char_traitsESaItEERKSt6vectorIiSaIiEESA_+0xe1)[0x9a5fee9]  chrome(_Z16DispatchToMethodI20WebWorkerClientProxyMS0_FvRKSbItN4base20string16_char_traitsESaItEERKSt6vectorIiSaIiEESB_ES4_S9_S9_EvPT_T0_RK6Tuple3IT1_T2_T3_E+0x56)  [0x9a610b2]  chrome(_ZN3IPC16MessageWithTupleI6Tuple3ISbItN4base20string16_char_traitsESaItEESt6vectorIiSaIiEES8_EE8DispatchI20WebWorkerClientProxyMSC_FvRKS5_RKS8_SG_EEEbPKNS_7  MessageEPT_T0_+0x47)[0x9a6155b]  chrome(_ZN20WebWorkerClientProxy17OnMessageReceivedERKN3IPC7MessageE+0x145)[0x9a602d9]  chrome(_ZN13MessageRouter12RouteMessageERKN3IPC7MessageE+0x4e)[0xabfddba]  chrome(_ZN13MessageRouter17OnMessageReceivedERKN3IPC7MessageE+0x51)[0xabfde17]  chrome(_ZN11ChildThread17OnMessageReceivedERKN3IPC7MessageE+0x190)[0xabee900]  chrome(_ZN3IPC12ChannelProxy7Context17OnDispatchMessageERKNS_7MessageE+0x91)[0xa0a4953]  chrome(_Z16DispatchToMethodIN3IPC12ChannelProxy7ContextEMS2_FvRKNS0_7MessageEES3_EvPT_T0_RK6Tuple1IT1_E+0x41)[0xa0a57ff]  chrome(_ZN14RunnableMethodIN3IPC12ChannelProxy7ContextEMS2_FvRKNS0_7MessageEE6Tuple1IS3_EE3RunEv+0x39)[0xa0a583b]  chrome(_ZN11MessageLoop7RunTaskEP4Task+0xce)[0x9aa29f6]  chrome(_ZN11MessageLoop21DeferOrRunPendingTaskERKNS_11PendingTaskE+0x35)[0x9aa30c1]  === writer:   chrome(_ZN3WTF14RefCountedBase3refEv+0x3a)[0xa1d5144]  chrome(_ZN3WTF10PassRefPtrIN7WebCore13WorkerRunLoop4TaskEEC1IS3_EERKNS_6RefPtrIT_EE+0x31)[0xa9ef401]  chrome(_ZN3WTF5DequeINS_6RefPtrIN7WebCore13WorkerRunLoop4TaskEEEE6findIfIKNS2_13ModePredicateEEENS_13DequeIteratorIS5_EERT_+0x4d)[0xa9ef813]  chrome(_ZN3WTF12MessageQueueINS_6RefPtrIN7WebCore13WorkerRunLoop4TaskEEEE33waitForMessageFilteredWithTimeoutIKNS2_13ModePredicateEEENS_22MessageQueueWaitResultERS5  _RT_d+0x123)[0xa9efbe9]  chrome(_ZN7WebCore13WorkerRunLoop9runInModeEPNS_13WorkerContextERKNS_13ModePredicateE+0x16f)[0xa9edf1b]  chrome(_ZN7WebCore13WorkerRunLoop3runEPNS_13WorkerContextE+0x5c)[0xa9ee05a]  chrome(_ZN7WebCore12WorkerThread12runEventLoopEv+0x28)[0xac96abe]  chrome(_ZN7WebCore21DedicatedWorkerThread12runEventLoopEv+0x4a)[0xac936b2]  chrome(_ZN7WebCore12WorkerThread12workerThreadEv+0x175)[0xac96c35]  chrome(_ZN7WebCore12WorkerThread17workerThreadStartEPv+0x11)[0xac96d07]  chrome[0xaa57c34]  /lib32/libpthread.so.0[0xf76b94fb]  /lib32/libc.so.6(clone+0x5e)[0xf739009e]    Sample ThreadSanitizer report is also attached. </pre>