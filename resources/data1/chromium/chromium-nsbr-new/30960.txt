<title>Issue 30960 -   chromium -    Data race on vfptr in NetworkChangeNotifierMac - Project Hosting on Google Code</title> <pre> ==77808== INFO: T10 has been created by T0 at this point: {{{  ==77808==     #0  0x23774FDE: __bsdthread_create /usr/lib/libSystem.B.dylib  ==77808==     #1  0x23774ED2: pthread_create /usr/lib/libSystem.B.dylib  ==77808==     #2  0x21F0B850: pthread_create /Users/chrome-bot/valgrind-  10880-redzone/tsan/ts_valgrind_intercepts.c:572  ==77808==     #3  0x382CB9: (anonymous namespace)::CreateThread(unsigned   long  bool  PlatformThread::Delegate*  _opaque_pthread_t**)   /b/slave/chromium-dbg-mac-tsan/build/src/base/platform_thread_posix.cc:93  ==77808==     #4  0x382D15: PlatformThread::Create(unsigned long    PlatformThread::Delegate*  _opaque_pthread_t**) /b/slave/chromium-dbg-mac-  tsan/build/src/base/platform_thread_posix.cc:105  ==77808==     #5  0x398505:   base::Thread::StartWithOptions(base::Thread::Options const&amp;)   /b/slave/chromium-dbg-mac-tsan/build/src/base/thread.cc:86  ==77808==     #6  0x511C50:   net::NetworkChangeNotifierMac::NetworkChangeNotifierMac()   /b/slave/chromium-dbg-mac-  tsan/build/src/net/base/network_change_notifier_mac.cc:225  ==77808==     #7  0x511C6C:   net::NetworkChangeNotifierMac::NetworkChangeNotifierMac()   /b/slave/chromium-dbg-mac-  tsan/build/src/net/base/network_change_notifier_mac.cc:226  ==77808==     #8  0x510024:   net::NetworkChangeNotifier::CreateDefaultNetworkChangeNotifier()   /b/slave/chromium-dbg-mac-  tsan/build/src/net/base/network_change_notifier.cc:25  ==77808==     #9  0x2D3E73:   net::HttpNetworkSession::HttpNetworkSession(net::HostResolver*    net::ProxyService*  net::ClientSocketFactory*  net::SSLConfigService*    net::FlipSessionPool*) /b/slave/chromium-dbg-mac-  tsan/build/src/net/http/http_network_session.cc:38  ==77808==     #10 0x2D3FFB:   net::HttpNetworkSession::HttpNetworkSession(net::HostResolver*    net::ProxyService*  net::ClientSocketFactory*  net::SSLConfigService*    net::FlipSessionPool*) /b/slave/chromium-dbg-mac-  tsan/build/src/net/http/http_network_session.cc:41  ==77808==     #11 0x133A0C: net::(anonymous   namespace)::CreateSession(net::(anonymous namespace)::SessionDependencies*)   /b/slave/chromium-dbg-mac-  tsan/build/src/net/flip/flip_stream_unittest.cc:75  ==77808==     #12 0x133A50: net::(anonymous   namespace)::FlipStreamTest::FlipStreamTest() /b/slave/chromium-dbg-mac-  tsan/build/src/net/flip/flip_stream_unittest.cc:82  ==77808==     #13 0x133AA3: net::(anonymous   namespace)::FlipStreamTest_SendRequest_Test::FlipStreamTest_SendRequest_Tes  t() /b/slave/chromium-dbg-mac-  tsan/build/src/net/flip/flip_stream_unittest.cc:101  ==77808==     #14 0x133AC2: net::(anonymous   namespace)::FlipStreamTest_SendRequest_Test::FlipStreamTest_SendRequest_Tes  t() /b/slave/chromium-dbg-mac-  tsan/build/src/net/flip/flip_stream_unittest.cc:101  ==77808==     #15 0x133ADF:   testing::internal::TestFactoryImpl&lt;net::(anonymous   namespace)::FlipStreamTest_SendRequest_Test&gt;::CreateTest() gtest-  internal.h:550  ==77808==     #16 0x3B79D8: testing::internal::TestInfoImpl::Run()   /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2312  ==77808==     #17 0x3B7AE8: testing::TestCase::Run() /b/slave/chromium-dbg-  mac-tsan/build/src/testing/gtest/src/gtest.cc:2426  ==77808==     #18 0x3B8538: testing::internal::UnitTestImpl::RunAllTests()   /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:4026  ==77808==     #19 0x3B8663: testing::UnitTest::Run() /b/slave/chromium-dbg-  mac-tsan/build/src/testing/gtest/src/gtest.cc:3694  ==77808==     #20 0x83461: TestSuite::Run() test/test_suite.h:124  ==77808==     #21 0x827FB: main /b/slave/chromium-dbg-mac-  tsan/build/src/net/base/run_all_unittests.cc:38  ==77808== }}}  ==77808== INFO: T0 is program's main thread  ==77808== WARNING: Possible data race during write of size 4 at 0x278B4C90:   {{{  ==77808==    T0 (locks held: {}):  ==77808==     #0  0x511B2B: net::(anonymous   namespace)::NetworkChangeNotifierThread::~NetworkChangeNotifierThread()   /b/slave/chromium-dbg-mac-  tsan/build/src/net/base/network_change_notifier_mac.cc:204  ==77808==     #1  0x63EA2: scoped_ptr&lt;base::Thread&gt;::~scoped_ptr()   scoped_ptr.h:72  ==77808==     #2  0x63EB4: scoped_ptr&lt;base::Thread&gt;::~scoped_ptr()   scoped_ptr.h:72  ==77808==     #3  0x511035:   net::NetworkChangeNotifierMac::~NetworkChangeNotifierMac()   /b/slave/chromium-dbg-mac-  tsan/build/src/net/base/network_change_notifier_mac.cc:228  ==77808==     #4  0x1A533C:   base::RefCounted&lt;net::NetworkChangeNotifier&gt;::Release() ref_counted.h:93  ==77808==     #5  0x1A535B:   scoped_refptr&lt;net::NetworkChangeNotifier&gt;::~scoped_refptr()   ref_counted.h:238  ==77808==     #6  0x1A536E:   scoped_refptr&lt;net::NetworkChangeNotifier&gt;::~scoped_refptr()   ref_counted.h:238  ==77808==     #7  0x2D3DFD: net::HttpNetworkSession::~HttpNetworkSession()   /b/slave/chromium-dbg-mac-  tsan/build/src/net/http/http_network_session.cc:44  ==77808==     #8  0x2D3E32: net::HttpNetworkSession::~HttpNetworkSession()   /b/slave/chromium-dbg-mac-  tsan/build/src/net/http/http_network_session.cc:44  ==77808==     #9  0x12B301:   base::RefCounted&lt;net::HttpNetworkSession&gt;::Release() ref_counted.h:93  ==77808==     #10 0x12B326:   scoped_refptr&lt;net::HttpNetworkSession&gt;::~scoped_refptr() ref_counted.h:238  ==77808==     #11 0x12B33A:   scoped_refptr&lt;net::HttpNetworkSession&gt;::~scoped_refptr() ref_counted.h:238  ==77808==     #12 0x13383E: net::(anonymous   namespace)::FlipStreamTest::~FlipStreamTest() /b/slave/chromium-dbg-mac-  tsan/build/src/net/flip/flip_stream_unittest.cc:78  ==77808==     #13 0x13387E: net::(anonymous   namespace)::FlipStreamTest_SendRequest_Test::~FlipStreamTest_SendRequest_Te  st() /b/slave/chromium-dbg-mac-  tsan/build/src/net/flip/flip_stream_unittest.cc:101  ==77808==     #14 0x3B7A0A: testing::internal::TestInfoImpl::Run()   /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2323  ==77808==     #15 0x3B7AE8: testing::TestCase::Run() /b/slave/chromium-dbg-  mac-tsan/build/src/testing/gtest/src/gtest.cc:2426  ==77808==     #16 0x3B8538: testing::internal::UnitTestImpl::RunAllTests()   /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:4026  ==77808==     #17 0x3B8663: testing::UnitTest::Run() /b/slave/chromium-dbg-  mac-tsan/build/src/testing/gtest/src/gtest.cc:3694  ==77808==     #18 0x83461: TestSuite::Run() test/test_suite.h:124  ==77808==     #19 0x827FB: main /b/slave/chromium-dbg-mac-  tsan/build/src/net/base/run_all_unittests.cc:38  ==77808==   Concurrent read(s) happened at (OR AFTER) these points:  ==77808==    T10 (NetworkChangeNotifier) (locks held: {}):  ==77808==     #0  0x398398: base::Thread::ThreadMain() /b/slave/chromium-  dbg-mac-tsan/build/src/base/thread.cc:155  ==77808==     #1  0x382C14: ThreadFunc(void*) /b/slave/chromium-dbg-mac-  tsan/build/src/base/platform_thread_posix.cc:26  ==77808==     #2  0x21F0815E: ThreadSanitizerStartThread /Users/chrome-  bot/valgrind-10880-redzone/tsan/ts_valgrind_intercepts.c:525  ==77808==   Location 0x278B4C90 is 0 bytes inside a block starting at   0x278B4C90 of size 40 allocated by T0 from heap:  ==77808==     #0  0x21F0C9E5: malloc /Users/chrome-bot/valgrind-10880-  redzone/tsan/ts_valgrind_intercepts.c:339  ==77808==     #1  0x236CE593: operator new(unsigned long)   /usr/lib/libstdc++.6.0.4.dylib  ==77808==     #2  0x511C04:   net::NetworkChangeNotifierMac::NetworkChangeNotifierMac()   /b/slave/chromium-dbg-mac-  tsan/build/src/net/base/network_change_notifier_mac.cc:222  ==77808==     #3  0x511C6C:   net::NetworkChangeNotifierMac::NetworkChangeNotifierMac()   /b/slave/chromium-dbg-mac-  tsan/build/src/net/base/network_change_notifier_mac.cc:226  ==77808==     #4  0x510024:   net::NetworkChangeNotifier::CreateDefaultNetworkChangeNotifier()   /b/slave/chromium-dbg-mac-  tsan/build/src/net/base/network_change_notifier.cc:25  ==77808==     #5  0x2D3E73:   net::HttpNetworkSession::HttpNetworkSession(net::HostResolver*    net::ProxyService*  net::ClientSocketFactory*  net::SSLConfigService*    net::FlipSessionPool*) /b/slave/chromium-dbg-mac-  tsan/build/src/net/http/http_network_session.cc:38  ==77808==     #6  0x2D3FFB:   net::HttpNetworkSession::HttpNetworkSession(net::HostResolver*    net::ProxyService*  net::ClientSocketFactory*  net::SSLConfigService*    net::FlipSessionPool*) /b/slave/chromium-dbg-mac-  tsan/build/src/net/http/http_network_session.cc:41  ==77808==     #7  0x133A0C: net::(anonymous   namespace)::CreateSession(net::(anonymous namespace)::SessionDependencies*)   /b/slave/chromium-dbg-mac-  tsan/build/src/net/flip/flip_stream_unittest.cc:75  ==77808==     #8  0x133A50: net::(anonymous   namespace)::FlipStreamTest::FlipStreamTest() /b/slave/chromium-dbg-mac-  tsan/build/src/net/flip/flip_stream_unittest.cc:82  ==77808==     #9  0x133AA3: net::(anonymous   namespace)::FlipStreamTest_SendRequest_Test::FlipStreamTest_SendRequest_Tes  t() /b/slave/chromium-dbg-mac-  tsan/build/src/net/flip/flip_stream_unittest.cc:101  ==77808==     #10 0x133AC2: net::(anonymous   namespace)::FlipStreamTest_SendRequest_Test::FlipStreamTest_SendRequest_Tes  t() /b/slave/chromium-dbg-mac-  tsan/build/src/net/flip/flip_stream_unittest.cc:101  ==77808==     #11 0x133ADF:   testing::internal::TestFactoryImpl&lt;net::(anonymous   namespace)::FlipStreamTest_SendRequest_Test&gt;::CreateTest() gtest-  internal.h:550  ==77808==     #12 0x3B79D8: testing::internal::TestInfoImpl::Run()   /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2312  ==77808==     #13 0x3B7AE8: testing::TestCase::Run() /b/slave/chromium-dbg-  mac-tsan/build/src/testing/gtest/src/gtest.cc:2426  ==77808==     #14 0x3B8538: testing::internal::UnitTestImpl::RunAllTests()   /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:4026  ==77808==     #15 0x3B8663: testing::UnitTest::Run() /b/slave/chromium-dbg-  mac-tsan/build/src/testing/gtest/src/gtest.cc:3694  ==77808==     #16 0x83461: TestSuite::Run() test/test_suite.h:124  ==77808==     #17 0x827FB: main /b/slave/chromium-dbg-mac-  tsan/build/src/net/base/run_all_unittests.cc:38  ==77808== }}}    It looks like a symptom of <a title="Data race on vfptr in base::Thread"  href="/p/chromium/issues/detail?id=25385">issue 25385</a>.    Timurrrr: any idea why tsan is complaining about this?  I've already added   a Stop() call in the base::Thread subclass here. </pre>