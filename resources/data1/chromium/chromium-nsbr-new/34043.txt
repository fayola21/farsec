<title>Issue 34043 -   chromium -    Data races in ProfileSyncServiceTestWithData.TestStartupWithOldSyncData (unit_tests) - Project Hosting on Google Code</title> <pre> ThreadSanitizer bot reports various errors in  ProfileSyncServiceTestWithData.TestStartupWithOldSyncData (unit_tests)  see  <a href="http://build.chromium.org/buildbot/memory/builders/Linux%20Tests%20(tsan)/builds/2355/steps/valgrind%20test:%20unit/logs/stdio:">http://build.chromium.org/buildbot/memory/builders/Linux%20Tests%20(tsan)/builds/2355/steps/valgrind%20test:%20unit/logs/stdio:</a>    ==12369== WARNING: Possible data race during write of size 4 at 0xA6A90FC: {{{  ==12369==    T203 (Chrome_SyncCoreThread) (locks held: {}):  ==12369==     #0  std::string::assign(std::string const&amp;)  /usr/lib/libstdc++.so.6.0.9  ==12369==     #1  std::string::operator=(std::string const&amp;)  /usr/lib/libstdc++.so.6.0.9  ==12369==     #2   sync_api::SyncManager::SyncInternal::SetupForTestMode(std::basic_string&lt;wchar_t   std::char_traits&lt;wchar_t&gt;  std::allocator&lt;wchar_t&gt; &gt; const&amp;)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/browser/sync/engine/syncapi.cc:1690  ==12369==     #3   sync_api::SyncManager::SetupForTestMode(std::basic_string&lt;wchar_t   std::char_traits&lt;wchar_t&gt;  std::allocator&lt;wchar_t&gt; &gt; const&amp;)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/browser/sync/engine/syncapi.cc:1685  ==12369==     #4   browser_sync::SyncBackendHost::Core::DoInitializeForTest(std::basic_string&lt;wchar_t   std::char_traits&lt;wchar_t&gt;  std::allocator&lt;wchar_t&gt; &gt; const&amp;   sync_api::HttpPostProviderFactory*  sync_api::HttpPostProviderFactory*   bool)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/browser/sync/glue/sync_backend_host.h:210  ==12369==     #5  void  DispatchToMethod&lt;browser_sync::SyncBackendHost::Core  void  (browser_sync::SyncBackendHost::Core::*)(std::basic_string&lt;wchar_t   std::char_traits&lt;wchar_t&gt;  std::allocator&lt;wchar_t&gt; &gt; const&amp;   sync_api::HttpPostProviderFactory*  sync_api::HttpPostProviderFactory*   bool)  std::basic_string&lt;wchar_t  std::char_traits&lt;wchar_t&gt;   std::allocator&lt;wchar_t&gt; &gt;  sync_api::HttpPostProviderFactory*   sync_api::HttpPostProviderFactory*   bool&gt;(browser_sync::SyncBackendHost::Core*  void  (browser_sync::SyncBackendHost::Core::*)(std::basic_string&lt;wchar_t   std::char_traits&lt;wchar_t&gt;  std::allocator&lt;wchar_t&gt; &gt; const&amp;   sync_api::HttpPostProviderFactory*  sync_api::HttpPostProviderFactory*   bool)  Tuple4&lt;std::basic_string&lt;wchar_t  std::char_traits&lt;wchar_t&gt;   std::allocator&lt;wchar_t&gt; &gt;  sync_api::HttpPostProviderFactory*   sync_api::HttpPostProviderFactory*  bool&gt; const&amp;)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/base/tuple.h:441  ==12369==     #6  RunnableMethod&lt;browser_sync::SyncBackendHost::Core  void  (browser_sync::SyncBackendHost::Core::*)(std::basic_string&lt;wchar_t   std::char_traits&lt;wchar_t&gt;  std::allocator&lt;wchar_t&gt; &gt; const&amp;   sync_api::HttpPostProviderFactory*  sync_api::HttpPostProviderFactory*   bool)  Tuple4&lt;std::basic_string&lt;wchar_t  std::char_traits&lt;wchar_t&gt;   std::allocator&lt;wchar_t&gt; &gt;  sync_api::HttpPostProviderFactory*   sync_api::HttpPostProviderFactory*  bool&gt; &gt;::Run()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/base/task.h:289  ==12369==     #7  MessageLoop::RunTask(Task*)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/base/message_loop.cc:320  ==12369==     #8   MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/base/message_loop.cc:328  ==12369==     #9  MessageLoop::DoWork()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/base/message_loop.cc:435  ==12369==     #10  base::MessagePumpDefault::Run(base::MessagePump::Delegate*)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/base/message_pump_default.cc:23  ==12369==     #11 MessageLoop::RunInternal()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/base/message_loop.cc:205  ==12369==     #12 MessageLoop::RunHandler()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/base/message_loop.cc:177  ==12369==     #13 MessageLoop::Run()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/base/message_loop.cc:155  ==12369==     #14 base::Thread::Run(MessageLoop*)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/base/thread.cc:133  ==12369==     #15 base::Thread::ThreadMain()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/base/thread.cc:155  ==12369==     #16 ThreadFunc(void*)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/base/platform_thread_posix.cc:26  ==12369==     #17 ThreadSanitizerStartThread  /tmp/chromium-valgrind-binaries/scripts/valgrind-source/tsan/ts_valgrind_intercepts.c:525  ==12369==   Concurrent read(s) happened at (OR AFTER) these points:  ==12369==    T0 (locks held: {}):  ==12369==     #0  std::string::data() const /usr/lib/libstdc++.so.6.0.9  ==12369==     #1  UTF8ToUTF16(std::string const&amp;)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/base/utf_string_conversions.cc:139  ==12369==     #2  browser_sync::SyncBackendHost::GetAuthenticatedUsername()  const  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/browser/sync/glue/sync_backend_host.cc:153  ==12369==     #3  ProfileSyncService::GetAuthenticatedUsername() const  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/browser/sync/profile_sync_service.cc:370  ==12369==     #4  SyncSetupFlow::GetArgsForGaiaLogin(ProfileSyncService  const*  DictionaryValue*)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/browser/sync/sync_setup_flow.cc:253  ==12369==     #5  SyncSetupFlow::Run(ProfileSyncService*   SyncSetupFlowContainer*  SyncSetupWizard::State  SyncSetupWizard::State)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/browser/sync/sync_setup_flow.cc:333  ==12369==     #6  SyncSetupWizard::Step(SyncSetupWizard::State)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/browser/sync/sync_setup_wizard.cc:206  ==12369==     #7  ProfileSyncService::OnAuthError()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/browser/sync/profile_sync_service.cc:290  ==12369==     #8   browser_sync::SyncBackendHost::Core::HandleAuthErrorEventOnFrontendLoop(GoogleServiceAuthError  const&amp;)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/browser/sync/glue/sync_backend_host.cc:340  ==12369==     #9  void  DispatchToMethod&lt;browser_sync::SyncBackendHost::Core  void  (browser_sync::SyncBackendHost::Core::*)(GoogleServiceAuthError const&amp;)   GoogleServiceAuthError&gt;(browser_sync::SyncBackendHost::Core*  void  (browser_sync::SyncBackendHost::Core::*)(GoogleServiceAuthError const&amp;)   Tuple1&lt;GoogleServiceAuthError&gt; const&amp;)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/base/tuple.h:422  ==12369==   Location 0xA6A90FC is 4 bytes inside a block starting at  0xA6A90F8 of size 256 allocated by T0 from heap:  ==12369==     #0  malloc  /tmp/chromium-valgrind-binaries/scripts/valgrind-source/tsan/ts_valgrind_intercepts.c:340  ==12369==     #1  operator new(unsigned int) /usr/lib/libstdc++.so.6.0.9  ==12369==     #2  sync_api::SyncManager::SyncManager()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/browser/sync/engine/syncapi.cc:1049  ==12369==     #3   browser_sync::SyncBackendHost::Core::Core(browser_sync::SyncBackendHost*)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/browser/sync/glue/sync_backend_host.cc:178  ==12369==     #4   browser_sync::SyncBackendHost::SyncBackendHost(browser_sync::SyncFrontend*   FilePath const&amp;  std::set&lt;browser_sync::ChangeProcessor*   std::less&lt;browser_sync::ChangeProcessor*&gt;   std::allocator&lt;browser_sync::ChangeProcessor*&gt; &gt;)  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/browser/sync/glue/sync_backend_host.cc:44  ==12369==     #5  ProfileSyncService::StartUp()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/browser/sync/profile_sync_service.cc:159  ==12369==     #6  ProfileSyncService::EnableForUser()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/browser/sync/profile_sync_service.cc:202  ==12369==     #7   ProfileSyncServiceTestWithData_TestStartupWithOldSyncData_Test::TestBody()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/browser/sync/profile_sync_service_unittest.cc:1357  ==12369==     #8  testing::Test::Run()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/testing/gtest/src/gtest.cc:2085  ==12369==     #9  testing::internal::TestInfoImpl::Run()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/testing/gtest/src/gtest.cc:2304  ==12369==     #10 testing::TestCase::Run()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/testing/gtest/src/gtest.cc:2412  ==12369==     #11 testing::internal::UnitTestImpl::RunAllTests()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/testing/gtest/src/gtest.cc:4013  ==12369==     #12 testing::UnitTest::Run()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/testing/gtest/src/gtest.cc:3680  ==12369==     #13 TestSuite::Run()  /b/slave/chromium-rel-linux-valgrind-builder/build/src/base/test/test_suite.h:124  ==12369==     #14 main  /b/slave/chromium-rel-linux-valgrind-builder/build/src/chrome/test/unit/run_all_unittests.cc:8    Another way of reproducing the data race locally is to apply the attached  patch (adds the RaceChecker class instances to the possible race sites) and  execute:    RACECHECKER=2 sconsbuild/Debug/unit_tests  --gtest_filter=ProfileSyncServiceTestWithData.TestStartup*    Note: Google Test filter = ProfileSyncServiceTestWithData.TestStartup*  [==========] Running 1 test from 1 test case.  [----------] Global test environment set-up.  [----------] 1 test from ProfileSyncServiceTestWithData  [ RUN      ] ProfileSyncServiceTestWithData.TestStartupWithOldSyncData  [3204:3204:0201/183926:1475620493999:INFO:/usr/local/google/chrome-commit/src/chrome/browser/bookmarks/bookmark_model.cc(144)]  Loading bookmarks  [3204:3209:0201/183926:1475620510951:INFO:/usr/local/google/chrome-commit/src/chrome/browser/sync/engine/syncapi.cc(196)]  starting the address watch thread  [3204:3212:0201/183926:1475620511599:INFO:/usr/local/google/chrome-commit/src/chrome/browser/sync/engine/syncer_thread.cc(179)]  In thread main loop.  [3204:3207:0201/183926:1475620512401:INFO:/usr/local/google/chrome-commit/src/chrome/browser/sync/engine/syncer_thread.cc(116)]  SyncerThread started.    Race found between these points  === writer:   [3204:3207:0201/183926:1475620514817:INFO:/usr/local/google/chrome-commit/src/chrome/browser/sync/syncable/directory_backing_store.cc(333)]  Old/null sync database  version 0  [3204:3207:0201/183926:1475620515060:INFO:/usr/local/google/chrome-commit/src/chrome/browser/sync/syncable/directory_backing_store.cc(740)]  First run  creating tables  sconsbuild/Debug/unit_tests[0x9376195]  sconsbuild/Debug/unit_tests[0x93764a8]  [3204:3207:0201/183926:1475620517576:INFO:/usr/local/google/chrome-commit/src/chrome/browser/sync/syncable/directory_backing_store.cc(572)]  CreateExtendedAttributeTable  [3204:3207:0201/183926:1475620518125:INFO:/usr/local/google/chrome-commit/src/chrome/browser/sync/syncable/directory_backing_store.cc(354)]  DB created at 1265038766 by version Unknown  sconsbuild/Debug/unit_tests[0x8b236e5]  sconsbuild/Debug/unit_tests[0x8b1e6cf]  sconsbuild/Debug/unit_tests[0x8b1e70f]  sconsbuild/Debug/unit_tests[0x97e7156]  sconsbuild/Debug/unit_tests[0x97e7807]  sconsbuild/Debug/unit_tests[0x97e7a97]  sconsbuild/Debug/unit_tests[0x97ed085]  sconsbuild/Debug/unit_tests[0x97e80ab]  sconsbuild/Debug/unit_tests[0x97e80c5]  sconsbuild/Debug/unit_tests[0x97e8169]  sconsbuild/Debug/unit_tests[0x980fc3d]  sconsbuild/Debug/unit_tests[0x9810036]  sconsbuild/Debug/unit_tests[0x97f78da]  /lib32/libpthread.so.0[0xf76f64fb]  /lib32/libc.so.6(clone+0x5e)[0xf734309e]    === reader:   sconsbuild/Debug/unit_tests[0x905fd31]  sconsbuild/Debug/unit_tests[0x9064d05]  sconsbuild/Debug/unit_tests[0x90690c6]  sconsbuild/Debug/unit_tests[0x9069300]  sconsbuild/Debug/unit_tests[0x906b75a]  sconsbuild/Debug/unit_tests[0x906526f]  sconsbuild/Debug/unit_tests[0x905ef0a]  sconsbuild/Debug/unit_tests[0x90613ff]  sconsbuild/Debug/unit_tests[0x906143b]  sconsbuild/Debug/unit_tests[0x97e7156]  sconsbuild/Debug/unit_tests[0x97e7807]  sconsbuild/Debug/unit_tests[0x97e7a97]  sconsbuild/Debug/unit_tests[0x97ed085]  sconsbuild/Debug/unit_tests[0x97e80ab]  sconsbuild/Debug/unit_tests[0x97e80c5]  sconsbuild/Debug/unit_tests[0x97e8169]  sconsbuild/Debug/unit_tests[0x8b235b5]  sconsbuild/Debug/unit_tests[0x906608e]  unit_tests: /usr/local/google/chrome-commit/src/base/race_checker.cc:48:  Mutex::~Mutex(): Assertion `0 == pthread_mutex_destroy(&amp;mu_)' failed.  Aborted </pre>