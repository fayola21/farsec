<title>Issue 24801 -   chromium -    A possibly benign data race in media/audio/mac/audio_output_mac.cc - Project Hosting on Google Code</title> <pre> ThreadSanitizer bot reports a data race on  PCMQueueOutAudioOutputStream::source_ (see  <a href="http://build.chromium.org/buildbot/waterfall/builders/Chromium%20Mac%20(tsan)/builds/211/steps/valgrind%20test%3A%20media/logs/stdio):">http://build.chromium.org/buildbot/waterfall/builders/Chromium%20Mac%20(tsan)/builds/211/steps/valgrind%20test%3A%20media/logs/stdio):</a>    ==41201== INFO: T9 has been created by T0 at this point: {{{  ==41201==     #0  0x20573FDE: __bsdthread_create /usr/lib/libSystem.B.dylib  ==41201==     #1  0x20573ED2: pthread_create /usr/lib/libSystem.B.dylib  ==41201==     #2  0x1EB7DC62: pthread_create  /b/slave/sub-dbg-mac-tsan/build/src/tools/valgrind/valgrind-10880/tsan/ts_valgrind_intercepts.c:551  ==41201==     #3  0x1EC28ED8: CAPThread::Start()  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #4  0x1EC7E32D: GenericRunLoopThread::Start()  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #5  0x1EC7EED4: AQClient::AQClient(__CFRunLoop*  __CFString  const*)  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #6  0x1EC7A29F: AudioQueueNew(bool   AudioStreamBasicDescription const*  long (*)()  void*  __CFRunLoop*   __CFString const*  unsigned long  OpaqueAudioQueue**)  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #7  0x187570: PCMQueueOutAudioOutputStream::Open(unsigned  long)  /b/slave/chromium-dbg-mac-tsan/build/src/media/audio/mac/audio_output_mac.cc:89  ==41201==     #8  0x54FD:  MacAudioTest_PCMWaveStreamPendingBytes_Test::TestBody()  /b/slave/chromium-dbg-mac-tsan/build/src/media/audio/mac/audio_output_mac_unittest.cc:155  ==41201==     #9  0x211459: testing::Test::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2069  ==41201==     #10 0x213F87: testing::internal::TestInfoImpl::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2288  ==41201==     #11 0x214086: testing::TestCase::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2396  ==41201==     #12 0x214AD6: testing::internal::UnitTestImpl::RunAllTests()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:3995  ==41201==     #13 0x214C01: testing::UnitTest::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:3663  ==41201==     #14 0xD2DC5: TestSuite::Run() test/test_suite.h:128  ==41201==     #15 0xD23DC: main  /b/slave/chromium-dbg-mac-tsan/build/src/media/base/run_all_unittests.cc:8  ==41201== }}}  ==41201== INFO: T0 is program's main thread  ==41201== WARNING: Possible data race during write of size 4 at 0x2452DCF8: {{{  ==41201==    T0 (locks held: {L79  L79  L79  L120  L139  L147}):  ==41201==     #0  0x187464: PCMQueueOutAudioOutputStream::Stop()  /b/slave/chromium-dbg-mac-tsan/build/src/media/audio/mac/audio_output_mac.cc:137  ==41201==     #1  0x5B67:  MacAudioTest_PCMWaveStreamPendingBytes_Test::TestBody()  /b/slave/chromium-dbg-mac-tsan/build/src/media/audio/mac/audio_output_mac_unittest.cc:174  ==41201==     #2  0x211459: testing::Test::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2069  ==41201==     #3  0x213F87: testing::internal::TestInfoImpl::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2288  ==41201==     #4  0x214086: testing::TestCase::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2396  ==41201==     #5  0x214AD6: testing::internal::UnitTestImpl::RunAllTests()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:3995  ==41201==     #6  0x214C01: testing::UnitTest::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:3663  ==41201==     #7  0xD2DC5: TestSuite::Run() test/test_suite.h:128  ==41201==     #8  0xD23DC: main  /b/slave/chromium-dbg-mac-tsan/build/src/media/base/run_all_unittests.cc:8  ==41201==   Concurrent read(s) happened at (OR AFTER) these points:  ==41201==    T9 (locks held: {}):  ==41201==     #0  0x187150:  PCMQueueOutAudioOutputStream::RenderCallback(void*  OpaqueAudioQueue*   AudioQueueBuffer*)  /b/slave/chromium-dbg-mac-tsan/build/src/media/audio/mac/audio_output_mac.cc:195  ==41201==     #1  0x1EC79E93: AQCallbackReceiver_OutputCallback  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #2  0x1ECAA5A0: _XOutputCallback  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #3  0x1EC61EDB: mshMIGPerform  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #4  0x1FBDE6B6: CFRunLoopRunSpecific  /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation  ==41201==     #5  0x1FBDEAA3: CFRunLoopRunInMode  /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation  ==41201==     #6  0x1EC7E3CB: GenericRunLoopThread::RunLoop()  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #7  0x1EC7E556: TRunLoop&lt;AQClient&gt;::Entry(void*)  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #8  0x1EC28FA8: CAPThread::Entry(CAPThread*)  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #9  0x1EB795FE: ThreadSanitizerStartThread  /b/slave/sub-dbg-mac-tsan/build/src/tools/valgrind/valgrind-10880/tsan/ts_valgrind_intercepts.c:504  ==41201==   Location 0x2452DCF8 is 56 bytes inside a block starting at  0x2452DCC0 of size 76 allocated by T0 from heap:  ==41201==     #0  0x1EB7C15F: malloc  /b/slave/sub-dbg-mac-tsan/build/src/tools/valgrind/valgrind-10880/tsan/ts_valgrind_intercepts.c:318  ==41201==     #1  0x204CD593: operator new(unsigned long)  /usr/lib/libstdc++.6.0.4.dylib  ==41201==     #2  0x186C05:  AudioManagerMac::MakeAudioStream(AudioManager::Format  int  int  char)  /b/slave/chromium-dbg-mac-tsan/build/src/media/audio/mac/audio_manager_mac.cc:38  ==41201==     #3  0x545E:  MacAudioTest_PCMWaveStreamPendingBytes_Test::TestBody()  /b/slave/chromium-dbg-mac-tsan/build/src/media/audio/mac/audio_output_mac_unittest.cc:150  ==41201==     #4  0x211459: testing::Test::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2069  ==41201==     #5  0x213F87: testing::internal::TestInfoImpl::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2288  ==41201==     #6  0x214086: testing::TestCase::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2396  ==41201==     #7  0x214AD6: testing::internal::UnitTestImpl::RunAllTests()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:3995  ==41201==     #8  0x214C01: testing::UnitTest::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:3663  ==41201==     #9  0xD2DC5: TestSuite::Run() test/test_suite.h:128  ==41201==     #10 0xD23DC: main  /b/slave/chromium-dbg-mac-tsan/build/src/media/base/run_all_unittests.cc:8  ==41201==   Locks involved in this report (reporting last lock sites):  {L79  L120  L139  L147}  ==41201==    L79  ==41201==     #0  0x1EB7EDE3: pthread_mutex_lock  /b/slave/sub-dbg-mac-tsan/build/src/tools/valgrind/valgrind-10880/tsan/ts_valgrind_intercepts.c:751  ==41201==     #1  0x1ED5740E: CAMutex::Lock()  /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==41201==     #2  0x1ED84316:  HP_IOThread::CalculateNextWakeUpTime(AudioTimeStamp const&amp;   AudioTimeStamp&amp;  bool  bool&amp;)  /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==41201==     #3  0x1ED82ED8: HP_IOThread::WorkLoop()  /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==41201==     #4  0x1ED82C3E: HP_IOThread::ThreadEntry(HP_IOThread*)  /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==41201==     #5  0x1ED7347E: CAPThread::Entry(CAPThread*)  /System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio  ==41201==     #6  0x1EB795FE: ThreadSanitizerStartThread  /b/slave/sub-dbg-mac-tsan/build/src/tools/valgrind/valgrind-10880/tsan/ts_valgrind_intercepts.c:504  ==41201==    L120  ==41201==     #0  0x1EB7EDE3: pthread_mutex_lock  /b/slave/sub-dbg-mac-tsan/build/src/tools/valgrind/valgrind-10880/tsan/ts_valgrind_intercepts.c:751  ==41201==     #1  0x2057544E: _pthread_cond_wait /usr/lib/libSystem.B.dylib  ==41201==     #2  0x20576B2E: pthread_cond_timedwait_relative_np  /usr/lib/libSystem.B.dylib  ==41201==     #3  0x1EC28939: CAGuard::WaitFor(unsigned long long)  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #4  0x1EC86B94:  AQMEDevice::_RemoveRunningClient(AQIONodeClient*  bool)  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #5  0x1EC8CEDB:  AQMEDevice::RemoveRunningClient(AQIONodeClient*)  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #6  0x1ECA7445: AudioQueueObject::Stop(bool)  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #7  0x1EC92C5C: AQServer_Stop  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #8  0x1EC7BC2C: AudioQueueStop  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #9  0x187479: PCMQueueOutAudioOutputStream::Stop()  /b/slave/chromium-dbg-mac-tsan/build/src/media/audio/mac/audio_output_mac.cc:144  ==41201==     #10 0x632A:  MacAudioTest_PCMWaveStreamPlay200HzTone44KssMono_Test::TestBody()  /b/slave/chromium-dbg-mac-tsan/build/src/media/audio/mac/audio_output_mac_unittest.cc:108  ==41201==     #11 0x211459: testing::Test::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2069  ==41201==     #12 0x213F87: testing::internal::TestInfoImpl::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2288  ==41201==     #13 0x214086: testing::TestCase::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2396  ==41201==     #14 0x214AD6: testing::internal::UnitTestImpl::RunAllTests()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:3995  ==41201==     #15 0x214C01: testing::UnitTest::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:3663  ==41201==     #16 0xD2DC5: TestSuite::Run() test/test_suite.h:128  ==41201==     #17 0xD23DC: main  /b/slave/chromium-dbg-mac-tsan/build/src/media/base/run_all_unittests.cc:8  ==41201==    L139  ==41201==     #0  0x1EB7EDE3: pthread_mutex_lock  /b/slave/sub-dbg-mac-tsan/build/src/tools/valgrind/valgrind-10880/tsan/ts_valgrind_intercepts.c:751  ==41201==     #1  0x2057544E: _pthread_cond_wait /usr/lib/libSystem.B.dylib  ==41201==     #2  0x20576B2E: pthread_cond_timedwait_relative_np  /usr/lib/libSystem.B.dylib  ==41201==     #3  0x1EC28939: CAGuard::WaitFor(unsigned long long)  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #4  0x1EC86B94:  AQMEDevice::_RemoveRunningClient(AQIONodeClient*  bool)  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #5  0x1EC8CEDB:  AQMEDevice::RemoveRunningClient(AQIONodeClient*)  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #6  0x1ECA7445: AudioQueueObject::Stop(bool)  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #7  0x1EC92C5C: AQServer_Stop  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #8  0x1EC7BC2C: AudioQueueStop  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #9  0x187479: PCMQueueOutAudioOutputStream::Stop()  /b/slave/chromium-dbg-mac-tsan/build/src/media/audio/mac/audio_output_mac.cc:144  ==41201==     #10 0x5DCD:  MacAudioTest_PCMWaveStreamPlay200HzTone22KssMono_Test::TestBody()  /b/slave/chromium-dbg-mac-tsan/build/src/media/audio/mac/audio_output_mac_unittest.cc:133  ==41201==     #11 0x211459: testing::Test::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2069  ==41201==     #12 0x213F87: testing::internal::TestInfoImpl::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2288  ==41201==     #13 0x214086: testing::TestCase::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2396  ==41201==     #14 0x214AD6: testing::internal::UnitTestImpl::RunAllTests()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:3995  ==41201==     #15 0x214C01: testing::UnitTest::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:3663  ==41201==     #16 0xD2DC5: TestSuite::Run() test/test_suite.h:128  ==41201==     #17 0xD23DC: main  /b/slave/chromium-dbg-mac-tsan/build/src/media/base/run_all_unittests.cc:8  ==41201==    L147  ==41201==     #0  0x1EB7EDE3: pthread_mutex_lock  /b/slave/sub-dbg-mac-tsan/build/src/tools/valgrind/valgrind-10880/tsan/ts_valgrind_intercepts.c:751  ==41201==     #1  0x2057544E: _pthread_cond_wait /usr/lib/libSystem.B.dylib  ==41201==     #2  0x20576B2E: pthread_cond_timedwait_relative_np  /usr/lib/libSystem.B.dylib  ==41201==     #3  0x1EC28939: CAGuard::WaitFor(unsigned long long)  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #4  0x1EC82766: AQMEDevice::StartIO()  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #5  0x1EC87062: AQMEDevice::AddRunningClient(AQIONodeClient*   bool) /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #6  0x1ECA5476: AudioQueueObject::_Start(AQTimeStamp const&amp;)  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #7  0x1ECA8A79: AudioQueueObject::Start(AQTimeStamp const&amp;)  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #8  0x1EC92016: AQServer_Start  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #9  0x1EC7B885: AudioQueueStart  /System/Library/Frameworks/AudioToolbox.framework/Versions/A/AudioToolbox  ==41201==     #10 0x1873EB:  PCMQueueOutAudioOutputStream::Start(AudioOutputStream::AudioSourceCallback*) /b/slave/chromium-dbg-mac-tsan/build/src/media/audio/mac/audio_output_mac.cc:271  ==41201==     #11 0x5B4D:  MacAudioTest_PCMWaveStreamPendingBytes_Test::TestBody()  /b/slave/chromium-dbg-mac-tsan/build/src/media/audio/mac/audio_output_mac_unittest.cc:172  ==41201==     #12 0x211459: testing::Test::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2069  ==41201==     #13 0x213F87: testing::internal::TestInfoImpl::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2288  ==41201==     #14 0x214086: testing::TestCase::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:2396  ==41201==     #15 0x214AD6: testing::internal::UnitTestImpl::RunAllTests()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:3995  ==41201==     #16 0x214C01: testing::UnitTest::Run()  /b/slave/chromium-dbg-mac-tsan/build/src/testing/gtest/src/gtest.cc:3663  ==41201==     #17 0xD2DC5: TestSuite::Run() test/test_suite.h:128  ==41201==     #18 0xD23DC: main  /b/slave/chromium-dbg-mac-tsan/build/src/media/base/run_all_unittests.cc:8  ==41201== }}}    The race is probably a benign one  but some clarification is needed because  of the comments to PCMQueueOutAudioOutputStream::RenderCallback that  explicitly forbid any locks. </pre>