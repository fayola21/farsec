<title>Issue 42877 -   chromium -    Spdy leak in SpdyNetworkTransactionTest - Project Hosting on Google Code</title> <pre> <a href="http://build.chromium.org/buildbot/memory/builders/Chromium%20Mac%20(valgri">http://build.chromium.org/buildbot/memory/builders/Chromium%20Mac%20(valgri</a>  nd)/builds/4500/steps/valgrind%20test:%20net/logs/stdio    Command: src/xcodebuild/Debug/net_unittests --gtest_filter=-  KeygenHandlerTest.*SmokeTest:DiskCacheBackendTest.InvalidEntry:DiskCacheBac  kendTest.InvalidEntryRead:DiskCacheBackendTest.InvalidEntryWithLoad:DiskCac  heBackendTest.TrimInvalidEntry:DiskCacheBackendTest.TrimInvalidEntry2:DiskC  acheBackendTest.InvalidEntryEnumeration:DiskCacheBackendTest.NewEvictionInv  alidEntry:DiskCacheBackendTest.NewEvictionInvalidEntryRead:DiskCacheBackend  Test.NewEvictionInvalidEntryWithLoad:DiskCacheBackendTest.NewEvictionTrimIn  validEntry:DiskCacheBackendTest.NewEvictionTrimInvalidEntry2:DiskCacheBacke  ndTest.NewEvictionInvalidEntryEnumeration:KeygenHandlerTest.FLAKY_SmokeTest   --gtest_print_time  Invalid read of size 4    net::IOBuffer::data() (io_buffer.h:23)    net::MockTCPClientSocket::CompleteRead() (socket_test_util.cc:198)    net::MockTCPClientSocket::OnReadComplete(net::MockRead const&amp;)   (socket_test_util.cc:176)    net::DelayedSocketData::CompleteRead() (socket_test_util.cc:437)    void DispatchToMethod&lt;net::DelayedSocketData  void   (net::DelayedSocketData::*)()&gt;(net::DelayedSocketData*  void   (net::DelayedSocketData::*)()  Tuple0 const&amp;) (tuple.h:412)    ScopedRunnableMethodFactory&lt;net::DelayedSocketData&gt;::RunnableMethod&lt;void   (net::DelayedSocketData::*)()  Tuple0&gt;::Run() (task.h:153)    MessageLoop::RunTask(Task*) (message_loop.cc:328)    MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;)   (message_loop.cc:336)    MessageLoop::DoDelayedWork(base::Time*) (message_loop.cc:470)    base::MessagePumpLibevent::Run(base::MessagePump::Delegate*)   (message_pump_libevent.cc:245)    MessageLoop::RunInternal() (message_loop.cc:204)    MessageLoop::RunHandler() (message_loop.cc:176)    MessageLoop::Run() (message_loop.cc:154)    TestCompletionCallback::WaitForResult() (test_completion_callback.h:36)      net::SpdyNetworkTransactionTest::TransactionHelperWithSession(net::HttpRequ  estInfo const&amp;  net::DelayedSocketData*  net::BoundNetLog const&amp;    net::(anonymous namespace)::SessionDependencies*  net::HttpNetworkSession*)   (/b/slave/chromium-dbg-mac-  valgrind/build/src/net/spdy/spdy_network_transaction_unittest.cc:677)    net::SpdyNetworkTransactionTest::TransactionHelper(net::HttpRequestInfo   const&amp;  net::DelayedSocketData*  net::BoundNetLog const&amp;)   (/b/slave/chromium-dbg-mac-  valgrind/build/src/net/spdy/spdy_network_transaction_unittest.cc:650)    net::SpdyNetworkTransactionTest_WriteError_Test::TestBody()   (/b/slave/chromium-dbg-mac-  valgrind/build/src/net/spdy/spdy_network_transaction_unittest.cc:1636)    testing::Test::Run() (gtest.cc:2095)    testing::internal::TestInfoImpl::Run() (gtest.cc:2314)    testing::TestCase::Run() (gtest.cc:2420)    testing::internal::UnitTestImpl::RunAllTests() (gtest.cc:4024)    testing::UnitTest::Run() (gtest.cc:3687)    TestSuite::Run() (test/test_suite.h:125)    main (/b/slave/chromium-dbg-mac-  valgrind/build/src/net/base/run_all_unittests.cc:38)  Address 0x8c2fe6c is 12 bytes inside a block of size 16 free'd    operator delete(void*) (mp/vg-bins/scripts/valgrind-  memcheck/coregrind/m_replacemalloc/vg_replace_malloc.c:416)    net::IOBuffer::~IOBuffer() (io_buffer.h:34)    base::RefCountedThreadSafe&lt;net::IOBuffer    base::DefaultRefCountedThreadSafeTraits&lt;net::IOBuffer&gt;   &gt;::DeleteInternal(net::IOBuffer*) (ref_counted.h:146)      base::DefaultRefCountedThreadSafeTraits&lt;net::IOBuffer&gt;::Destruct(net::IOBuf  fer*) (ref_counted.h:112)    base::RefCountedThreadSafe&lt;net::IOBuffer    base::DefaultRefCountedThreadSafeTraits&lt;net::IOBuffer&gt; &gt;::Release()   (ref_counted.h:140)    scoped_refptr&lt;net::IOBuffer&gt;::~scoped_refptr() (ref_counted.h:238)    scoped_refptr&lt;net::IOBuffer&gt;::~scoped_refptr() (ref_counted.h:238)    net::SpdySession::~SpdySession() (spdy_session.cc:246)    base::RefCounted&lt;net::SpdySession&gt;::Release() (ref_counted.h:93)    scoped_refptr&lt;net::SpdySession&gt;::~scoped_refptr() (ref_counted.h:238)    scoped_refptr&lt;net::SpdySession&gt;::~scoped_refptr() (ref_counted.h:238)    net::SpdyStream::~SpdyStream() (spdy_stream.cc:50)    net::SpdyStream::~SpdyStream() (spdy_stream.cc:50)    base::RefCounted&lt;net::SpdyStream&gt;::Release() (ref_counted.h:93)    scoped_refptr&lt;net::SpdyStream&gt;::~scoped_refptr() (ref_counted.h:238)    scoped_refptr&lt;net::SpdyStream&gt;::~scoped_refptr() (ref_counted.h:238)    net::SpdySession::OnWriteComplete(int) (spdy_session.cc:612)    void DispatchToMethod&lt;net::SpdySession  void (net::SpdySession::*)(int)    int&gt;(net::SpdySession*  void (net::SpdySession::*)(int)  Tuple1&lt;int&gt;   const&amp;) (tuple.h:422)    CallbackImpl&lt;net::SpdySession  void (net::SpdySession::*)(int)    Tuple1&lt;int&gt; &gt;::RunWithParams(Tuple1&lt;int&gt; const&amp;) (callback.h:118)    void CallbackRunner&lt;Tuple1&lt;int&gt; &gt;::Run&lt;int&gt;(int const&amp;) (callback.h:83)    net::MockClientSocket::RunCallback(CallbackRunner&lt;Tuple1&lt;int&gt; &gt;*  int)   (socket_test_util.cc:69)    void DispatchToMethod&lt;net::MockClientSocket  void   (net::MockClientSocket::*)(CallbackRunner&lt;Tuple1&lt;int&gt; &gt;*  int)    CallbackRunner&lt;Tuple1&lt;int&gt; &gt;*  int&gt;(net::MockClientSocket*  void   (net::MockClientSocket::*)(CallbackRunner&lt;Tuple1&lt;int&gt; &gt;*  int)    Tuple2&lt;CallbackRunner&lt;Tuple1&lt;int&gt; &gt;*  int&gt; const&amp;) (tuple.h:429)    ScopedRunnableMethodFactory&lt;net::MockClientSocket&gt;::RunnableMethod&lt;void   (net::MockClientSocket::*)(CallbackRunner&lt;Tuple1&lt;int&gt; &gt;*  int)    Tuple2&lt;CallbackRunner&lt;Tuple1&lt;int&gt; &gt;*  int&gt; &gt;::Run() (task.h:153)    MessageLoop::RunTask(Task*) (message_loop.cc:328)    MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;)   (message_loop.cc:336)    MessageLoop::DoWork() (message_loop.cc:443)    base::MessagePumpLibevent::Run(base::MessagePump::Delegate*)   (message_pump_libevent.cc:241)    MessageLoop::RunInternal() (message_loop.cc:204)    MessageLoop::RunHandler() (message_loop.cc:176)    MessageLoop::Run() (message_loop.cc:154)  Suppression:  {     &lt;insert_a_suppression_name_here&gt;     Memcheck:Addr4     fun:_ZN3net8IOBuffer4dataEv     fun:_ZN3net19MockTCPClientSocket12CompleteReadEv     fun:_ZN3net19MockTCPClientSocket14OnReadCompleteERKNS_8MockReadE     fun:_ZN3net17DelayedSocketData12CompleteReadEv       fun:_Z16DispatchToMethodIN3net17DelayedSocketDataEMS1_FvvEEvPT_T0_RK6Tuple0       fun:_ZN27ScopedRunnableMethodFactoryIN3net17DelayedSocketDataEE14RunnableMe  thodIMS1_FvvE6Tuple0E3RunEv     fun:_ZN11MessageLoop7RunTaskEP4Task     fun:_ZN11MessageLoop21DeferOrRunPendingTaskERKNS_11PendingTaskE     fun:_ZN11MessageLoop13DoDelayedWorkEPN4base4TimeE     fun:_ZN4base19MessagePumpLibevent3RunEPNS_11MessagePump8DelegateE     fun:_ZN11MessageLoop11RunInternalEv     fun:_ZN11MessageLoop10RunHandlerEv  }    14:01:18 memcheck_analyze.py [ERROR] InvalidWrite  Command: src/xcodebuild/Debug/net_unittests --gtest_filter=-  KeygenHandlerTest.*SmokeTest:DiskCacheBackendTest.InvalidEntry:DiskCacheBac  kendTest.InvalidEntryRead:DiskCacheBackendTest.InvalidEntryWithLoad:DiskCac  heBackendTest.TrimInvalidEntry:DiskCacheBackendTest.TrimInvalidEntry2:DiskC  acheBackendTest.InvalidEntryEnumeration:DiskCacheBackendTest.NewEvictionInv  alidEntry:DiskCacheBackendTest.NewEvictionInvalidEntryRead:DiskCacheBackend  Test.NewEvictionInvalidEntryWithLoad:DiskCacheBackendTest.NewEvictionTrimIn  validEntry:DiskCacheBackendTest.NewEvictionTrimInvalidEntry2:DiskCacheBacke  ndTest.NewEvictionInvalidEntryEnumeration:KeygenHandlerTest.FLAKY_SmokeTest   --gtest_print_time  Invalid write of size 1    memcpy (mp/vg-bins/scripts/valgrind-  memcheck/memcheck/mc_replace_strmem.c:497)    net::MockTCPClientSocket::CompleteRead() (socket_test_util.cc:198)    net::MockTCPClientSocket::OnReadComplete(net::MockRead const&amp;)   (socket_test_util.cc:176)    net::DelayedSocketData::CompleteRead() (socket_test_util.cc:437)    void DispatchToMethod&lt;net::DelayedSocketData  void   (net::DelayedSocketData::*)()&gt;(net::DelayedSocketData*  void   (net::DelayedSocketData::*)()  Tuple0 const&amp;) (tuple.h:412)    ScopedRunnableMethodFactory&lt;net::DelayedSocketData&gt;::RunnableMethod&lt;void   (net::DelayedSocketData::*)()  Tuple0&gt;::Run() (task.h:153)    MessageLoop::RunTask(Task*) (message_loop.cc:328)    MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;)   (message_loop.cc:336)    MessageLoop::DoDelayedWork(base::Time*) (message_loop.cc:470)    base::MessagePumpLibevent::Run(base::MessagePump::Delegate*)   (message_pump_libevent.cc:245)    MessageLoop::RunInternal() (message_loop.cc:204)    MessageLoop::RunHandler() (message_loop.cc:176)    MessageLoop::Run() (message_loop.cc:154)    TestCompletionCallback::WaitForResult() (test_completion_callback.h:36)      net::SpdyNetworkTransactionTest::TransactionHelperWithSession(net::HttpRequ  estInfo const&amp;  net::DelayedSocketData*  net::BoundNetLog const&amp;    net::(anonymous namespace)::SessionDependencies*  net::HttpNetworkSession*)   (/b/slave/chromium-dbg-mac-  valgrind/build/src/net/spdy/spdy_network_transaction_unittest.cc:677)    net::SpdyNetworkTransactionTest::TransactionHelper(net::HttpRequestInfo   const&amp;  net::DelayedSocketData*  net::BoundNetLog const&amp;)   (/b/slave/chromium-dbg-mac-  valgrind/build/src/net/spdy/spdy_network_transaction_unittest.cc:650)    net::SpdyNetworkTransactionTest_WriteError_Test::TestBody()   (/b/slave/chromium-dbg-mac-  valgrind/build/src/net/spdy/spdy_network_transaction_unittest.cc:1636)    testing::Test::Run() (gtest.cc:2095)    testing::internal::TestInfoImpl::Run() (gtest.cc:2314)    testing::TestCase::Run() (gtest.cc:2420)    testing::internal::UnitTestImpl::RunAllTests() (gtest.cc:4024)    testing::UnitTest::Run() (gtest.cc:3687)    TestSuite::Run() (test/test_suite.h:125)    main (/b/slave/chromium-dbg-mac-  valgrind/build/src/net/base/run_all_unittests.cc:38)  Address 0x821623c is 76 bytes inside a block of size 8 192 free'd    operator delete[](void*) (mp/vg-bins/scripts/valgrind-  memcheck/coregrind/m_replacemalloc/vg_replace_malloc.c:441)    net::IOBuffer::~IOBuffer() (io_buffer.h:33)    base::RefCountedThreadSafe&lt;net::IOBuffer    base::DefaultRefCountedThreadSafeTraits&lt;net::IOBuffer&gt;   &gt;::DeleteInternal(net::IOBuffer*) (ref_counted.h:146)      base::DefaultRefCountedThreadSafeTraits&lt;net::IOBuffer&gt;::Destruct(net::IOBuf  fer*) (ref_counted.h:112)    base::RefCountedThreadSafe&lt;net::IOBuffer    base::DefaultRefCountedThreadSafeTraits&lt;net::IOBuffer&gt; &gt;::Release()   (ref_counted.h:140)    scoped_refptr&lt;net::IOBuffer&gt;::~scoped_refptr() (ref_counted.h:238)    scoped_refptr&lt;net::IOBuffer&gt;::~scoped_refptr() (ref_counted.h:238)    net::SpdySession::~SpdySession() (spdy_session.cc:246)    base::RefCounted&lt;net::SpdySession&gt;::Release() (ref_counted.h:93)    scoped_refptr&lt;net::SpdySession&gt;::~scoped_refptr() (ref_counted.h:238)    scoped_refptr&lt;net::SpdySession&gt;::~scoped_refptr() (ref_counted.h:238)    net::SpdyStream::~SpdyStream() (spdy_stream.cc:50)    net::SpdyStream::~SpdyStream() (spdy_stream.cc:50)    base::RefCounted&lt;net::SpdyStream&gt;::Release() (ref_counted.h:93)    scoped_refptr&lt;net::SpdyStream&gt;::~scoped_refptr() (ref_counted.h:238)    scoped_refptr&lt;net::SpdyStream&gt;::~scoped_refptr() (ref_counted.h:238)    net::SpdySession::OnWriteComplete(int) (spdy_session.cc:612)    void DispatchToMethod&lt;net::SpdySession  void (net::SpdySession::*)(int)    int&gt;(net::SpdySession*  void (net::SpdySession::*)(int)  Tuple1&lt;int&gt;   const&amp;) (tuple.h:422)    CallbackImpl&lt;net::SpdySession  void (net::SpdySession::*)(int)    Tuple1&lt;int&gt; &gt;::RunWithParams(Tuple1&lt;int&gt; const&amp;) (callback.h:118)    void CallbackRunner&lt;Tuple1&lt;int&gt; &gt;::Run&lt;int&gt;(int const&amp;) (callback.h:83)    net::MockClientSocket::RunCallback(CallbackRunner&lt;Tuple1&lt;int&gt; &gt;*  int)   (socket_test_util.cc:69)    void DispatchToMethod&lt;net::MockClientSocket  void   (net::MockClientSocket::*)(CallbackRunner&lt;Tuple1&lt;int&gt; &gt;*  int)    CallbackRunner&lt;Tuple1&lt;int&gt; &gt;*  int&gt;(net::MockClientSocket*  void   (net::MockClientSocket::*)(CallbackRunner&lt;Tuple1&lt;int&gt; &gt;*  int)    Tuple2&lt;CallbackRunner&lt;Tuple1&lt;int&gt; &gt;*  int&gt; const&amp;) (tuple.h:429)    ScopedRunnableMethodFactory&lt;net::MockClientSocket&gt;::RunnableMethod&lt;void   (net::MockClientSocket::*)(CallbackRunner&lt;Tuple1&lt;int&gt; &gt;*  int)    Tuple2&lt;CallbackRunner&lt;Tuple1&lt;int&gt; &gt;*  int&gt; &gt;::Run() (task.h:153)    MessageLoop::RunTask(Task*) (message_loop.cc:328)    MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask const&amp;)   (message_loop.cc:336)    MessageLoop::DoWork() (message_loop.cc:443)    base::MessagePumpLibevent::Run(base::MessagePump::Delegate*)   (message_pump_libevent.cc:241)    MessageLoop::RunInternal() (message_loop.cc:204)    MessageLoop::RunHandler() (message_loop.cc:176)    MessageLoop::Run() (message_loop.cc:154)  Suppression:  {     &lt;insert_a_suppression_name_here&gt;     Memcheck:Addr1     fun:memcpy     fun:_ZN3net19MockTCPClientSocket12CompleteReadEv     fun:_ZN3net19MockTCPClientSocket14OnReadCompleteERKNS_8MockReadE     fun:_ZN3net17DelayedSocketData12CompleteReadEv       fun:_Z16DispatchToMethodIN3net17DelayedSocketDataEMS1_FvvEEvPT_T0_RK6Tuple0       fun:_ZN27ScopedRunnableMethodFactoryIN3net17DelayedSocketDataEE14RunnableMe  thodIMS1_FvvE6Tuple0E3RunEv     fun:_ZN11MessageLoop7RunTaskEP4Task     fun:_ZN11MessageLoop21DeferOrRunPendingTaskERKNS_11PendingTaskE     fun:_ZN11MessageLoop13DoDelayedWorkEPN4base4TimeE     fun:_ZN4base19MessagePumpLibevent3RunEPNS_11MessagePump8DelegateE     fun:_ZN11MessageLoop11RunInternalEv     fun:_ZN11MessageLoop10RunHandlerEv  } </pre>