Unit tests for steps 6 (with small refactor)       